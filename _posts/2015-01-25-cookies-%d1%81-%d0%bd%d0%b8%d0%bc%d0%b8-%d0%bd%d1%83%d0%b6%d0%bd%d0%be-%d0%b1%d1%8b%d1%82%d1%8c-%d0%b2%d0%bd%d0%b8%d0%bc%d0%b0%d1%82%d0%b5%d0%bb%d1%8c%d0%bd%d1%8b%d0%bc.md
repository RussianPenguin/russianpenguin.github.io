---
layout: post
title: 'Cookies: с ними нужно быть внимательным'
date: 2015-01-25 16:40:57.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
tags:
- cookies
- javascript
- php
meta:
  _wpcom_is_markdown: '1'
  sharing_disabled: '1'
  _wpas_skip_facebook: '1'
  _wpas_skip_google_plus: '1'
  _wpas_skip_twitter: '1'
  _wpas_skip_linkedin: '1'
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
  _publicize_pending: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _edit_last: '13696577'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2015/01/25/cookies-%d1%81-%d0%bd%d0%b8%d0%bc%d0%b8-%d0%bd%d1%83%d0%b6%d0%bd%d0%be-%d0%b1%d1%8b%d1%82%d1%8c-%d0%b2%d0%bd%d0%b8%d0%bc%d0%b0%d1%82%d0%b5%d0%bb%d1%8c%d0%bd%d1%8b%d0%bc/"
---
[![cookies]({{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_163.png)](/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_163.png)Однажды на проекте случлось странное с функционалом. Выясняя причину наткнулся на очень много кода, который работает с кукисами. Но вот только работает код неправильно.

Вообще чем кукиса характеризуется:

- имя
- значение
- путь
- время истечения
- домен
- секурность

Здесь и далее нас будет интересовать домен, поскольку именно он является причиной множества странный и часто трудноуловимых багов.

Возьмем пример https://github.com/RussianPenguin/blogSamples/blob/master/cookies.php и запустим его на локальном сервере пхп (примем за аксиому то, что у нас домен localhost.localdomain резолвится на локалхост).

[![Пример cookie.php на локальном сервере]({{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_164.png)](/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_164.png)Теперь зайдем в браузер по нашему скрипту

[![Cookies.php в firebug]({{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_165.png)](/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_165.png)Видно, что скрипт выставляет две кукисы для одного и того же домена.

Стандарт предписывает, что кукиса с точкой перед именем домена и без точки доступна в пределах всех поддоменов, а точка оставлена лишь для совместимости с более ранними браузерами.

Казалось бы, мы ставим кукисы на одном и том же домене. Кстати, вот код:

```php
// Конфигурация (домен на котором запускаем)  
$domain = 'localhost.localdomain';  
$cookieName = 'test';

setcookie($cookieName, 'empty host', 3600+time(), '/');  
setcookie($cookieName, 'host: ' . $domain, 3600+time(), '/', $domain);
```

тут я оставил конфигурацию домена руками так как запуск сервера идет на нестандартном порту.

Так вот. Думалось, что браузер должен поставить одну печеньку и в ней должно быть значение, которое передано последним.

Но нет. Если хидер установки кукиса содержит домен, то кукису будет присвоено имя домена с точкой в начале. А если имени домена не указывать, то кукис будет поставлен на текущий домен без точки в начале.

И когда мы попытаемся считать на стороне клиента (или сервера) наш поставленый кукис, то какой из них вернется - это уже немного рандом (хотя нет, все зависит от того, в какой последовательности печеньки ставились).

И то же самое происходит на клиенте: если мы при установки кукиса указываем домен, то браузер поставит кукис на домен с точкой в начале, а если не укажем, то без точки.

Попробуем прописать в тестовом скрипте какое-то значение для печеньки, но не указывать домен. А потом нажмем кнопку "поставить кукис".

[![cookies.php после setCookie]({{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_166.png)](/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_166.png)Что мы видим? А видим мы то, что браузер считал значение для текущего домена (первое) и перезаписал его новым. Которое мы выбрали. А второй кукис до перезагрузки остался нетронутым. Круто. А значит нажмем "прочитать печеньку" и увидим наше новое значение.

Однако если мы так думаем, то ошибаемся.

[![cookies.php getCookie]({{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_167.png)](/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_167.png)Даже FireCookie что-то показывает - это не значит, что значение печенья поменялось.

Огнелись ничего не поставил.

Но как только мы домен укажем при установке

[![cookie.php - правильный результат]({{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_168.png)](/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_168.png)Так сразу все работает как надо - устанавливается значение и при нажатии на кнопку "прочитать" мы его получаем.

Так вот. Это я о том, что в проекте нельзя смешивать подходы установки мучных изделий. Это приводит к тому, что много-много времени можно угробить в поисках ошибки, которой нет.

Учтите, что если вы заходите повторить этот эксперимент, то на доменах верхнего уровня подобное не работает. Т.е. если мы будем использовать localhost, то подобное поведение не воспроизведется.

