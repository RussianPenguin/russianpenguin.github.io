---
layout: post
title: 'OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты.'
date: 2016-01-25 20:57:44.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- HowTo
tags:
- linux
- openvpn
meta:
  _wpcom_is_markdown: '1'
  _oembed_01a124acb72ebfc1cd0b02f454932f23: "<div class=\"embed-it\"><blockquote class=\"wp-embedded-content\"><a
    href=\"http://notessysadmin.com/quickstart-openvpn-server\">Пятитысячное хауту
    по OpenVPN</a></blockquote><script type='text/javascript'><!--//--><![CDATA[//><!--\t\t!function(a,b){\"use
    strict\";function c(){if(!e){e=!0;var a,c,d,f,g=-1!==navigator.appVersion.indexOf(\"MSIE
    10\"),h=!!navigator.userAgent.match(/Trident.*rv:11./),i=b.querySelectorAll(\"iframe.wp-embedded-content\"),j=b.querySelectorAll(\"blockquote.wp-embedded-content\");for(c=0;c<j.length;c++)j[c].style.display=\"none\";for(c=0;c<i.length;c++)if(d=i[c],d.style.display=\"\",!d.getAttribute(\"data-secret\")){if(f=Math.random().toString(36).substr(2,10),d.src+=\"#?secret=\"+f,d.setAttribute(\"data-secret\",f),g||h)a=d.cloneNode(!0),a.removeAttribute(\"security\"),d.parentNode.replaceChild(a,d)}else;}}var
    d=!1,e=!1;if(b.querySelector)if(a.addEventListener)d=!0;if(a.wp=a.wp||{},!a.wp.receiveEmbedMessage)if(a.wp.receiveEmbedMessage=function(c){var
    d=c.data;if(d.secret||d.message||d.value)if(!/[^a-zA-Z0-9]/.test(d.secret)){var
    e,f,g,h,i,j=b.querySelectorAll('iframe[data-secret=\"'+d.secret+'\"]'),k=b.querySelectorAll('blockquote[data-secret=\"'+d.secret+'\"]');for(e=0;e<k.length;e++)k[e].style.display=\"none\";for(e=0;e<j.length;e++)if(f=j[e],c.source===f.contentWindow){if(f.style.display=\"\",\"height\"===d.message){if(g=parseInt(d.value,10),g>1e3)g=1e3;else
    if(200>~~g)g=200;f.height=g}if(\"link\"===d.message)if(h=b.createElement(\"a\"),i=b.createElement(\"a\"),h.href=f.getAttribute(\"src\"),i.href=d.value,i.host===h.host)if(b.activeElement===f)a.top.location.href=d.value}else;}},d)a.addEventListener(\"message\",a.wp.receiveEmbedMessage,!1),b.addEventListener(\"DOMContentLoaded\",c,!1),a.addEventListener(\"load\",c,!1)}(window,document);//--><!]]></script><iframe
    sandbox=\"allow-scripts\" security=\"restricted\" src=\"http://notessysadmin.com/quickstart-openvpn-server/embed\"
    width=\"600\" height=\"338\" title=\"Вставленная запись WordPress\" frameborder=\"0\"
    marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\" class=\"wp-embedded-content\"></iframe></div>"
  _oembed_72aafaf72d88524cf90ebf802f2ad0ff: "{{unknown}}"
  _rest_api_published: '1'
  _oembed_time_01a124acb72ebfc1cd0b02f454932f23: '1453658176'
  _rest_api_client_id: "-1"
  _publicize_job_id: '19113358224'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2016/01/25/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-2/"
---
<p>&nbsp;</p>
<ul>
<li><a href="http://russianpenguin.ru/2016/01/24/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0/">OpenVPN: Настройка на собственном сервере. Часть 0 — подготовка системы.</a></li>
<li>OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты.</li>
<li><a href="http://russianpenguin.ru/2016/01/26/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-3/">OpenVPN: Настройка на собственном сервере. Часть 2 — конфигурация сервера.</a></li>
<li><a href="http://russianpenguin.ru/2016/01/27/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-4/">OpenVPN: Настройка на собственном сервере. Часть 3 — iptables</a></li>
<li><a href="http://russianpenguin.ru/2016/01/28/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-5/">OpenVPN: Настройка на собственном сервере. Часть 4 — конфигурация клиента.</a></li>
</ul>
<p>&nbsp;</p>
<p><a href="http://russianpenguin.ru/2016/01/24/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0/">Первоначальная</a> настройка успешно завершена и нам необходимо позаботится о безопасности. Т.е. о сертификатах, с которыми будут работать клиенты и сервер.</p>
<p>Для этого нужно три компонента:</p>
<ul>
<li>Корневой сертификат (назовем его для простоты CA), которым будут подписываться ключи клиента и сервере. Крайне желательно чтобы он был на отдельной машине.</li>
<li>Сертификат сервера, который будет подписан корневым доверительным сертификатом.</li>
<li>Сертификат для каждого из клиентов, который тай жэ будет подписан CA</li>
</ul>
<h2>Корневой сертификат и сертификат сервера</h2>
<p>Создаем корневой центр собственной сертификации (лучше делать это не на той машине, где запуен openvpn и там должен быть установлен пакет easy-rsa)</p>
<p>[code]$ cp -R /usr/share/easy-rsa/3.0.0/ ~/CA<br />
$ cp /usr/share/doc/easy-rsa/vars.example ~/CA/vars<br />
$ cd ~/CA[/code]</p>
<p>Нужно отредактировать vars и поправить те параметры, которые будут вам интересны. Это имя домена, имя сервера и прочее - все подробно прокомментировано в файле.</p>
<p>Инициализировать PKI (Public Key Infrastructure — Инфраструктура открытых ключей):</p>
<p>[code]$ ./easyrsa init-pki[/code]</p>
<p>Создать корневой сертификат. Common Name сервера вводить на ваше успотрение. (лучше придумать что-то вроде vpn-server). Сложный пароль ключа обязателе. Не менее 128 бит.</p>
<p>[code]$ ./easyrsa build-ca[/code]</p>
<p>Создать ключи Диффи-Хелмана</p>
<p>[code]$ ./easyrsa gen-dh[/code]</p>
<p>Создать запрос на сертификат для сервера OVPN. Обращаю внимание, что сертификат будет незапаролен (параметр nopass), иначе при каждом старте OpenVPN будет запрашивать этот пароль.</p>
<p>[code]$ ./easyrsa gen-req vpn-server nopass[/code]</p>
<p>Создать и подписать сертификат</p>
<p>[code]$ ./easyrsa sign-req server vpn-server[/code]</p>
<p>Скопировать полученные ключи в рабочий каталог openvpn</p>
<p>[code]$ sudo mkdir -p /etc/openvpn/keys<br />
$ sudo mkdir cp ~/CA/pki/ca.crt /etc/openvpn/keys<br />
$ sudo mkdir cp ~/CA/pki/issued/vpn-server.crt /etc/openvpn/keys<br />
$ sudo mkdir cp ~/CA/pki/private/vpn-server.key /etc/openvpn/keys<br />
$ sudo mkdir cp ~/CA/pki/dh.pem /etc/openvpn/keys[/code]</p>
<p>Создать «HMAC firewall» для защиты от DoS аттак и флуда UDP порта.</p>
<p>[code]$ cd /etc/openvpn/keys/<br />
$ sudo openvpn --genkey --secret ta.key[/code]</p>
<h2>Генерация пользовательских ключей</h2>
<p>Создание запроса запароленного ключа для клиента (потребуется вводить при каждом подключении) с именем User</p>
<p>[code]$ cd ~/CA<br />
$ ./easyrsa gen-req User[/code]</p>
<p>User - это имя пользователя для которого вы генерируете ключ.</p>
<p>При такой генерации при каждом подключении будет запрашиваться пароль.</p>
<p>Если вам не требуется такого уровня. Или авторизация будет осуществляться иными методами, то генерируйте ключ без пароля.</p>
<p>[code]$ ./easyrsa gen-req User nopass[/code]</p>
<p>Теперь ключ надо подписать</p>
<p>[code]$ ./easyrsa sign-req client User[/code]</p>
<p>Дефолтно ключ выдается на 10 лет. Можно ограничить время. И ключи придется только перевыпускать по завершению работы.</p>
<p>[code]$./easyrsa sign-req client User -days 90[/code]</p>
<p>Клиенту потребуется следующий набор файлов</p>
<p>[code] ~/CA/pki/issued/User.crt<br />
 ~/CA/pki/private/User.key<br />
 ~/CA/pki/ca.crt<br />
 /etc/openvpn/keys/ta.key[/code]</p>
<h2>Отзывы сертификатов</h2>
<p>Герируем файл отозванных ключей</p>
<p>[code]$ cd ~/CA<br />
$ ./easyrsa gen-crl[/code]</p>
<p>Если вы все же сделали центр сертификации на той же машине, на которой у вас сервер, то можете слинковать файл отозванных ключей. Но лучше скопировать. И эту операцию нужно повторять каждый раз при отзыве ключей.</p>
<p>[code]$ sudo cp ~/CA/pki/crl.pem /etc/openvpn/keys[/code]</p>
<p>В /etc/openvpn/server.conf добавить строку</p>
<p>[code]crl-verify /etc/openvpn/keys/crl.pem[/code]</p>
<p>Отзыв сертификата пользователя User</p>
<p>[code]$ ./easyrsa revoke User[/code]</p>
<p>Каждый раз при отзыве сертификата необходимо обновлять crl.pem, чтобы внести в него изменения</p>
<p>[code]$ ./easyrsa gen-crl[/code]</p>
<p>Примечание: одноименный файл ключа не может быть создан пока не отозван старый. При попытке создать сертификат с уже имеющимся именем выдаст ошибку</p>
<p>[code]failed to update database<br />
Easy-RSA error:<br />
signing failed (openssl output above may have more detail)[/code]</p>
<p>Для исключения возможности mitm атаки, ошибка которого так выглядит в логах клиента как показано ниже служит параметр remote-cert-tls server в конфиге клиента.</p>
<p>[code]WARNING: No server certificate verification method has been enabled. See http://openvpn.net/howto.html#mitm for more info.[/code]</p>
<p>Ссылки:</p>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts">https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts</a></li>
<li><a href="http://notessysadmin.com/quickstart-openvpn-server" target="_blank">http://notessysadmin.com/quickstart-openvpn-server</a></li>
<li><a href="https://wiki.archlinux.org/index.php/OpenVPN">https://wiki.archlinux.org/index.php/OpenVPN</a></li>
</ul>
