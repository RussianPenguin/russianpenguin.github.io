---
layout: post
title: 'Python: Чем плох datetime.replace?'
date: 2019-09-11 22:46:08.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags: []
meta:
  _wpcom_is_markdown: '1'
  timeline_notification: '1568231171'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '35184929861'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2019/09/11/python-%d1%87%d0%b5%d0%bc-%d0%bf%d0%bb%d0%be%d1%85-datetime-replace/"
excerpt: "Поговорим сегодня про даты и часовые пояса. А именно о том, почему не стоит
  использовать datetime.replace совместно с таймзонами из pytz если вы не уверены
  (вообще не стоит).\n\n"
---
<p><img class="alignleft size-thumbnail wp-image-2513" src="{{ site.baseurl }}/assets/images/2019/09/d187d0b0d181d18b.jpeg?w=150" alt="часы" width="150" height="125" />Поговорим сегодня про даты и часовые пояса. А именно о том, почему не стоит использовать datetime.replace совместно с таймзонами из pytz если вы не уверены (вообще не стоит).</p>
<p>Конечно все с оговорками. Иногда так надо. Но все равно не стоит так делать.</p>
<p><!--more--></p>
<p>Вводные:</p>
<p>[code lang=python]<br />
&gt;&gt;&gt; from datetime import datetime<br />
&gt;&gt;&gt; import pytz<br />
&gt;&gt;&gt; dt = datetime.strptime('2019-09-01 12:00:00', '%Y-%m-%d %H:%M:%S')<br />
&gt;&gt;&gt; tzdata = pytz.timezone('Europe/Moscow')<br />
&gt;&gt;&gt; dt_withreplace = dt.replace(tzinfo=tzdata)<br />
&gt;&gt;&gt; dt_withlocalize = tzdata.localize(dt)<br />
[/code]</p>
<p>Переводем обе даты в UTC.</p>
<p>[code lang=python]<br />
&gt;&gt;&gt; dt_withlocalize.astimezone(pytz.utc)<br />
datetime.datetime(2019, 9, 1, 9, 0, tzinfo=&lt;UTC&gt;)<br />
&gt;&gt;&gt; dt_withreplace.astimezone(pytz.utc)<br />
datetime.datetime(2019, 9, 1, 9, 30, tzinfo=&lt;UTC&gt;)<br />
[/code]</p>
<p>Спорим, что вы ожидали вовсе не этого? Откуда взялось отставание в 30 минут при использовании replace?</p>
<p>Рассмотрим содержимое двух дат с таймзонами.</p>
<p>[code lang=python]<br />
&gt;&gt;&gt; dt_withreplace<br />
datetime.datetime(2019, 9, 1, 12, 0, tzinfo=&lt;DstTzInfo 'Europe/Moscow' LMT+2:30:00 STD&gt;)<br />
&gt;&gt;&gt; dt_withlocalize<br />
datetime.datetime(2019, 9, 1, 12, 0, tzinfo=&lt;DstTzInfo 'Europe/Moscow' MSK+3:00:00 STD&gt;)<br />
[/code]</p>
<p>Ок. MSK - это хорошо, но что такое LMT?</p>
<p>LMT (local mean time) - местное среднее время. Если простыми словами, то это время формировалось для некоторого мередиана на основании солнечного времени и солнечных часов.</p>
<p>Если заглянуть в <a href="https://en.wikipedia.org/wiki/Local_mean_time">вики</a>, то можно прочесть, что этот тип учета времени использовался до введения часовых поясов. Так почему современный питон применил его к дате?</p>
<p>Нам потребуется заглянуть внутрь функции localize и replace.</p>
<p>Начнем с replace, проберемся через дебри к <a href="https://github.com/python/cpython/blob/ee536b2020b1f0baad1286dbd4345e13870324af/Lib/datetime.py#L1501-L1516">коду</a>, который выполняет замену.</p>
<p>Ничего подозрительного мы видим, что создается новый объект с новым tzinfo.</p>
<p>Вот только есть одно но. Новый tzinfo - имеет класс <a href="https://github.com/stub42/pytz/blob/62f872054dde69e5c510094093cd6e221d96d5db/src/pytz/tzinfo.py#L156">DstTzInfo</a>.</p>
<p>Он имплементирует методы объекта <a href="https://github.com/python/cpython/blob/ee536b2020b1f0baad1286dbd4345e13870324af/Lib/datetime.py#L1141">datetime.tzinfo</a>. И если мы чуть-чуть прогуляемся по коду, то увидим, что вызывается <a href="https://github.com/python/cpython/blob/ee536b2020b1f0baad1286dbd4345e13870324af/Lib/datetime.py#L1866-L1869">utcoffset</a>.</p>
<p>Посмотрим, что он нам вернет в tzdata.</p>
<p>[code lang=python]&gt;&gt;&gt; tzdata.utcoffset(dt)<br />
datetime.timedelta(seconds=10800)<br />
&gt;&gt;&gt; tzdata.utcoffset(dt_withreplace)<br />
datetime.timedelta(seconds=9000)<br />
&gt;&gt;&gt; tzdata.utcoffset(dt_withlocalize)<br />
Traceback (most recent call last):<br />
  File "", line 1, in<br />
  File "/usr/lib/python3.7/site-packages/pytz/tzinfo.py", line 422, in utcoffset<br />
    dt = self.localize(dt, is_dst)<br />
  File "/usr/lib/python3.7/site-packages/pytz/tzinfo.py", line 318, in localize<br />
    raise ValueError('Not naive datetime (tzinfo is already set)')<br />
ValueError: Not naive datetime (tzinfo is already set)[/code]</p>
<p>Если мы еще чуть больше покопаемся в коде <a href="https://github.com/stub42/pytz/blob/62f872054dde69e5c510094093cd6e221d96d5db/src/pytz/tzinfo.py#L156">pytz.DstTzInfo</a>, то увидим, что он является прокси, который реализует все методы оригинального datetime.tzinfo, но при этом содержит в себе определения таймзон за разные периоды времени.</p>
<p>Когда мы пытаемся использовать его через подстановку в конструктор datetime, то ничего хорошего не будет. Он просто начнет возвращаеть первое определение часового пояса в своем внутреннем списке (_utc_transition_times, _tzinfos, _transition_info). На нашу беду первым в списке стоит LMT.</p>
<p>Чтобы такого казуса не произошло следует использовать метод <a href="https://github.com/stub42/pytz/blob/62f872054dde69e5c510094093cd6e221d96d5db/src/pytz/tzinfo.py#L258-L394">pytz.DstTzInfo.localize</a>. Именно в нем происходит вся магия выбора пояса в зависимости от даты.</p>
