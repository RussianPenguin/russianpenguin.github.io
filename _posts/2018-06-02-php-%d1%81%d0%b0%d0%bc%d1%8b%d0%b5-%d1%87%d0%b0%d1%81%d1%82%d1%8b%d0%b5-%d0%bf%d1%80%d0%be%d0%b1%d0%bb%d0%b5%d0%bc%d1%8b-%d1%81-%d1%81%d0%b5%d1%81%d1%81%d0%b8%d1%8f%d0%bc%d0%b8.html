---
layout: post
title: 'PHP: Самые распространенные проблемы при работе с сессиями'
date: 2018-06-02 13:29:36.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
tags:
- linux
- php
- selinux
meta:
  _wpcom_is_markdown: '1'
  timeline_notification: '1527935379'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '18524292824'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2018/06/02/php-%d1%81%d0%b0%d0%bc%d1%8b%d0%b5-%d1%87%d0%b0%d1%81%d1%82%d1%8b%d0%b5-%d0%bf%d1%80%d0%be%d0%b1%d0%bb%d0%b5%d0%bc%d1%8b-%d1%81-%d1%81%d0%b5%d1%81%d1%81%d0%b8%d1%8f%d0%bc%d0%b8/"
excerpt: Статья рассказывает о самых распространенных проблемах при работе с файловыми
  сессиями в php
---
<p><img class="alignleft size-thumbnail wp-image-2443" src="{{ site.baseurl }}/assets/images/2018/06/phpsessions.png?w=150" alt="phpsessions" width="150" height="150" />С сессиями в php существует множество непонятных проблем. С появлением виртуальных окружений проблем стало больше.</p>
<p>Рассмотрим наиболее часто встречающиеся проблемы сессий на файлах (мы не будем затрагивать сессии в бд и кастомные обработчики).</p>
<h2>session_start(): open(filename, O_RDWR) failed: No such file or directory</h2>
<p>Очевидно, что ошибка возникает, когда не существует пути, по которому пишутся данные. Но при этом вы знаете, что на диске каталог, который был указан как аргумент session_save_path(), существует.</p>
<p>Например.</p>
<p>[code lang="shell"]$ mkdir /tmp/sessions<br />
$ chmod 777 /tmp/sessions[/code]</p>
<p>[code lang="php"]session_save_path('/tmp/sessions');<br />
session_start();[/code]</p>
<p>Вы увидите на экране или в логах ошибку из заголовка (не во всех дистрибутивах).</p>
<p>Можно посмотреть audit.log из selinux, но если там нет ничего подозрительного и каталог действительно есть (а вы его создали выше), то причина такого поведения достаточно неожиданна.</p>
<p>Происходит это потому что вы работаете в centos 7 версии (или redhat\fedora) и выше. Именно в этой версии ввели параметр <a href="https://help.directadmin.com/item.php?id=561">PrivateTmp</a> для сервисов. Что это означает для нас?</p>
<p>Сделайте второй скрипт, который перечисляет содержимое директории /tmp, а так же выводит реальный путь каталога /tmp/sessions.</p>
<p>[code lang="php"]var_dump(glob('/tmp/*'));[/code]</p>
<p>Откройте скрипт в браузере. Вы увидите, что содержимое в браузере кардинально отличается от содержимого реальной папки /tmp. На скриншоте мы видем вывод из консоли и из браузера - результат совершенно разный.</p>
<p><img class=" size-full wp-image-2442 aligncenter" src="{{ site.baseurl }}/assets/images/2018/06/2018-06-02-123203_1625x863.png" alt="2018-06-02-12:32:03_1625x863" width="1625" height="863" /></p>
<p>Как это побороть? Использовать другой каталог для хранения сессий. Или перед стартом приложения проверять и создавать в случае необходимости нужную файловую структуру.</p>
<h2>session_start(): Session data file is not created by your uid</h2>
<p>Не самая распространенная ошибка. Чаще всего возникает в виртуальных окружениях.</p>
<p>Ошибка возникает в <a href="https://github.com/php/php-src/blob/5eb1f92f31cafc48384f9096012f421b37f6d425/ext/session/mod_files.c#L206-L211">случае</a>, когда uid владельца файла сессии не совпадает с uid текущего пользователя под которым запущен интерпретатор.</p>
<p>Как проверить, что это именно наш случай? Нужно создать скрипт, которыый создает файл в каталоге, в котором вы планируете размещать сессии и сверяет uid владельца файла и uid владельца процесса.</p>
<p>[code lang="php"]$file = __DIR__ . DIRECTORY_SEPARATOR . 'file.name';<br />
$fd = fopen($file, 'w');<br />
fwrite($fd, 'test data');<br />
fclose($fd);<br />
if (file_exists($file)) {<br />
    $stat = stat($file);<br />
    var_dump($stat['uid'] == posix_getuid());<br />
}[/code]</p>
<p>Если мы увидим false, то да. Проблема имеет мысто быть. И вам нужно переместить сессии в другое место.</p>
<p>Так же подобное поведение характерно при некоторых способах монтирования nfs.</p>
<h2>session_start(): open(filename, O_RDWR) failed: Permission denied</h2>
<p>Каталог недоступен для записи и достаточно дать права 777. Но тут не все так очевидно и данный трюк действует не всегда. Если вы работаете в дистрибутивах, которые используют selinux, то даже при установке полных прав система можем вам не позволить писать по выбранному пути.</p>
<p>Это происходит потому что контекст процесса отличается от контекста папки. Вы всегда можете посмотреть в /var/log/audit/audit.log чтобы убедиться.</p>
<p>Как обращаться с контекстами можно подробнее посмотреть в <a href="https://wiki.centos.org/HowTos/SELinux">документации</a> и в <a href="https://www.packtpub.com/networking-and-servers/selinux-system-administration">книге</a>.</p>
<h2>Литература</h2>
<ul>
<li><a href="https://wiki.centos.org/HowTos/SELinux">CentOS wiki: SELinux</a></li>
<li><a href="https://www.packtpub.com/networking-and-servers/selinux-system-administration">SELinux System Administration</a></li>
<li><a href="https://github.com/php/php-src/tree/master/ext/session">GitHub: php-src</a></li>
</ul>
