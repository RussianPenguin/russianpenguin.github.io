---
layout: post
title: 'Redis: как скопировать базу без простоя проекта'
date: 2016-02-24 21:04:12.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags:
- redis
meta:
  _wpcom_is_markdown: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '20135774401'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2016/02/24/redis-%d0%ba%d0%b0%d0%ba-%d1%81%d0%ba%d0%be%d0%bf%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d1%82%d1%8c-%d0%b1%d0%b0%d0%b7%d1%83-%d0%b1%d0%b5%d0%b7-%d0%bf%d1%80%d0%be%d1%81%d1%82%d0%be%d1%8f-%d0%bf%d1%80%d0%be/"
---
<p><img class=" size-thumbnail wp-image-1110 alignleft" src="{{ site.baseurl }}/assets/images/2016/02/redis.png?w=150" alt="redis" width="150" height="127" />Ага. У нас проблемы: нам нужно переехать сервер редиса без даунтайма проекта. Но нам надо не только переехать, но еще и данные сохранить.</p>
<p>Чаще всего предлагается решение в виде остановки проекта, копирования базы в новый инстанс, его запуск, переключение проекта и другие танцы.</p>
<p>Существует даже команда <a href="http://redis.io/commands/MIGRATE">migrate</a>, которая гарантирует атомарное копирование ключей и данных.</p>
<p>Но она работает в рамках одной бд (а по дефолту у редиса их целых 16), а так же обладает рядом негативных последствий ввиду своей атомарности. Поэтому подходит она совершенно для других целей.</p>
<p>Сразу на ум приходят репликации :) А данное решение их умеет.</p>
<p>Допустим у нас два сервера (у меня они на портах 6379 и 6479 соответственно). И нам нужно переключить проект с первого на второй сервер. Второй нулевой только что поднятый. А с первым ведется работа.</p>
<p><img class=" size-full wp-image-1131 aligncenter" src="{{ site.baseurl }}/assets/images/2016/02/2016-02-24-202827_805x48.png" alt="2016-02-24-20:28:27_805x48" width="805" height="48" /></p>
<p>Посмотрим, что в каждой из баз покажет команда</p>
<p>[code]keys *[/code]</p>
<p>Основной редис</p>
<p><img class=" size-full wp-image-1137 aligncenter" src="{{ site.baseurl }}/assets/images/2016/02/2016-02-24-202930_482x426.png" alt="2016-02-24-20:29:30_482x426" width="482" height="426" /></p>
<p>Новый редис</p>
<p><img class=" size-full wp-image-1139 aligncenter" src="{{ site.baseurl }}/assets/images/2016/02/2016-02-24-202947_190x32.png" alt="2016-02-24-20:29:47_190x32" width="190" height="32" /></p>
<p>Как видим пока базы не синхронизированы.</p>
<p>Теперь нужно сделать новую базу репликой старой</p>
<p>[code]&gt; slaveof 127.0.0.1 6379<br />
OK<br />
&gt; info<br />
...<br />
role:slave<br />
master_host:127.0.0.1<br />
master_port:6379<br />
master_link_status:up<br />
master_last_io_seconds_ago:1<br />
master_sync_in_progress:0[/code]</p>
<p>Дополнительно может потребоваться авторизоваться на мастере чтобы началась репликация</p>
<p>[code]config set masterauth &lt;password&gt;[/code]</p>
<p>После этого можем опять посмотреть, что в базу скопировалось</p>
<p>[code]keys *[/code]</p>
<p><img class=" size-full wp-image-1165 aligncenter" src="{{ site.baseurl }}/assets/images/2016/02/2016-02-24-210018_441x414.png" alt="2016-02-24-21:00:18_441x414" width="441" height="414" /></p>
<p>Как видим: все данные успешно засинхронизировались (вполне возможно это займет продолжительное время ввиду объема данных).</p>
<p>После того, как репликация завершена нам нужно сделать две вещи:</p>
<ul>
<li>превратить слейва в мастер</li>
<li>настроить приложение на работу с новым мастером</li>
</ul>
<p>[code]slaveof no one[/code]</p>
<p>Эта команда выключает копирование данных с мастера (но не удаляет их) и теперь уже дело за настройкой приложения.</p>
<p>Да. Небольшой даунтайм все же был (секунд 10-15), но это гораздо лучше, чем предлагаемые решения.</p>
<p>Однако, обратите внимание, что если вы активно пишете в редис, то при такой миграции баз часть данных можно и потерять.</p>
<p><a href="http://redis.io/topics/replication">Почитать про репликации</a>.</p>
