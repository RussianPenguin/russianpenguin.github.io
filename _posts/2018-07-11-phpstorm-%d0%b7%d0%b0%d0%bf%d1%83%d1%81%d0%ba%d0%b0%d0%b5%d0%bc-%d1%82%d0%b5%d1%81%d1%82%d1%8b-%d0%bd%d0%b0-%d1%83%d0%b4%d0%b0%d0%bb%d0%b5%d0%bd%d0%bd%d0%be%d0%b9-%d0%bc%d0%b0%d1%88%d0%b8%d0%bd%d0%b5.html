---
layout: post
title: 'PHPStorm: Запускаем тесты на удаленной машине с возможностью отладки'
date: 2018-07-11 21:13:46.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags:
- codeception
- linux
- php
- tdd
meta:
  _wpcom_is_markdown: '1'
  timeline_notification: '1531332830'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '19907214863'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2018/07/11/phpstorm-%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d0%b5%d0%bc-%d1%82%d0%b5%d1%81%d1%82%d1%8b-%d0%bd%d0%b0-%d1%83%d0%b4%d0%b0%d0%bb%d0%b5%d0%bd%d0%bd%d0%be%d0%b9-%d0%bc%d0%b0%d1%88%d0%b8%d0%bd%d0%b5/"
excerpt: Заметка рассказывает о том, как настроить запуск и отладку кода тестов на
  удаленной машине напрямую из IDE.
---
<p><img class="alignleft size-medium wp-image-2462" src="{{ site.baseurl }}/assets/images/2018/07/2018-07-11-211029_373x236.png?w=300" alt="2018-07-11-21:10:29_373x236" width="300" height="190" />Не секрет, что современные среды разработки полны полезного функционала, освоение которого позволяет поднять продуктивность разработки до невероятных высот.</p>
<p>Сегодня мы реализуем возможность запуска тестов на проекте в каком-либо контейнере (докер, вагрант, удаленное железо), просмотре их выполнения и возможности анализа результатов. И все это не переключаясь на отдельную консоль.</p>
<p>Почему это удобно? Я уже неоднократно ссылался на удобство контейнеров поскольку они обеспечивают повторяемость окружения, скорость развертывания рабочего проекта и схожесть окружений у всех разработчиков в команде.</p>
<p>Долгое время неудобством выступало то, что для тестирования и непосредственной отладки требовалось выполнить переключение на консоль тестовой машины.</p>
<p>Дано:</p>
<ul>
<li>окружение под vagrant (один из способов собрать такое окружение описан в соответствующей <a href="http://russianpenguin.ru/2017/05/02/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be-%d1%87%d0%b0%d1%81%d1%82%d1%8c-4/">статье</a>).</li>
</ul>
<p>Надо:</p>
<ul>
<li>запускать и отлаживать тесты не выходя из ide</li>
</ul>
<p><!--more--></p>
<h2>Интеграция тестов</h2>
<p><strong>1 - настраиваем удаленный интерпретатор PHP</strong></p>
<p>[gallery ids="2456,2457" type="rectangular"]</p>
<p>При выборе удаленного интерпретатора автоматически будут подключены настройки маппинга директорий. Если этого не случилось, то придется вручную прописать соответствие путей на удаленной машине каталогам на локальной системе (пункт path mappings).</p>
<p>В этом же разделе можно указать include path если есть такая необходимость (например подключить pear).</p>
<p><strong>2 - Настраиваем конфигурацию тестового фреймворка.</strong></p>
<p>Необходимо выбрать интерпретатор, указать путь до исполняемого файла и выбрать корректный маппинг,</p>
<p>Обратите внимание на то, что все пути указываются как пути на удаленном хосте.</p>
<p><img class=" size-full wp-image-2458 aligncenter" src="{{ site.baseurl }}/assets/images/2018/07/2018-07-11-202422_1184x513.png" alt="2018-07-11-20:24:22_1184x513" width="1184" height="513" /></p>
<p><strong>3 - Задаем run configuration для запуска тестов.</strong></p>
<p><img class=" size-full wp-image-2459 aligncenter" src="{{ site.baseurl }}/assets/images/2018/07/2018-07-11-202238_1120x727.png" alt="2018-07-11-20:22:38_1120x727" width="1120" height="727" /></p>
<p><strong>4 - Запускаем из меню run.</strong></p>
<p>Здесь кроется одно большое но: на момент написания данной заметки интеграция codeception испытывает некоторые сложности при работе с сессиями и кукисами. Подробнее об этом можете почитать в <a href="https://github.com/Codeception/Codeception/issues/4476">описании бага</a> на гитхабе. Там же есть и возможные пути решения.</p>
<h2>Отладка тестов</h2>
<p>Самое интересное во всем этом - возможность отлаживать код непосредственно во время запуска тестов никуда не переключаясь.</p>
<p><strong>5 - Задаем скрипт, который организует коннект к девелоперской машине</strong></p>
<p>Чуть ранее мы уже рассматривали, как выполнять <a href="http://russianpenguin.ru/2018/04/01/php-%d0%be%d1%82%d0%bb%d0%b0%d0%b6%d0%b8%d0%b2%d0%b0%d0%b5%d0%bc-%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d1%8b-%d0%ba%d0%be%d0%bc%d0%b0%d0%bd%d0%b4%d0%bd%d0%be%d0%b9-%d1%81%d1%82%d1%80%d0%be%d0%ba%d0%b8/">отладку</a> скриптов командной строки. Напишем маленький хелпер и разместим его с правами на запуск где-нибудь на тестовом стенде.</p>
<p>[code lang=shell]#!/usr/bin/env sh</p>
<p>IP=`echo $SSH_CLIENT | awk '{print $1}'`<br />
echo #IP<br />
PHP='/usr/bin/env php -d 'xdebug.remote_host=${IP}' -d 'xdebug.remote_autostart=1''<br />
$PHP "$@"[/code]</p>
<p><strong>6 - Добавляем .phpstorm_helpers в маппинг</strong></p>
<p>Пре первом запуске тестов IDE складывает в домашний каталог пользователя специальный набор интеграционных скриптов. Если не добавить его в include path, то мы не сможем выполнить отладку: система будет ругаться на то, что соответствия файлов не найдены.</p>
<p>Для этого мы копируем директорию .phpstorm_helpers в корень проекта (исключаем его в .gitignore) и настраиваем сервер</p>
<p>Заходи в раздел настройки серверов и создаем новый. В котором обязательно включаем path mapping, а затем прописываем соответствия каталогов локального и удаленного. При этом не забываем про .phpstorm_helpers. Иначе не будет работать.</p>
<p><img class=" size-full wp-image-2460 aligncenter" src="{{ site.baseurl }}/assets/images/2018/07/2018-07-11-210449_1180x846.png" alt="2018-07-11-21:04:49_1180x846" width="1180" height="846" /></p>
<p><strong>7 - Меняем удаленный интерпретатор на наш скрипт</strong></p>
<p>В настройках php указываем скрипт, который мы написали ранее как экзешник.</p>
<p><img class=" size-full wp-image-2461 aligncenter" src="{{ site.baseurl }}/assets/images/2018/07/2018-07-11-210750_870x389.png" alt="2018-07-11-21:07:50_870x389" width="870" height="389" /></p>
<p>Теперь у вас есть не только удобный механизм исполнения тестов, но еще и возможность их отладки.</p>
<h2>Литература</h2>
<ul>
<li><a href="https://confluence.jetbrains.com/display/PhpStorm/Working+with+Remote+PHP+Interpreters+in+PhpStorm">Working with Remote PHP Interpreters in PhpStorm</a></li>
</ul>
