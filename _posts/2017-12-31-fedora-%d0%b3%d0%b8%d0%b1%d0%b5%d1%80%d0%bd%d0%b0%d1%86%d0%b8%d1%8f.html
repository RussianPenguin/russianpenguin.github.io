---
layout: post
title: 'Fedora: гибернация'
date: 2017-12-31 18:07:00.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- HowTo
tags:
- администрирование
- fedora
- linux
meta:
  _wpcom_is_markdown: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '13065843193'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2017/12/31/fedora-%d0%b3%d0%b8%d0%b1%d0%b5%d1%80%d0%bd%d0%b0%d1%86%d0%b8%d1%8f/"
excerpt: В статье рассмотрим как заставить работать гибернацию в дистрибутивах Fedora.
  А так же кратко рассмотрим теоретическую составляющую процесса.
---
<p>Вы закрываете крышку ноутбука и он выключается. "Но то не то что я ожидаю!" - воскликните вы. Да. Так и есть. Потому что уже много времени подряд гибернация работает из рук вон плохо. Эдакое бедствие в линупсе.</p>
<p>Сначала рассмотрим теорию, а после - практику сна базе дистрибутива Fedora 26.</p>
<p>Основные режимы энергосбережения, которые чаще всего упоминаются пользователями::</p>
<ul>
<li>ждущий режим - это когда отключается питание внешних устройств, но при этом сохраняется питание памяти, что позволяет относительно быстро восстанавливать рабочее состояние системы  В спецификации аппаратного обеспечения указано пять уровней энергосохранения. И разработчики различных операционных систем часто выбирают различающиеся между собой уровни.</li>
<li>Спящий режим - это особая разновидность выключения компьютера при котором слепок содержимого оперативной памяти сохраняется на диске. При повторной загрузке ОС проверяет, есть ли слепок памяти. И если да, то восстанавливает слепок в оперативную память и начинает с того места, на котором вы остановились ранее.</li>
<li>гибридный спящий режим - это тот же ждущий режим при котором содержимое оперативной памяти сохраняется в энергонезависимой памяти на случай отключения питания (windows-only)</li>
</ul>
<p>И если со ждущим режимом все более-менее понятно и он работает в большинстве современных дистрибутивов, то со спящим режимом не все так гладко. Попытавшись увести систему в спячку и нажав на кнопку питания для пробуждения вы просто заново загрузите систему.</p>
<p><strong>Предупреждение: все описанные ниже манипуляции требуют физической перезагрузки компьютера для того, чтобы ядро восприняло новые параметры.</strong></p>
<p><!--more--></p>
<h2>Требования к разбиению дисков</h2>
<p>Для возможности работы гибернации необходимо чтобы:</p>
<ul>
<li>В вашей системе присутствовал только один файл или раздел подкачки. Комбинировать несколько файлов, разделов или файл  и раздел нельзя - гибернация работать не будет.</li>
<li>Размер раздела (файла подкачки был как минимум равен или превышал размер оперативной памяти (но это не гарантирует успешного срабатывания в случае, когда система активно используется свопом).</li>
</ul>
<h2>Гибернации через раздел подкачки</h2>
<p>Необходимо отредактировать файл /etc/defaults/grub и указать в параметре GRUB_CMDLINE_LINUX опцию resume, которая укажет, на раздел, который является свопом.</p>
<p>[code]GRUB_CMDLINE_LINUX=&quot;rd.lvm.lv=rfremix/root rd.lvm.lv=rfremix/swap rhgb quiet usbcore.autosuspend=-1 resume=UUID=7d55bdde-03ef-4adf-a1c3-9b85e2a7f4be&quot;[/code]</p>
<p>Параметр resume может быть записан в нескольких вариантах:</p>
<h3>Перегенерация конфига grub2 на efi-системах</h3>
<p>[code]sudo grub2-mkconfig -o /boot/efi/EFI/fedora/grub.cfg[/code]</p>
<h3>Ссылка на раздел</h3>
<p>[code]resume=/dev/...[/code[</p>
<p>Указываем раздел, на котором находится подкачка<br />
&lt;h3&gt;UUID раздела&lt;/h3&gt;<br />
[code]resume=UUID=&lt;uuid&gt;[/code]</p>
<p>Получить uuid можно при помощи blkid.</p>
<p>Предварительно чистим кеш блочных устройств.</p>
<p>[code]sudo blkid -g[/code]</p>
<p>И лишь затем получаем идентификатор.</p>
<p>[code]sudo blkid /dev/...[/code]</p>
<p>Узнать имя устройства, которое вам интересно можно при помощи команды lsblk.</p>
<h2>Гибернация через файл подкачки</h2>
<p>Практически ничем не отличается от гибернации через раздел за исключением следующих нюансов</p>
<p>В качестве параметра resume указываем раздел, на котором расположен файл подкачки. А дальше требуется добавить опцию resume_offset, которая содержит смещение файла в файловой системе.</p>
<p>[code]GRUB_CMDLINE_LINUX=&quot;rd.lvm.lv=rfremix/root rd.lvm.lv=rfremix/swap rhgb quiet usbcore.autosuspend=-1 resume=UUID=7d55bdde-03ef-4adf-a1c3-9b85e2a7f4be  resume_offset=123456&quot;[/code]</p>
<h3>Как получить значение параметра resume_offset</h3>
<p>[code]sudo filefrag -v /hibfile[/code]</p>
<p>[code]Filesystem type is: ef53<br />
File size of /hibfile is 2147479552 (524287 blocks of 4096 bytes)<br />
 ext:     logical_offset:        physical_offset: length:   expected: flags:<br />
   0:        0..   32767:    3342336..   3375103:  32768:<br />
   1:    32768..   65535:    3375104..   3407871:  32768:<br />
   2:    65536..   98303:    3407872..   3440639:  32768:<br />
   3:    98304..  131071:    3440640..   3473407:  32768:<br />
   4:   131072..  163839:    3473408..   3506175:  32768:<br />
   5:   163840..  196607:    3506176..   3538943:  32768:<br />
   6:   196608..  229375:    3538944..   3571711:  32768:<br />
   7:   229376..  262143:    3571712..   3604479:  32768:<br />
   8:   262144..  294911:    3604480..   3637247:  32768:<br />
   9:   294912..  327679:    3637248..   3670015:  32768:<br />
  10:   327680..  360447:    3772416..   3805183:  32768:    3670016:<br />
  11:   360448..  393215:    3805184..   3837951:  32768:<br />
  12:   393216..  425983:    3837952..   3870719:  32768:<br />
  13:   425984..  458751:    3870720..   3903487:  32768:<br />
  14:   458752..  491519:    3903488..   3936255:  32768:<br />
  15:   491520..  524286:    3936256..   3969022:  32767:             last,eof<br />
/hibfile: 2 extents found<br />
&lt;span 				data-mce-type=&quot;bookmark&quot; 				id=&quot;mce_SELREST_start&quot; 				data-mce-style=&quot;overflow:hidden;line-height:0&quot; 				style=&quot;overflow:hidden;line-height:0&quot; 			&gt;&lt;/span&gt;[/code]</p>
<p>Первое значение столба physical_offset в первой строке и есть то, что нам надо - смещение файла. Именно его требуется подставить в параметр resume_offset.</p>
<h3>Как создать файл подкачки</h3>
<p>Сгенерировать пустой файл нужного размера заполненный нулями (XX - требуемый размер в байтах).</p>
<p>[code]sudo dd if=/dev/zero of=/swapfile bs=1024 count=XX[/code]</p>
<p>Задать нужные разрешения и подключить сгенерировать стыруктуры файла.</p>
<p>[code]sudo chmod 600 /swapfile &amp;&amp; sudo mkswap /swapfile[/code]</p>
<p>Активируем новый своп.</p>
<p>[code]sudo swapoff -a<br />
sudo swapon /swapfile[/code]</p>
<p>В файле /etc/fstab потребуется деактивировать (закомментировать или удалить) все записи, которые относятся к другим своп-файлам или разделам и добавить строчку, которая будет инициализировать только что созданный.</p>
<p>[code]/swapfile none swap sw 0 0[/code]</p>
<h2>Можно ли использовать отдельный своп для гибернации и отдельный для подкачки?</h2>
<p>Это вполне логичный вопрос. Допустим, что наш своп равен или больше размера оперативной памяти. Что произойдет если мы попытаемся перевести систему в спящий режим когда пустое место в подкачке меньше, нежели занимаемая оперативная память? Ничего. Получим сообщение об ошибке в dmesg.</p>
<p>Конечно же нам захочется для улучшения надежности работы системы сделать отдельную подкачку и файл (раздел) для гибернации, который не будет подключен через swapon.</p>
<p>Увы, при попытке реализации такой схемы мы увидим сообщение об ошибке</p>
<p>[code]PM: Cannot find swap device, try swapon -a[/code]</p>
<p>Эта ошибка наглядно показывает, что код управления питанием пока еще очень сильно переплетен с кодом управления памятью.</p>
<h2>Литература</h2>
<ul>
<li><a href="https://bbs.archlinux.org/viewtopic.php?id=169587">https://bbs.archlinux.org/viewtopic.php?id=169587</a></li>
<li><a href="https://ubuntuforums.org/showthread.php?t=1042946">https://ubuntuforums.org/showthread.php?t=1042946</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Power_management/Suspend_and_hibernate">https://wiki.archlinux.org/index.php/Power_management/Suspend_and_hibernate</a></li>
</ul>
