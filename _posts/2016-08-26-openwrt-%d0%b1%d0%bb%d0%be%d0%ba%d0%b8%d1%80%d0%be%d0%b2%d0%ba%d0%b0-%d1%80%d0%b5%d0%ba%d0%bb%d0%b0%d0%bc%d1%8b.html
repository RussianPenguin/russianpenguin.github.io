---
layout: post
title: 'OpenWRT: блокировка рекламы'
date: 2016-08-26 00:14:12.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- HowTo
tags:
- linux
meta:
  _wpcom_is_markdown: '1'
  _oembed_b086958113836c4c534ce43d44538156: "{{unknown}}"
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '26150305742'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2016/08/26/openwrt-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%ba%d0%b0-%d1%80%d0%b5%d0%ba%d0%bb%d0%b0%d0%bc%d1%8b/"
---
<p><a href="https://openwrt.org/"><img class=" size-thumbnail wp-image-1523 alignleft" src="{{ site.baseurl }}/assets/images/2016/08/1280px-openwrt_logo-svg.png?w=150" alt="1280px-openwrt_logo-svg" width="150" height="34" /></a>Есть отличная прошивка на базе всеми любимого линупса для всякой разной техники вроде роутеров и микрокомпьютеров - это <a href="https://openwrt.org/">OpenWRT</a>.</p>
<p>А поскольку эта штука работает в качестве локального днс-сервера, то грех не научить ее блокировать на корню всякие даблклик.нет и другое непотребство.</p>
<p>Рассматривать будем ситуацию при которой у нас установлена дефолтная конфигурация c dnsmasq.</p>
<p>Сначала нам потребуется поставить пакет dnsmasq-full взамен стандартного (он чуть больше по объему и тянет больше зависимостей, и предоставляет больше возможностей по настройке).</p>
<p>[code]# opkg update<br />
# opkg remove dnsmasq<br />
# opkg install dnsmasq-full<br />
# /etc/init.d/dnsmasq restart[/code]</p>
<p>Посмотрим на файл /tmp/etc/dnsmasq.conf. Нас будут интересовать следующие два параметра.</p>
<p>[code]addn-hosts=/tmp/hosts<br />
conf-dir=/tmp/dnsmasq.d[/code]</p>
<p>Буквально это значит, что дополнительные файлы в формате /etc/hosts хранятся в /tmp/hosts, а дополнительные конфиги - в /tmp/dnsmasq.d.</p>
<p>Теперь нам потребуется скрипт, который будет скачивать листы. Поместим его в /root/bin/adblock.sh</p>
<p>[code lang="shell"]#!/bin/sh<br />
echo &quot;download adblock rules&quot;</p>
<p>if [ ! -d /tmp/dnsmasq.d ]; then<br />
 mkdir /tmp/dnsmasq.d<br />
fi</p>
<p>if [ ! -d /tmp/hosts ]; then<br />
 mkdir /tmp/hosts<br />
fi</p>
<p>touch /tmp/dnsmasq.d/adblock.conf</p>
<p>wget -O /tmp/dnsmasq.d/adblock.conf &quot;http://pgl.yoyo.org/adservers/serverlist.php?hostformat=dnsmasq&amp;amp;showintro=0&amp;amp;mimetype=plaintext&quot;</p>
<p>echo &quot;&quot; &gt; /tmp/hosts/adblock</p>
<p>wget -O /tmp/adblock https://hosts-file.net/ad_servers.txt<br />
sed 's/^\(.*\).$/\1/' /tmp/adblock &gt;&gt; /tmp/hosts/adblock<br />
wget -O /tmp/adblock https://adaway.org/hosts.txt<br />
sed 's/^\(.*\).$/\1/' /tmp/adblock &gt;&gt; /tmp/hosts/adblock<br />
wget -O /tmp/adblock http://winhelp2002.mvps.org/hosts.txt<br />
sed 's/^\(.*\).$/\1/' /tmp/adblock &gt;&gt; /tmp/hosts/adblock</p>
<p>if [ -f /tmp/adblock ]; then<br />
 rm /tmp/adblock<br />
fi</p>
<p>/etc/init.d/dnsmasq enabled &amp;&amp; /etc/init.d/dnsmasq restart[/code]</p>
<p>Первым мы скачиваем файл с блокировками в формате dnsmasq, а последующие запросы - это блокировки в формате hosts. Соответственно раскладываем их по разным папкам и рестартим сервис.</p>
<p>Не забываем поставить +x на файл.</p>
<p>Теперь нужно добавить этот скрипт в крон дабы он обновлялся.</p>
<p>[code] # crontab -e[/code]</p>
<p>и пишем туда что-то вроде</p>
<p>[code]* */12 * * *  /bin/sh /root/bin/adblock.sh[/code]</p>
<p>Это означает, что раз в 12 часов списки будут обновляться.</p>
<p>Естественно, что надо включить крон. По дефолту он выключен.</p>
<p>[code]# /etc/init.d/cron enable<br />
# /etc/init.d/cron enabled &amp;&amp; /etc/init.d/cron start[/code]</p>
<p>Теперь осталось сделать так, чтобы при поднятии сетевого интерфейса скрипт сразу же обновлял правила.</p>
<p>А для этого нам потребуется создать файл /etc/hotplug.d/iface/50-adblock примерно следующего вида.</p>
<p>[code]#!/bin/sh<br />
[ ifup = &quot;$ACTION&quot; -a &quot;$DEVICE&quot; = eth1 ] &amp;&amp; {<br />
	/bin/sh /root/bin/update_adblock.sh<br />
}[/code]</p>
<p>Где eth1 - это ваш wan-интерфейс.</p>
<p>Все. Можно перезагрузить роутер для проверки что все настроено корректно.</p>
<p>Рекламные домены вроде doubleclick.de должны резолвиться либо на 0.0.0.0, либо на 127.0.0.1.</p>
<p>[code]$ nslookup  doubleclick.de<br />
Server:		192.168.0.1<br />
Address:	192.168.0.1#53</p>
<p>Name:	doubleclick.de<br />
Address: 127.0.0.1[/code]</p>
<p>Чтобы точно убедиться, что все работает как надо - проверяйте что сразу после поднятия wan появились файлы /tmp/dnsmasq.d/adblock.conf и /tmp/hosts/adblock.</p>
<p>Учтите, что в сумме размер списков блокировки составит более 100 тысяч записей. И если роутер слабоват, то придется какой-то из списков отключать.</p>
<p>И да - это не панацея. Это просто хороший способ обезопасить электронные читалки, телефоны и разную мелкую технику, которая ходит в инет от баннеров и прочего добра.</p>
<p>Источники:</p>
<ul>
<li><a href="https://wiki.openwrt.org/doc/networking/routing">https://wiki.openwrt.org/doc/networking/routing</a></li>
<li><a href="https://forum.openwrt.org/viewtopic.php?id=50407">https://forum.openwrt.org/viewtopic.php?id=50407</a></li>
<li><a href="https://wiki.openwrt.org/doc/howto/cron">https://wiki.openwrt.org/doc/howto/cron</a></li>
<li><a href="https://wiki.openwrt.org/ru/doc/howto/dhcp.dnsmasq">https://wiki.openwrt.org/ru/doc/howto/dhcp.dnsmasq</a></li>
<li><a href="https://forum.openwrt.org/viewtopic.php?id=25304">https://forum.openwrt.org/viewtopic.php?id=25304</a></li>
<li><a href="https://wiki.openwrt.org/doc/techref/initscripts">https://wiki.openwrt.org/doc/techref/initscripts</a></li>
<li><a href="https://wiki.openwrt.org/doc/techref/initscripts">https://wiki.openwrt.org/doc/techref/initscripts</a></li>
<li><a href="https://wiki.openwrt.org/ru/doc/uci/dhcp">https://wiki.openwrt.org/ru/doc/uci/dhcp</a></li>
</ul>
