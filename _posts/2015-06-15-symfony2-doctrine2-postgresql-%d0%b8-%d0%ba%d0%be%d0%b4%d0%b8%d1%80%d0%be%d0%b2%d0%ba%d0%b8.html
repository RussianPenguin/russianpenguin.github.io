---
layout: post
title: Symfony2, Doctrine2, Postgresql и кодировки
date: 2015-06-15 18:19:52.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
tags:
- pgsql
- php
- symfony2
meta:
  _wpcom_is_markdown: '1'
  sharing_disabled: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '11695381287'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2015/06/15/symfony2-doctrine2-postgresql-%d0%b8-%d0%ba%d0%be%d0%b4%d0%b8%d1%80%d0%be%d0%b2%d0%ba%d0%b8/"
---
<p>Суть проблемы: в doctrine2 нет возможности выбрать кодировку подключения для драйвера pdo_pgsql. Совсем никак. Нет. Даже не пытайтесь. У вас ничего не получится.</p>
<p>Вот незадача: в mysql есть опция драйвера pdo <a href="http://php.net/manual/en/ref.pdo-mysql.php">PDO::MYSQL_ATTR_INIT_COMMAND</a>. Благодаря этой опции можно устанавливать кодировку подключения при помощи</p>
<p>[code lang="sql"]set names 'utf8'[/code]</p>
<p>И даже драйвер mysql поддерживает установку кодировки при помощи опции charset в настройках подключения.</p>
<p>Если мы покопаемся в файле драйвера, то увидим, что кодировка исправно обрабатывается</p>
<p>[code lang="php"]&lt;b&gt;Doctrine\DBAL\Driver\PDOMySql\Driver&lt;/b&gt;</p>
<p>    /**<br />
     * Constructs the MySql PDO DSN.<br />
     *<br />
     * @param array $params<br />
     *<br />
     * @return string The DSN.<br />
     */<br />
    private function _constructPdoDsn(array $params)<br />
    {<br />
        $dsn = 'mysql:';<br />
        if (isset($params['host']) &amp;&amp; $params['host'] != '') {<br />
            $dsn .= 'host=' . $params['host'] . ';';<br />
        }<br />
        if (isset($params['port'])) {<br />
            $dsn .= 'port=' . $params['port'] . ';';<br />
        }<br />
        if (isset($params['dbname'])) {<br />
            $dsn .= 'dbname=' . $params['dbname'] . ';';<br />
        }<br />
        if (isset($params['unix_socket'])) {<br />
            $dsn .= 'unix_socket=' . $params['unix_socket'] . ';';<br />
        }<br />
        if (isset($params['charset'])) {<br />
            $dsn .= 'charset=' . $params['charset'] . ';';<br />
        }</p>
<p>        return $dsn;<br />
    }[/code]</p>
<p>Для драйвера pdo_pgsql (Doctrine\DBAL\Driver\PDOPgSql\Driver) нет ничего подобного.</p>
<p>При этом сам <a href="http://www.postgresql.org/docs/8.4/static/multibyte.html">драйвер</a> вполне успешно с кодировками работает.</p>
<p>Однако, безвыходных ситуаций не бывает. Чтобы как-то изменить кодировку при работе с базой pgsql можно применять <a href="http://symfony.com/doc/current/cookbook/doctrine/event_listeners_subscribers.html">события symfony2</a>. А конкретно событие postConnect из doctrine2.</p>
<p>Все, что нам потребуется - это реализовать собственный листенер этого события.</p>
<p>[code lang="php"]namespace DatabaseBundle\Event\Listeners;</p>
<p>use Doctrine\DBAL\Event\ConnectionEventArgs;<br />
use Doctrine\DBAL\Events;<br />
use Doctrine\Common\EventSubscriber;</p>
<p>/**<br />
 * Событие инициализации подключения pgsql.<br />
 * Позволяет установить кодировку бд.<br />
 */<br />
class PgsqlConnectionInit implements EventSubscriber<br />
{<br />
    /**<br />
     * Используемая кодировка<br />
     *<br />
     * @var string<br />
     */<br />
    private $_charset;</p>
<p>    /**<br />
     * Конфигурирование кодировки при создании класса<br />
     *<br />
     * @param string         $charset   The charset.<br />
     */<br />
    public function __construct($charset = 'utf8')<br />
    {<br />
        $this-&gt;_charset = $charset;<br />
    }</p>
<p>    /**<br />
     * @param \Doctrine\DBAL\Event\ConnectionEventArgs $args<br />
     *<br />
     * @return void<br />
     */<br />
    public function postConnect(ConnectionEventArgs $args)<br />
    {<br />
        $args-&gt;getConnection()-&gt;executeQuery(&quot;SET NAMES ?&quot;, array($this-&gt;_charset));<br />
    }</p>
<p>    /**<br />
     * {@inheritdoc}<br />
     */<br />
    public function getSubscribedEvents()<br />
    {<br />
        return array(Events::postConnect);<br />
    }<br />
}</p>
<p>[/code]</p>
<p>А затем подключить этот эвент в config.yml</p>
<p>[code]services:<br />
  pgsql.connection.init:<br />
    class: DatabaseBundle\Event\Listeners\PgsqlConnectionInit<br />
    tags:<br />
      - { name: doctrine.event_listener, event: postConnect }[/code]</p>
<p>Теперь все ок :)</p>
