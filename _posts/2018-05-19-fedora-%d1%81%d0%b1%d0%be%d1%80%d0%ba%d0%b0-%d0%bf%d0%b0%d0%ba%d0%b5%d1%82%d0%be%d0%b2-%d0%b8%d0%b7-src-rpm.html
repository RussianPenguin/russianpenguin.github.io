---
layout: post
title: 'Fedora: сборка пакетов из src.rpm'
date: 2018-05-19 14:44:23.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- HowTo
tags:
- linux
- rpm
meta:
  _wpcom_is_markdown: '1'
  timeline_notification: '1526730267'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '18022416094'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2018/05/19/fedora-%d1%81%d0%b1%d0%be%d1%80%d0%ba%d0%b0-%d0%bf%d0%b0%d0%ba%d0%b5%d1%82%d0%be%d0%b2-%d0%b8%d0%b7-src-rpm/"
excerpt: Разбираемся, что это за пакеты src.rpm и как поставить софт из исходников.
---
<p><img class="alignleft size-thumbnail wp-image-2437" src="{{ site.baseurl }}/assets/images/2018/05/2018-05-19-123539_1076x631.png?w=150" alt="2018-05-19-12:35:39_1076x631" width="150" height="88" />Чаще всего то не требуется обычному пользователю. Но бывает ситуации, когда пакет собран с поддержкой библиотеки исключенной из дистрибутива.</p>
<p>Недавно это случилось с chromium в centos, а с драйверами от epson случается постоянно.</p>
<p>[code lang="shell"]$ cd imagescan-bundle-fedora-27-1.3.23.x64.rpm/<br />
$ ./install.sh<br />
[sudo] пароль для penguin:<br />
Последняя проверка окончания срока действия метаданных: 2:53:00 назад, Сб 19 мая 2018 09:42:23.<br />
Ошибка:<br />
 Проблема 1: conflicting requests<br />
 - nothing provides libboost_filesystem.so.1.64.0()(64bit) needed by imagescan-3.33.0-1epson4fedora27.x86_64<br />
 Проблема 2: package imagescan-plugin-networkscan-1.1.1-1epson4fedora27.x86_64 requires imagescan &gt;= 3.9.0, but none of the providers can be installed<br />
 - conflicting requests<br />
 - nothing provides libboost_filesystem.so.1.64.0()(64bit) needed by imagescan-3.33.0-1epson4fedora27.x86_64<br />
 Проблема 3: package imagescan-plugin-gt-s650-1.0.0-1epson4fedora27.x86_64 requires imagescan &gt;= 3.28.0, but none of the providers can be installed<br />
 - conflicting requests<br />
 - nothing provides libboost_filesystem.so.1.64.0()(64bit) needed by imagescan-3.33.0-1epson4fedora27.x86_64<br />
 Проблема 4: package imagescan-plugin-ocr-engine-1.0.0-1epson4fedora27.x86_64 requires imagescan &gt;= 3.14.0, but none of the providers can be installed<br />
 - conflicting requests<br />
 - nothing provides libboost_filesystem.so.1.64.0()(64bit) needed by imagescan-3.33.0-1epson4fedora27.x86_64[/code]</p>
<p>А еще это может потребоваться если мы хотим поставить пакет, который распространяется только в src.rpm.</p>
<p><!--more--></p>
<h2>Устанавливаем тулчейн для сборки</h2>
<p>Нам потребуется группа пакетов для сборки RPM</p>
<p>[code lang="shell"]$ sudo dnf group install "RPM Development Tools"[/code]</p>
<h2>Подготавливаем окружение</h2>
<p>[code lang="shell"]$ rpmdev-setuptree[/code]</p>
<p>Команда подготовит необходимую структуру папок в домашнем каталого.</p>
<p>[code]/home/penguin/rpmbuild/<br />
├── BUILD<br />
├── BUILDROOT<br />
├── RPMS<br />
├── SOURCES<br />
├── SPECS<br />
└── SRPMS[/code]</p>
<h2>Достаем пакет с исходниками</h2>
<p>Вы же видели репозитарии source (например <em>russianfedora-nonfree-updates-testing-source</em>. Все эти репозитарии откючены в конфиге и включать их нет необходимости потому что пакеты из них обычным способом поставить нельзя.</p>
<p>Установка src.rpm осуществляется под аккаунтом пользователя и производится в каталог rpmbuild, который был подготовлен выше.</p>
<p>Сначала пакет нужно скачать (либо руками, либо из репозитария). В случае репозитария это делается через dnf.</p>
<p>[code lang="shell"]$ dnf download --source xmoto[/code]</p>
<h2>Установка зависимостей</h2>
<p>Для сборки многим пакетам требуются заголовочые файлы или библиотеки для линковки, которые принадлежат другим пакетам. Все зависимости описываются в самом файле с исходниками и для их установки нужно только вызвать команду builddep.</p>
<p>[code lang="shell"]$ sudo dnf builddep package.src.rpm[/code]</p>
<h2>Установка исходников</h2>
<p>Теперь пакет нужно поставить (не забываем, что все операции выполняются под аккаунтом текущего пользователя, а не рута).</p>
<p>[code lang="shell"]$ rpm -ivh imagescan-3.33.0-1epson4fedora27.src.rpm[/code]</p>
<h2>Сборка</h2>
<p>Для сборки следует проверить, что спецификация нужного  пакета появилась в каталоге ~/rpmbuild/SPECS и собрать его при помоощи rpmbuild. Сначала используем опцию -bp, которая выполнит подготовку к сборке и тем самым мы сможем убедиться (хотя бы теоретически), что тулчейн заработал и это вообще можно собрать. И тольео после того, как все прошло удачно заюзаем -ba или -bb.</p>
<p>[code lang="shell"]$ cd ~/rpmbuild<br />
$ rpmbuild -bp SPECS/imagescan.spec[/code]</p>
<p>[code lang="shell"]$ rpmbuild -bp SPECS/imagescan.spec<br />
ошибка: uversion undefined, define to match source archive<br />
ошибка: строка 2: %{!?uversion: %{error: uversion undefined, define to match source archive}}[/code]</p>
<p>В случае imagescan весь процесс происходит очень болезненно. Поэтому я пропущу детали поиска решения и лишь покажу процесс.</p>
<p>[code lang="shell"]$ rpmbuild -bp --define "uversion 0.33.0" SPECS/imagescan.spec[/code]</p>
<p>Дополнительная опция --define позволяет определять и переопределять макросы, которые будут использоваться тулчейном.</p>
<p>[code]/usr/include/gtk-2.0/gtk/gtkstatusicon.h:76:8: error: unnecessary parentheses in declaration of '__gtk_reserved1' [-Werror=parentheses]<br />
void (*__gtk_reserved1);<br />
^<br />
/usr/include/gtk-2.0/gtk/gtkstatusicon.h:77:8: error: unnecessary parentheses in declaration of '__gtk_reserved2' [-Werror=parentheses]<br />
void (*__gtk_reserved2);<br />
^<br />
cc1plus: all warnings being treated as errors<br />
make[2]: *** [Makefile:573: dialog.lo] Error 1<br />
make[2]: Leaving directory '/home/penguin/rpmbuild/BUILD/utsushi-0.33.0/gtkmm'<br />
make[1]: *** [Makefile:604: all-recursive] Error 1<br />
make[1]: Leaving directory '/home/penguin/rpmbuild/BUILD/utsushi-0.33.0'<br />
make: *** [Makefile:511: all] Error 2<br />
ошибка: Неверный код возврата из /var/tmp/rpm-tmp.hKyez0 (%build)[/code]</p>
<p>Таких ошибок встретится превеликое множество из-за довольно старых исходников, которые не адаптированы под свежий стандарт c++. Решением будет установка целой группы флагов через глобальную переменную CXXFLAGS.</p>
<p>[code lang="shell"]CXXFLAGS="-fPIC -Wno-parentheses -Wno-sizeof-pointer-div" rpmbuild -bb --define "uversion 0.33.0" --define "debug_package %{nil}" SPECS/imagescan.spec[/code]</p>
<p>Флаг debug_package добавлен из-за того, что попытка сборки пакета debugpackage приподит к ошибке из-за отсутствия нужных определений в файле спецификации.</p>
<h2>Установка пакета</h2>
<p>[code lang="shell"]$ sudo dnf install RPMS/x86_64/imagescan-3.33.0-1.fc28.x86_64.rpm[/code]</p>
<h2>Литература</h2>
<ul>
<li><a href="https://gcc.gnu.org/ml/gcc-help/2009-05/msg00118.html">Re: Disabling warning: suggest parentheses around &amp;&amp; within ||</a></li>
<li><a href="http://ftp.rpm.org/api/4.4.2.2/conditionalbuilds.html">Passing conditional parameters into a rpm build</a></li>
<li><a href="https://www.g-loaded.eu/2009/04/24/manually-prepare-the-rpm-building-environment/">Manually Prepare the RPM Building Environment</a></li>
<li><a href="https://ask.fedoraproject.org/en/question/87205/how-do-i-install-a-src-rpm-with-dnf/">How do I install a src rpm with dnf?</a></li>
<li><a href="http://knoppix.ru/adv090703.shtml">Установка софта из "сырых" RPM</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc-4.8.2/gcc/Warning-Options.html">3.8 Options to Request or Suppress Warnings</a></li>
<li><a href="https://stackoverflow.com/questions/36983051/rpmbuild-how-to-skip-generation-of-debuginfo-packages-without-change-spec-fi">rpmbuild: how to skip generation of “debuginfo” packages (without change SPEC file ; neither .rpmmacros)</a></li>
</ul>
<p>&nbsp;</p>
