---
layout: post
title: 'Cookies: с ними нужно быть внимательным'
date: 2015-01-25 16:40:57.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
tags:
- cookies
- javascript
- php
meta:
  _wpcom_is_markdown: '1'
  sharing_disabled: '1'
  _wpas_skip_facebook: '1'
  _wpas_skip_google_plus: '1'
  _wpas_skip_twitter: '1'
  _wpas_skip_linkedin: '1'
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
  _publicize_pending: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _edit_last: '13696577'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2015/01/25/cookies-%d1%81-%d0%bd%d0%b8%d0%bc%d0%b8-%d0%bd%d1%83%d0%b6%d0%bd%d0%be-%d0%b1%d1%8b%d1%82%d1%8c-%d0%b2%d0%bd%d0%b8%d0%bc%d0%b0%d1%82%d0%b5%d0%bb%d1%8c%d0%bd%d1%8b%d0%bc/"
---
<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_163.png"><img class="alignleft size-full wp-image-483" src="{{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_163.png" alt="cookies" width="170" height="82" /></a>Однажды на проекте случлось странное с функционалом. Выясняя причину наткнулся на очень много кода, который работает с кукисами. Но вот только работает код неправильно.</p>
<p>Вообще чем кукиса характеризуется:</p>
<ul>
<li>имя</li>
<li>значение</li>
<li>путь</li>
<li>время истечения</li>
<li>домен</li>
<li>секурность</li>
</ul>
<p>Здесь и далее нас будет интересовать домен, поскольку именно он является причиной множества странный и часто трудноуловимых багов.</p>
<p>Возьмем пример https://github.com/RussianPenguin/blogSamples/blob/master/cookies.php и запустим его на локальном сервере пхп (примем за аксиому то, что у нас домен localhost.localdomain резолвится на локалхост).</p>
<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_164.png"><img class="aligncenter size-medium wp-image-484" src="{{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_164.png?w=300" alt="Пример cookie.php на локальном сервере" width="300" height="200" /></a>Теперь зайдем в браузер по нашему скрипту</p>
<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_165.png"><img class="aligncenter size-medium wp-image-485" src="{{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_165.png?w=300" alt="Cookies.php в firebug" width="300" height="156" /></a>Видно, что скрипт выставляет две кукисы для одного и того же домена.</p>
<p>Стандарт предписывает, что кукиса с точкой перед именем домена и без точки доступна в пределах всех поддоменов, а точка оставлена лишь для совместимости с более ранними браузерами.</p>
<p>Казалось бы, мы ставим кукисы на одном и том же домене. Кстати, вот код:</p>
<p>[code lang="php"]// Конфигурация (домен на котором запускаем)<br />
$domain = 'localhost.localdomain';<br />
$cookieName = 'test';</p>
<p>setcookie($cookieName, 'empty host', 3600+time(), '/');<br />
setcookie($cookieName, 'host: ' . $domain, 3600+time(), '/', $domain);[/code]</p>
<p>тут я оставил конфигурацию домена руками так как запуск сервера идет на нестандартном порту.</p>
<p>Так вот. Думалось, что браузер должен поставить одну печеньку и в ней должно быть значение, которое передано последним.</p>
<p>Но нет. Если хидер установки кукиса содержит домен, то кукису будет присвоено имя домена с точкой в начале. А если имени домена не указывать, то кукис будет поставлен на текущий домен без точки в начале.</p>
<p>И когда мы попытаемся считать на стороне клиента (или сервера) наш поставленый кукис, то какой из них вернется - это уже немного рандом (хотя нет, все зависит от того, в какой последовательности печеньки ставились).</p>
<p>И то же самое происходит на клиенте: если мы при установки кукиса указываем домен, то браузер поставит кукис на домен с точкой в начале, а если не укажем, то без точки.</p>
<p>Попробуем прописать в тестовом скрипте какое-то значение для печеньки, но не указывать домен. А потом нажмем кнопку "поставить кукис".</p>
<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_166.png"><img class="aligncenter size-medium wp-image-486" src="{{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_166.png?w=300" alt="cookies.php после setCookie" width="300" height="131" /></a>Что мы видим? А видим мы то, что браузер считал значение для текущего домена (первое) и перезаписал его новым. Которое мы выбрали. А второй кукис до перезагрузки остался нетронутым. Круто. А значит нажмем "прочитать печеньку" и увидим наше новое значение.</p>
<p>Однако если мы так думаем, то ошибаемся.</p>
<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_167.png"><img class="aligncenter size-medium wp-image-487" src="{{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_167.png?w=300" alt="cookies.php getCookie" width="300" height="117" /></a>Даже FireCookie что-то показывает - это не значит, что значение печенья поменялось.</p>
<p>Огнелись ничего не поставил.</p>
<p>Но как только мы домен укажем при установке</p>
<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_168.png"><img class="aligncenter size-medium wp-image-488" src="{{ site.baseurl }}/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_168.png?w=300" alt="cookie.php - правильный результат" width="300" height="134" /></a>Так сразу все работает как надо - устанавливается значение и при нажатии на кнопку "прочитать" мы его получаем.</p>
<p>Так вот. Это я о том, что в проекте нельзя смешивать подходы установки мучных изделий. Это приводит к тому, что много-много времени можно угробить в поисках ошибки, которой нет.</p>
<p>Учтите, что если вы заходите повторить этот эксперимент, то на доменах верхнего уровня подобное не работает. Т.е. если мы будем использовать localhost, то подобное поведение не воспроизведется.</p>
