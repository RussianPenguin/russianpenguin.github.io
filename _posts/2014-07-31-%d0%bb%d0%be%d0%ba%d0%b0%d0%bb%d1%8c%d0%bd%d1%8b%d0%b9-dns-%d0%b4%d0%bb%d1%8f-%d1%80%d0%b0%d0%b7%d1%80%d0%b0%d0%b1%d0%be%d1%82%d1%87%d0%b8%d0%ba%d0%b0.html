---
layout: post
title: Локальный DNS для разработчика
date: 2014-07-31 23:23:01.000000000 +04:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags:
- linux
meta:
  _wpcom_is_markdown: '1'
  sharing_disabled: '1'
  _wpas_skip_facebook: '1'
  _wpas_skip_google_plus: '1'
  _wpas_skip_twitter: '1'
  _wpas_skip_linkedin: '1'
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
  _publicize_pending: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _edit_last: '13696577'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2014/07/31/%d0%bb%d0%be%d0%ba%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b9-dns-%d0%b4%d0%bb%d1%8f-%d1%80%d0%b0%d0%b7%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%87%d0%b8%d0%ba%d0%b0/"
---
<p>Итак. У нас море проектов, море виртуалок. И мы хотим как-то удобно с этим всем работать.</p>
<p>Мне по нраву выделять отдельную доменную зону для всех своих виртуалок и подключать к ней нужные адреса.</p>
<p>Предположим, что все проекты у нас будут собраны в доменной зоне *.dev (удобно же).</p>
<p>И каждый из них будет резолвиться по разным адресам.</p>
<p>Составим для себя список хотелок:</p>
<ul>
<li>машины поднимаются вагрантом или еще какой системой (это не так уж и важно)</li>
<li>после появления машины в сети ее ip связывается с доменом проекта, который на ней крутится</li>
<li>после завершения привязка уделяется</li>
</ul>
<p>Начинаем хотелки реализовывать.</p>
<p>Ставим named</p>
<p>[code lang="shell"]$ sudo yum install named[/code]</p>
<p>Заставляем его слушать только локалхост (он же девелоперский).</p>
<p>Для этого редактируем named.conf и добавляем в раздел options</p>
<p>[code]    listen-on port 53 { 127.0.0.1; };<br />
    listen-on-v6 port 53 { ::1; };[/code]</p>
<p>Теперь нам надо подключить нашу новую зону.</p>
<p>Добавляем подключение описания в named.conf</p>
<p>[code]zone &quot;dev&quot; IN {<br />
    type master;<br />
    file &quot;named.dev&quot;;<br />
    allow-query {any;};<br />
    allow-update {<br />
        127.0.0.1;<br />
        ::1;<br />
    };<br />
};[/code]</p>
<p>В этом описании мы сразу же видим раздел allow-update, который позволяет удаленно изменять зону при помощи команды nsupdate. Разрешаем правку только с локалхоста.</p>
<p>Теперь непосредственно сам файл зоны прямого преобразования - /var/named/named.dev</p>
<p>[code]$ORIGIN dev.<br />
$TTL 86400    ; 1 day<br />
@            IN SOA    dev. rname.invalid. (<br />
                4          ; serial<br />
                86400      ; refresh (1 day)<br />
                3600       ; retry (1 hour)<br />
                604800     ; expire (1 week)<br />
                10800      ; minimum (3 hours)<br />
                )<br />
            NS    dev.<br />
            A    127.0.0.1<br />
            AAAA    ::1<br />
*        IN    A    127.0.0.1[/code]</p>
<p>Последняя строчка нам нужна для того, чтобы все домены, для которых не прописан адрес резолвились на локалхост.</p>
<p>Все. Нам осталось перезапустить.</p>
<p>[code lang="shell"]$ sudo service named restart[/code]</p>
<p>Проверяем</p>
<p>[code lang="shell"]$ nslookup test.dev 127.0.0.1<br />
Server:        127.0.0.1<br />
Address:    127.0.0.1#53</p>
<p>Name:    test.dev<br />
Address: 127.0.0.1[/code]</p>
<p> </p>
<p> </p>
<p>Кдасс. А как нам связывать домен с адресом?</p>
<p>Для этого нам нужен скрипт.</p>
<p>[code lang="shell"]#!/bin/bash<br />
TTL=86400<br />
RECORD=$1<br />
IP=$2<br />
(<br />
 echo &quot;server dev.&quot;<br />
 echo &quot;zone dev&quot;</p>
<p> echo &quot;update delete ${RECORD} A&quot;<br />
 echo &quot;update add ${RECORD} ${TTL} A ${IP}&quot;<br />
 echo &quot;send&quot;<br />
) | /usr/bin/nsupdate[/code]</p>
<p> </p>
<p>Пробуем</p>
<p>[code lang="shell"]$ ./named.sh test.dev 1.1.1.1[/code][code lang="shell"]$ nslookup test.dev 127.0.0.1<br />
Server:		127.0.0.1<br />
Address:	127.0.0.1#53</p>
<p>Name:	test.dev<br />
Address: 1.1.1.1[/code]</p>
<p>Возможные проблемы:</p>
<ul>
<li>неправильно установлены права на папку /var/named</li>
<li>неправильно указан адрес с которого можно обновлять зону</li>
<li>запрет в selinux - решается выполнением [code lang="shell"]$ sudo setsebool -P named_write_master_zones 1[/code]</li>
</ul>
<p>Теперь можно настроить окружение так, чтобы при запуске виртуалки ее адрес обновлялся в файле зоны через скрипт в автоматическом режиме.</p>
