---
layout: post
title: 'PHP: Самые распространенные проблемы при работе с сессиями'
date: 2018-06-02 13:29:36.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
tags:
- linux
- php
- selinux
meta:
  _wpcom_is_markdown: '1'
  timeline_notification: '1527935379'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '18524292824'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2018/06/02/php-%d1%81%d0%b0%d0%bc%d1%8b%d0%b5-%d1%87%d0%b0%d1%81%d1%82%d1%8b%d0%b5-%d0%bf%d1%80%d0%be%d0%b1%d0%bb%d0%b5%d0%bc%d1%8b-%d1%81-%d1%81%d0%b5%d1%81%d1%81%d0%b8%d1%8f%d0%bc%d0%b8/"
excerpt: Статья рассказывает о самых распространенных проблемах при работе с файловыми
  сессиями в php
---
![phpsessions]({{ site.baseurl }}/assets/images/2018/06/phpsessions.png?w=150)С сессиями в php существует множество непонятных проблем. С появлением виртуальных окружений проблем стало больше.

Рассмотрим наиболее часто встречающиеся проблемы сессий на файлах (мы не будем затрагивать сессии в бд и кастомные обработчики).

## session\_start(): open(filename, O\_RDWR) failed: No such file or directory

Очевидно, что ошибка возникает, когда не существует пути, по которому пишутся данные. Но при этом вы знаете, что на диске каталог, который был указан как аргумент session\_save\_path(), существует.

Например.

```shell
$ mkdir /tmp/sessions  
$ chmod 777 /tmp/sessions
```

```php
session\_save\_path('/tmp/sessions');  
session\_start();
```

Вы увидите на экране или в логах ошибку из заголовка (не во всех дистрибутивах).

Можно посмотреть audit.log из selinux, но если там нет ничего подозрительного и каталог действительно есть (а вы его создали выше), то причина такого поведения достаточно неожиданна.

Происходит это потому что вы работаете в centos 7 версии (или redhat\fedora) и выше. Именно в этой версии ввели параметр [PrivateTmp](https://help.directadmin.com/item.php?id=561) для сервисов. Что это означает для нас?

Сделайте второй скрипт, который перечисляет содержимое директории /tmp, а так же выводит реальный путь каталога /tmp/sessions.

```php
var\_dump(glob('/tmp/\*'));
```

Откройте скрипт в браузере. Вы увидите, что содержимое в браузере кардинально отличается от содержимого реальной папки /tmp. На скриншоте мы видем вывод из консоли и из браузера - результат совершенно разный.

![2018-06-02-12:32:03_1625x863]({{ site.baseurl }}/assets/images/2018/06/2018-06-02-123203_1625x863.png)

Как это побороть? Использовать другой каталог для хранения сессий. Или перед стартом приложения проверять и создавать в случае необходимости нужную файловую структуру.

## session\_start(): Session data file is not created by your uid

Не самая распространенная ошибка. Чаще всего возникает в виртуальных окружениях.

Ошибка возникает в [случае](https://github.com/php/php-src/blob/5eb1f92f31cafc48384f9096012f421b37f6d425/ext/session/mod_files.c#L206-L211), когда uid владельца файла сессии не совпадает с uid текущего пользователя под которым запущен интерпретатор.

Как проверить, что это именно наш случай? Нужно создать скрипт, которыый создает файл в каталоге, в котором вы планируете размещать сессии и сверяет uid владельца файла и uid владельца процесса.

```php
$file = \_\_DIR\_\_ . DIRECTORY\_SEPARATOR . 'file.name';  
$fd = fopen($file, 'w');  
fwrite($fd, 'test data');  
fclose($fd);  
if (file\_exists($file)) {  
 $stat = stat($file);  
 var\_dump($stat['uid'] == posix\_getuid());  
}
```

Если мы увидим false, то да. Проблема имеет мысто быть. И вам нужно переместить сессии в другое место.

Так же подобное поведение характерно при некоторых способах монтирования nfs.

## session\_start(): open(filename, O\_RDWR) failed: Permission denied

Каталог недоступен для записи и достаточно дать права 777. Но тут не все так очевидно и данный трюк действует не всегда. Если вы работаете в дистрибутивах, которые используют selinux, то даже при установке полных прав система можем вам не позволить писать по выбранному пути.

Это происходит потому что контекст процесса отличается от контекста папки. Вы всегда можете посмотреть в /var/log/audit/audit.log чтобы убедиться.

Как обращаться с контекстами можно подробнее посмотреть в [документации](https://wiki.centos.org/HowTos/SELinux) и в [книге](https://www.packtpub.com/networking-and-servers/selinux-system-administration).

## Литература

- [CentOS wiki: SELinux](https://wiki.centos.org/HowTos/SELinux)
- [SELinux System Administration](https://www.packtpub.com/networking-and-servers/selinux-system-administration)
- [GitHub: php-src](https://github.com/php/php-src/tree/master/ext/session)
