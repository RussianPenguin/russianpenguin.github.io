---
layout: post
title: 'PHPStorm: Запускаем тесты на удаленной машине с возможностью отладки'
date: 2018-07-11 21:13:46.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags:
- codeception
- linux
- php
- tdd
meta:
  _wpcom_is_markdown: '1'
  timeline_notification: '1531332830'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '19907214863'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2018/07/11/phpstorm-%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d0%b5%d0%bc-%d1%82%d0%b5%d1%81%d1%82%d1%8b-%d0%bd%d0%b0-%d1%83%d0%b4%d0%b0%d0%bb%d0%b5%d0%bd%d0%bd%d0%be%d0%b9-%d0%bc%d0%b0%d1%88%d0%b8%d0%bd%d0%b5/"
excerpt: Заметка рассказывает о том, как настроить запуск и отладку кода тестов на
  удаленной машине напрямую из IDE.
---
![2018-07-11-21:10:29_373x236]({{ site.baseurl }}/assets/images/2018/07/2018-07-11-211029_373x236.png)Не секрет, что современные среды разработки полны полезного функционала, освоение которого позволяет поднять продуктивность разработки до невероятных высот.

Сегодня мы реализуем возможность запуска тестов на проекте в каком-либо контейнере (докер, вагрант, удаленное железо), просмотре их выполнения и возможности анализа результатов. И все это не переключаясь на отдельную консоль.

Почему это удобно? Я уже неоднократно ссылался на удобство контейнеров поскольку они обеспечивают повторяемость окружения, скорость развертывания рабочего проекта и схожесть окружений у всех разработчиков в команде.

Долгое время неудобством выступало то, что для тестирования и непосредственной отладки требовалось выполнить переключение на консоль тестовой машины.

Дано:

- окружение под vagrant (один из способов собрать такое окружение описан в соответствующей [статье](/2017/05/02/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be-%d1%87%d0%b0%d1%81%d1%82%d1%8c-4/)).

Надо:

- запускать и отлаживать тесты не выходя из ide

<!--more-->

## Интеграция тестов

**1 - настраиваем удаленный интерпретатор PHP**

[gallery ids="2456,2457" type="rectangular"]

При выборе удаленного интерпретатора автоматически будут подключены настройки маппинга директорий. Если этого не случилось, то придется вручную прописать соответствие путей на удаленной машине каталогам на локальной системе (пункт path mappings).

В этом же разделе можно указать include path если есть такая необходимость (например подключить pear).

**2 - Настраиваем конфигурацию тестового фреймворка.**

Необходимо выбрать интерпретатор, указать путь до исполняемого файла и выбрать корректный маппинг,

Обратите внимание на то, что все пути указываются как пути на удаленном хосте.

![2018-07-11-20:24:22_1184x513]({{ site.baseurl }}/assets/images/2018/07/2018-07-11-202422_1184x513.png)

**3 - Задаем run configuration для запуска тестов.**

![2018-07-11-20:22:38_1120x727]({{ site.baseurl }}/assets/images/2018/07/2018-07-11-202238_1120x727.png)

**4 - Запускаем из меню run.**

Здесь кроется одно большое но: на момент написания данной заметки интеграция codeception испытывает некоторые сложности при работе с сессиями и кукисами. Подробнее об этом можете почитать в [описании бага](https://github.com/Codeception/Codeception/issues/4476) на гитхабе. Там же есть и возможные пути решения.

## Отладка тестов

Самое интересное во всем этом - возможность отлаживать код непосредственно во время запуска тестов никуда не переключаясь.

**5 - Задаем скрипт, который организует коннект к девелоперской машине**

Чуть ранее мы уже рассматривали, как выполнять [отладку](/2018/04/01/php-%d0%be%d1%82%d0%bb%d0%b0%d0%b6%d0%b8%d0%b2%d0%b0%d0%b5%d0%bc-%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d1%8b-%d0%ba%d0%be%d0%bc%d0%b0%d0%bd%d0%b4%d0%bd%d0%be%d0%b9-%d1%81%d1%82%d1%80%d0%be%d0%ba%d0%b8/) скриптов командной строки. Напишем маленький хелпер и разместим его с правами на запуск где-нибудь на тестовом стенде.

```shell
#!/usr/bin/env sh

IP=`echo $SSH_CLIENT | awk '{print $1}'`  
echo #IP  
PHP='/usr/bin/env php -d 'xdebug.remote_host=${IP}' -d 'xdebug.remote_autostart=1''  
$PHP "$@"
```

**6 - Добавляем .phpstorm_helpers в маппинг**

Пре первом запуске тестов IDE складывает в домашний каталог пользователя специальный набор интеграционных скриптов. Если не добавить его в include path, то мы не сможем выполнить отладку: система будет ругаться на то, что соответствия файлов не найдены.

Для этого мы копируем директорию .phpstorm_helpers в корень проекта (исключаем его в .gitignore) и настраиваем сервер

Заходи в раздел настройки серверов и создаем новый. В котором обязательно включаем path mapping, а затем прописываем соответствия каталогов локального и удаленного. При этом не забываем про .phpstorm_helpers. Иначе не будет работать.

![2018-07-11-21:04:49_1180x846]({{ site.baseurl }}/assets/images/2018/07/2018-07-11-210449_1180x846.png)

**7 - Меняем удаленный интерпретатор на наш скрипт**

В настройках php указываем скрипт, который мы написали ранее как экзешник.

![2018-07-11-21:07:50_870x389]({{ site.baseurl }}/assets/images/2018/07/2018-07-11-210750_870x389.png)

Теперь у вас есть не только удобный механизм исполнения тестов, но еще и возможность их отладки.

## Литература

- [Working with Remote PHP Interpreters in PhpStorm](https://confluence.jetbrains.com/display/PhpStorm/Working+with+Remote+PHP+Interpreters+in+PhpStorm)
