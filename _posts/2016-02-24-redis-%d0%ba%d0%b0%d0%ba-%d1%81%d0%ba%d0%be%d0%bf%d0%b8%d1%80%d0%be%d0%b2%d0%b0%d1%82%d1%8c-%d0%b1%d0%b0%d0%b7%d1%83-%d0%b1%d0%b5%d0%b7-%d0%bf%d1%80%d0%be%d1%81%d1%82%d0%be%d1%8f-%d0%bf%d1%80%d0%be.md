---
layout: post
title: 'Redis: как скопировать базу без простоя проекта'
date: 2016-02-24 21:04:12.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags:
- redis
meta:
  _wpcom_is_markdown: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '20135774401'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2016/02/24/redis-%d0%ba%d0%b0%d0%ba-%d1%81%d0%ba%d0%be%d0%bf%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d1%82%d1%8c-%d0%b1%d0%b0%d0%b7%d1%83-%d0%b1%d0%b5%d0%b7-%d0%bf%d1%80%d0%be%d1%81%d1%82%d0%be%d1%8f-%d0%bf%d1%80%d0%be/"
---
![redis]({{ site.baseurl }}/assets/images/2016/02/redis.png?w=150)Ага. У нас проблемы: нам нужно переехать сервер редиса без даунтайма проекта. Но нам надо не только переехать, но еще и данные сохранить.

Чаще всего предлагается решение в виде остановки проекта, копирования базы в новый инстанс, его запуск, переключение проекта и другие танцы.

Существует даже команда [migrate](http://redis.io/commands/MIGRATE), которая гарантирует атомарное копирование ключей и данных.

Но она работает в рамках одной бд (а по дефолту у редиса их целых 16), а так же обладает рядом негативных последствий ввиду своей атомарности. Поэтому подходит она совершенно для других целей.

Сразу на ум приходят репликации :) А данное решение их умеет.

Допустим у нас два сервера (у меня они на портах 6379 и 6479 соответственно). И нам нужно переключить проект с первого на второй сервер. Второй нулевой только что поднятый. А с первым ведется работа.

![2016-02-24-20:28:27_805x48]({{ site.baseurl }}/assets/images/2016/02/2016-02-24-202827_805x48.png)

Посмотрим, что в каждой из баз покажет команда

```
keys \*
```

Основной редис

![2016-02-24-20:29:30_482x426]({{ site.baseurl }}/assets/images/2016/02/2016-02-24-202930_482x426.png)

Новый редис

![2016-02-24-20:29:47_190x32]({{ site.baseurl }}/assets/images/2016/02/2016-02-24-202947_190x32.png)

Как видим пока базы не синхронизированы.

Теперь нужно сделать новую базу репликой старой

```
\> slaveof 127.0.0.1 6379  
OK  
\> info  
...  
role:slave  
master\_host:127.0.0.1  
master\_port:6379  
master\_link\_status:up  
master\_last\_io\_seconds\_ago:1  
master\_sync\_in\_progress:0
```

Дополнительно может потребоваться авторизоваться на мастере чтобы началась репликация

```
config set masterauth \<password\>
```

После этого можем опять посмотреть, что в базу скопировалось

```
keys \*
```

![2016-02-24-21:00:18_441x414]({{ site.baseurl }}/assets/images/2016/02/2016-02-24-210018_441x414.png)

Как видим: все данные успешно засинхронизировались (вполне возможно это займет продолжительное время ввиду объема данных).

После того, как репликация завершена нам нужно сделать две вещи:

- превратить слейва в мастер
- настроить приложение на работу с новым мастером

```
slaveof no one
```

Эта команда выключает копирование данных с мастера (но не удаляет их) и теперь уже дело за настройкой приложения.

Да. Небольшой даунтайм все же был (секунд 10-15), но это гораздо лучше, чем предлагаемые решения.

Однако, обратите внимание, что если вы активно пишете в редис, то при такой миграции баз часть данных можно и потерять.

[Почитать про репликации](http://redis.io/topics/replication).

