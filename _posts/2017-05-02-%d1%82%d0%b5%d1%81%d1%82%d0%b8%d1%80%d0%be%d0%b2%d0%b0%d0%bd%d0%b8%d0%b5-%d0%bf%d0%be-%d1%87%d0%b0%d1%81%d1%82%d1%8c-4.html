---
layout: post
title: 'Часть 4: Подготовка окружение (vagrant + PuPHPet) (Тестирование ПО)'
date: 2017-05-02 21:04:54.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Разработка
- HowTo
tags:
- тестирование по
- tdd
- vagrant
meta:
  _wpcom_is_markdown: '1'
  _oembed_86dfec9e491159b4ff0a11b6e59a7d3b: "{{unknown}}"
  _oembed_39f37423a48af85bd0554f3d0a494326: "{{unknown}}"
  _oembed_4296f57b2e08d488d71a0e94dce3a7e0: "{{unknown}}"
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '4627166510'
author:
  login: russianpenguin
  email: maksim.v.zubkov@gmail.com
  display_name: russianpenguin
  first_name: Maksim
  last_name: Zubkov
permalink: "/2017/05/02/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be-%d1%87%d0%b0%d1%81%d1%82%d1%8c-4/"
excerpt: В этой статье мы подготовим окружение на базе операционной системы Linux
  с использованием таких инструментов как vagrant и puppet. В этом окружении будет
  развернут проект на базе yii2 для последующей работы.
---
<h2><img class="alignleft size-medium wp-image-1889" src="{{ site.baseurl }}/assets/images/2017/05/d181d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-d0bed182-2017-05-02-16-36-41.png?w=300" alt="Снимок экрана от 2017-05-02 16-36-41" width="300" height="154" /><a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/">Оглавление</a></h2>
<p>Это очередная часть проекта <a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/">Тестирование ПО</a> который рассказывает о разработке веб-приложений с использованием методологии TDD. Конкретно  в этой главе мы развернем рабочее окружение и создадим шаблон проекта для последующей разработки.</p>
<p>Для создания окружения многие используют для этого ту же машину на которой и пишут код. Нельзя однозначно сказать, хорошо это или плохо. В нашем случае это плохо. Поскольку рабочая система засоряется пакетами и приложениями, которые нужны лишь на один раз. Плюс к этому нельзя взять окружение, удалить его и начать заново если что-то не понравилось или из-за игры с настройками все пошло не так. И конечно же, не стоит забывать разработчиков, которые пользуются отличными от *nix операционными системами, так как многие из дальнейших операций будут им попросту либо недоступны, либо доступны со множеством ограничений.</p>
<p>В этой статье мы подготовим стартовое окружение при помощи инструмента <a href="https://puphpet.com">PuPHPet</a> и дальше немного его доработаем для того, чтобы автоматизировать развертывание проекта из репозитория.</p>
<p><!--more--></p>
<h2>Что нам потребуется</h2>
<p>Увы, без сторонних инструментов нам не обойтись. Но их не так много и поставить пакет в вашем любимом дистрибутиве или запустить инсталлятор под windows проблем не составит.</p>
<ol>
<li><a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> - виртуальная машина от Oracle, которая поставляется под различные операционные системы.</li>
<li><a href="https://www.vagrantup.com/downloads.html">Vagrant</a> - набор инструментов для простого и удобного создания и настройки виртуальных машин. Этот проект так же поставляется под различные операционные системы.</li>
</ol>
<p>За сведениями про установку данного по вам стоит обратиться к документации вашего дистрибутива или в официальную документацию проектов.</p>
<h2>Что мы сделаем</h2>
<ul>
<li>сервер nginx (не только проксирование запросов на php-fpm, но и отдача клиенту статики)</li>
<li>php-fpm (основной инструмент для запуска приложения. Этот механизм быстрее и проще в конфигурировании нежели связка apache+mod_php)</li>
<li>redis (в приложении, которое мы напишем это будет важное звено)</li>
<li>memcached (сессии php)</li>
<li>приложение разделено на две части (бекенд и фронтенд) за основу взять шаблон <a href="https://github.com/yiisoft/yii2-app-advanced">yii2 advanced application template</a>. Для каждой части отдельное доменное имя - tdd.dev для основной компоненты проекта и api.tdd.dev для обработки входящих ajax.</li>
<li>для каждого из доменов nginx должен быть настроен таким образом чтобы статика запрашивалась непосредственно из папки с содержимым доступным через web, а все скрипты запрашивались через обращение к php-fpm</li>
<li>база данных mariadb с созданной базой и отдельны пользователем для этой базы</li>
</ul>
<h2>Веб-конфигуратор</h2>
<p>Для начала переходим на главную страницу <a href="https://puphpet.com/">PuPHPet</a> и следуя из раздела в раздел по кнопкам мастера внизу экрана проставляем нужные нам параметры. Процесс конфигурирования интуитивен. Параметры по-умолчанию нас чаще всего будет устраивать, но в некоторых случаях придется сделать исключение и провести предварительную доработку.</p>
<h3>Deploy target-&gt;Locally</h3>
<p><img class="alignnone size-full wp-image-1892" src="{{ site.baseurl }}/assets/images/2017/05/01-deployment-target.png" alt="01 - Deployment target" width="865" height="2079" />Запуск проекта осуществляется локально через при помощи virtualbox. Устанавливаем <i>locally</i> и операционную систему <i>centos 7 </i>(в тестовом примере это x64, но вы всегда можете собрать машину на другой архитектуре и системе, но тогда последующие шаги придется адаптировать под вашу сборку). Другие <strong>Deploy target</strong> отключаем</p>
<p>Для корректной синхронизации между машинами указываем в подразделе <b>shared folders-&gt;folder target</b> каталог <i>/var/www</i>. И тип синхронизации <i>Default</i>. <b>Memory</b> - <i>1024</i>.</p>
<h3>System-&gt;Packages</h3>
<p><img class="alignnone size-full wp-image-1895" src="{{ site.baseurl }}/assets/images/2017/05/02-system.png" alt="02 - System" width="874" height="332" />PuPHPet не имеет в своем конфигураторе способа поставить memcached одной галочкой и его надо добавить в список стандартных пакетов.</p>
<ul>
<li>htop, vim, memcached.</li>
</ul>
<h3>System-&gt;Locale/Timezone</h3>
<p><img class="alignnone size-full wp-image-1898" src="{{ site.baseurl }}/assets/images/2017/05/03-locale.png" alt="03 - Locale" width="867" height="517" />Для нас будет удобно если локаль системы соответствует региональным установкам.</p>
<ul>
<li><b>Default locale</b>: <i>ru_RU.UTF-8</i></li>
<li><b>Supported locales</b>: <i>ru_RU.UTF-8, en_GB-UTF-8, en_US.UTF-8</i></li>
</ul>
<h3>Webservers-&gt;Nginx</h3>
<p>Для работы потребуется два домена tdd.dev и api.tdd.dev с практически идентичными конфигурациями.</p>
<h4>tdd.dev</h4>
<p>[gallery ids="1901,1905" type="rectangular" link="file"]</p>
<ul>
<li><b>Project root</b>: <i>/var/www/frontend/web</i></li>
<li><b>Server aliases</b>: <i>www.tdd.dev</i></li>
</ul>
<p>Домен содержит два локейшна:</p>
<ul>
<li><b>location match</b>: <i><i>~ \.php$</i></i>
<ul>
<li><b>location root</b>: <i>/var/www/frontend/web</i></li>
<li><b>FastCGI Pass</b>: <i>127.0.0.1:9000</i></li>
<li><b>FastCGI Split Path Info</b>: <i>^(.+\.php)(.*)$</i></li>
<li><b>Set variables</b>: <i>$path_info $fastcgi_path_info</i></li>
<li><b>FastCGI Index</b>: <i>index.php</i></li>
<li><b>Try Files</b>: <i>$uri, =404</i></li>
<li><b>FastCGI Environment Variables</b>: <i>YII_ENV dev, YII_DEBUG 1, SCRIPT_FILENAME $document_root$fastcgi_script_name</i></li>
</ul>
</li>
<li><b>location match</b>: <i><i>/</i></i>
<ul>
<li><b>location root</b>: <i>/var/www/frontend/web</i></li>
<li><b>Try Files</b>: <i>$uri, $uri/, /index.php$is_args$args</i></li>
</ul>
</li>
</ul>
<h4>api.tdd.dev</h4>
<p>[gallery ids="1914,1917" type="rectangular" link="file"]</p>
<ul>
<li><b>Project root</b>: <i>/var/www/backend/web</i></li>
</ul>
<p>Аналогично фронтенду домен также содержит два локейшна.</p>
<ul>
<li><b>location match</b>: <i><i>~ \.php$</i></i>
<ul>
<li><b>location root</b>: <i>/var/www/backend/web</i></li>
<li><b>FastCGI Pass</b>: <i>127.0.0.1:9000</i></li>
<li><b>FastCGI Split Path Info</b>: <i>^(.+\.php)(.*)$</i></li>
<li><b>Set variables</b>: <i>$path_info $fastcgi_path_info</i></li>
<li><b>FastCGI Index</b>: <i>index.php</i></li>
<li><b>Try Files</b>: <i>$uri, =404</i></li>
<li><b>FastCGI Environment Variables</b>: <i>YII_ENV dev, YII_DEBUG 1, SCRIPT_FILENAME $document_root$fastcgi_script_name</i></li>
</ul>
</li>
<li><b>location match</b>: <i><i>/</i></i>
<ul>
<li><b>location root</b>: <i>/var/www/backend/web</i></li>
<li><b>Try Files</b>: <i>$uri, $uri/, /index.php$is_args$args</i></li>
</ul>
</li>
</ul>
<p>Стоит отметить, что <i>YII_ENV</i> указывать крайне желательно. Этот параметр в дальнейшем влияет на режим работы Yii2 (либо он будет в отладочном, либо в тестовом, либо в продакшн режиме). Желательным является указание переменной <i>YII_DEBUG</i>.</p>
<h3>Languages-&gt;PHP</h3>
<p>[gallery ids="1938,1939" type="rectangular" link="file"]</p>
<ul>
<li><b>PHP modules</b>: <i>cli, intl, xml, mbstring, bz2, calendar, ctype, gd, imagick, memcached</i></li>
<li><b>Ini Settings</b>: добавляем еще одну настройку <i>expose_php = 0</i></li>
</ul>
<p>Включаем composer и xdebug. Настройки по-умолчанию нас пока устраивают.</p>
<h3>Databases-&gt;MariaDB</h3>
<p>[gallery ids="1946,1947" type="rectangular" link="file"]</p>
<ul>
<li><b>Root password</b>: указываем то, что нам нравится. В дальнейшем root нам будет нужен очень редко.</li>
</ul>
<p>В секции пользователей удаляем всех и добавляем нового пользователя tdd. Соответственно указываем для него пароль.</p>
<p>В секции баз данных нам нужна только одна база - tdd. Удаляем все, что там есть и добавляем новую базу.</p>
<p>В секции grants нужно добавить права для пользователя tdd</p>
<ul>
<li><b>Privileges</b>: <i>USAGE</i>, <b>database</b>: <i>*.*</i>, <b>user</b>: <i>tdd</i></li>
<li><b>Privileges</b>: <i>ALL</i>, <b>database</b>: <i>tdd.*</i>, <b>user</b>: <i>tdd</i></li>
</ul>
<p>Отмечу, что это не совсем правильный подход. В реальном мире пользователь для администрирования базы должен быть отдельным. Один пользователь для работы с данными и администрирования сделан исключительно для упрощения.</p>
<h3>Databases-&gt;Redis</h3>
<p><img class="alignnone size-full wp-image-1951" src="{{ site.baseurl }}/assets/images/2017/05/12-redis.png" alt="12 - redis" width="868" height="272" /></p>
<p>Включаем.</p>
<h2>Доработка конфигурации для удобной работы</h2>
<p>Скачиваем и распаковываем архив из раздела <b>create archive</b> в папку с проектами на диске.</p>
<p>Перед запуском нужно отредактировать файл puphpet/puppet/modules/php/manifests/pecl/module.pp. Требуется заменить все вхождения</p>
<p>[code]&quot;pecl info ${name}&quot;[/code]</p>
<p>на</p>
<p>[code]&quot;pecl info ${name} | iconv -c; test \${PIPESTATUS[0]} -eq 0&quot;[/code]</p>
<p>Это требуется для того, чтобы избавиться от <a href="https://github.com/puphpet/puphpet/issues/2650">бага</a>.</p>
<p>Увы, но это не все. Для удобной работы нам потребуется сделать еще несколько шагов чтобы подготовить инфраструктуру.</p>
<h3>Токены авторизации для composer</h3>
<p>Для настройки токенов нам потребуется сформировать файл auth.json в котором будет размещен ключ авторизации. Чтобы получить ключ открываем страницу <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> создаем ключ и копируем то, что получилось.</p>
<p>[code lang="javascript"]{<br />
  &quot;github-oauth&quot;: {<br />
    &quot;github.com&quot;: &quot;тут токен, который получили выше&quot;</p>
<p>}<br />
}[/code]</p>
<p>Полученный файл размещаем по адресу <i>puphpet/files/dot/.config/composer/auth.json</i>.</p>
<p>После этапа провизии этот файл будет автоматически скопирован на виртуальную машину.</p>
<p><b>Предупреждение: не забудьте добавить его в .gitignore перед коммитом.</b></p>
<h4>Vagrant</h4>
<p>Создадим файл puphpet/bootstrap.sh со следующим содержимым</p>
<p>[code lang="shell"]#!/usr/bin/env bash<br />
echo &quot;export YII_ENV=${YII_ENV}&quot; &gt; /etc/profile.d/yii_env.sh<br />
echo &quot;set YII_ENV=dev${YII_ENV}&quot; &gt; /etc/profile.d/yii_env.csh<br />
echo &quot;export YII_DEBUG=${YII_DEBUG}&quot; &gt; /etc/profile.d/yii_debug.sh<br />
echo &quot;set YII_DEBUG=${YII_DEBUG}&quot; &gt; /etc/profile.d/yii_debug.csh[/code]</p>
<p>А в Vagrantfile исправляем пару строк</p>
<p>[code]Vagrant.configure('2') do |config|<br />
  config.vm.provision 'shell' do |s|<br />
    s.path = &quot;#{dir}/puphpet/bootstrap.sh&quot;<br />
    s.env = { YII_ENV: &quot;dev&quot;, YII_DEBUG: 1 }<br />
  end<br />
  eval File.read(&quot;#{dir}/puphpet/vagrant/Vagrantfile-#{data['target']}&quot;)<br />
end[/code]</p>
<p>Тем самым мы заставляем систему прописать нужные переменные окружения до выполнения puppet-apply.</p>
<h4>Yii2</h4>
<p>В каталоге puphpet/files/exec-once-unprivileged размещаем файл <b>00-composer.sh</b>.</p>
<p>[code lang="shell"]#!/usr/bin/env bash<br />
composer global require &quot;fxp/composer-asset-plugin:^1.3.1&quot;[/code]</p>
<p>Запустившись однократно команда установит глобально пакет, который нам нужен в дальнейшем для управления статическими пакетами. Файл empty можно удалить из текущего каталога.</p>
<p>В каталоге puphpet/files/exec-always-unprivileged разместим два файла.</p>
<p><strong>Важно: имена файлов сделаны такими не просто так. Скрипт провизии перед выполнением сортирует их в лексикографическом порядке. И очень важно, чтобы инициализация composer выполнялась после развертывания конфигурационных файлов.</strong></p>
<p><b>00-update-config.sh</b></p>
<p>[code lang="shell"]#!/usr/bin/env bash<br />
echo &quot;Deploy config files&quot;<br />
su - $USER -c &quot;cd /var/www &amp;&amp; php init --env=${YII_ENV} --overwrite=y&quot;[/code]</p>
<p><b>99-build.sh</b></p>
<p>[code lang="shell"]#!/usr/bin/env bash<br />
echo &quot;Deploy application&quot;<br />
COMPOSER=composer<br />
COMPOSER_OPT=&quot;&quot;<br />
if [ &quot;$YII_ENV&quot; = &quot;prod&quot; ]; then<br />
  COMPOSER_OPT=&quot;${COMPOSER_OPT} --no-dev&quot;<br />
fi<br />
if [ &quot;$YII_DEbUG&quot; = 1 ] || [ &quot;$YII_DEBUG&quot; = true ]; then<br />
  COMPOSER_OPT=&quot;${COMPOSER_OPT} -a&quot;<br />
fi<br />
su - $USER -c &quot;cd /var/www &amp;&amp; ${COMPOSER} install ${COMPOSER_OPT}&quot;[/code]</p>
<p><b>Примечание</b>: во время провизии машины при первом старте у пользователя vagrant набор групп только прописан. И поэтому чтобы они задействованы нужно выполнять команды под su.</p>
<p>Так как проект основывается на шаблоне <a href="https://github.com/yiisoft/yii2-app-advanced">yii2-app-advanced</a>, то просто копируем весь шаблон приложения в каталог с проектом. Конечно же папку <strong>vagrant</strong> и <strong>Vagrantfile</strong> не копируем так как они у нас уже есть.</p>
<p>Из мелких доработок шаблона:</p>
<ul>
<li>исправим в <strong>environment/index.php</strong> имена окружений на <em>dev</em> и <em>prod</em> вместо оригинальных</li>
<li>переместим файл requirements.php в каталог environments/dev/frontend/web попутно исправив в нем <em>$frameworkPath</em>. Подключение будет идти из <em>dirname(__FILE__) . '/../../vendor/yiisoft/yii2'</em></li>
<li>В файле <strong>frontend/web/.gitignore</strong> добавим <em>requirements.php</em> в список игнорируемых</li>
<li>объединить <strong>.gitignore</strong> обоих проектов (того, что сгенерировал PuPHPet и шаблона yii2</li>
</ul>
<h2>Доработка хост-системы</h2>
<p>Для того, чтобы вы смогли открывать получившийся проект в браузере нужно как-то сообщить операционной системе адрес системы с новым проектом.</p>
<p>Самый простой способ - добавить нужные записи в файл <strong>/etc/hosts</strong>.</p>
<p>[code]192.168.56.101  tdd.dev www.tdd.dev api.tdd.dev[/code]</p>
<h2>Запуск</h2>
<p><img class="alignnone size-full wp-image-1954" src="{{ site.baseurl }}/assets/images/2017/05/13-yii.png" alt="13 - yii" width="889" height="1004" /></p>
<p>На этом доработка закончена и можно делать vagrant up в каталоге проекта. После того, как система соберется вы сможете попасть на готовый проект <a href="http://tdd.dev">http://tdd.dev</a>.</p>
<p><img class="alignnone size-full wp-image-1956" src="{{ site.baseurl }}/assets/images/2017/05/14-requirements.png" alt="14 - requirements" width="889" height="2012" /></p>
<p>Чтобы проверить, что все в порядке в dev-режиме предусмотрен скрипт requirements.php. Обратиться к нему можно по адресу <a href="http://tdd.dev/requirements.php">http://tdd.dev/requirements.php</a> и убедиться, что все работает и поиграться с виртуальной машиной.</p>
<h2>Литература</h2>
<ol>
<li><a href="http://codingbee.net/tutorials/puppet/puppet-facts">Puppet – Facts</a></li>
<li><a href="https://docs.puppet.com/facter/3.6/custom_facts.html">Puppet: Custom facts walkthrough</a></li>
<li><a href="https://confluence.jetbrains.com/display/PhpStorm/Working+with+Advanced+Vagrant+features+in+PhpStorm">Working with Advanced Vagrant features in PhpStorm</a></li>
<li><a href="http://www.ozon.ru/context/detail/id/138584016/?partner=russianpenguin&amp;from=bar">"Learning Puppet 4: A Guide to Configuration Management and Automation" Jo Rhett, ISBN: 9781491907665</a></li>
</ol>
<h2>Исходный код</h2>
<ul>
<li><a href="https://github.com/RussianPenguin/TDD_yii2_app/releases/tag/v0.0.1">Исходный код проекта для четвертой части на GitHub</a></li>
</ul>
<h2><a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/">Оглавление</a></h2>
