<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Redis: как скопировать базу без простоя проекта | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Redis: как скопировать базу без простоя проекта" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ага. У нас проблемы: нам нужно переехать сервер редиса без даунтайма проекта. Но нам надо не только переехать, но еще и данные сохранить. Чаще всего предлагается решение в виде остановки проекта, копирования базы в новый инстанс, его запуск, переключение проекта и другие танцы. Существует даже команда migrate, которая гарантирует атомарное копирование ключей и данных. Но она работает в рамках одной бд (а по дефолту у редиса их целых 16), а так же обладает рядом негативных последствий ввиду своей атомарности. Поэтому подходит она совершенно для других целей. Сразу на ум приходят репликации :) А данное решение их умеет. Допустим у нас два сервера (у меня они на портах 6379 и 6479 соответственно). И нам нужно переключить проект с первого на второй сервер. Второй нулевой только что поднятый. А с первым ведется работа. Посмотрим, что в каждой из баз покажет команда keys \* Основной редис Новый редис Как видим пока базы не синхронизированы. Теперь нужно сделать новую базу репликой старой \&gt; slaveof 127.0.0.1 6379 OK \&gt; info ... role:slave master\_host:127.0.0.1 master\_port:6379 master\_link\_status:up master\_last\_io\_seconds\_ago:1 master\_sync\_in\_progress:0 Дополнительно может потребоваться авторизоваться на мастере чтобы началась репликация config set masterauth \&lt;password\&gt; После этого можем опять посмотреть, что в базу скопировалось keys \* Как видим: все данные успешно засинхронизировались (вполне возможно это займет продолжительное время ввиду объема данных). После того, как репликация завершена нам нужно сделать две вещи: превратить слейва в мастер настроить приложение на работу с новым мастером slaveof no one Эта команда выключает копирование данных с мастера (но не удаляет их) и теперь уже дело за настройкой приложения. Да. Небольшой даунтайм все же был (секунд 10-15), но это гораздо лучше, чем предлагаемые решения. Однако, обратите внимание, что если вы активно пишете в редис, то при такой миграции баз часть данных можно и потерять. Почитать про репликации." />
<meta property="og:description" content="Ага. У нас проблемы: нам нужно переехать сервер редиса без даунтайма проекта. Но нам надо не только переехать, но еще и данные сохранить. Чаще всего предлагается решение в виде остановки проекта, копирования базы в новый инстанс, его запуск, переключение проекта и другие танцы. Существует даже команда migrate, которая гарантирует атомарное копирование ключей и данных. Но она работает в рамках одной бд (а по дефолту у редиса их целых 16), а так же обладает рядом негативных последствий ввиду своей атомарности. Поэтому подходит она совершенно для других целей. Сразу на ум приходят репликации :) А данное решение их умеет. Допустим у нас два сервера (у меня они на портах 6379 и 6479 соответственно). И нам нужно переключить проект с первого на второй сервер. Второй нулевой только что поднятый. А с первым ведется работа. Посмотрим, что в каждой из баз покажет команда keys \* Основной редис Новый редис Как видим пока базы не синхронизированы. Теперь нужно сделать новую базу репликой старой \&gt; slaveof 127.0.0.1 6379 OK \&gt; info ... role:slave master\_host:127.0.0.1 master\_port:6379 master\_link\_status:up master\_last\_io\_seconds\_ago:1 master\_sync\_in\_progress:0 Дополнительно может потребоваться авторизоваться на мастере чтобы началась репликация config set masterauth \&lt;password\&gt; После этого можем опять посмотреть, что в базу скопировалось keys \* Как видим: все данные успешно засинхронизировались (вполне возможно это займет продолжительное время ввиду объема данных). После того, как репликация завершена нам нужно сделать две вещи: превратить слейва в мастер настроить приложение на работу с новым мастером slaveof no one Эта команда выключает копирование данных с мастера (но не удаляет их) и теперь уже дело за настройкой приложения. Да. Небольшой даунтайм все же был (секунд 10-15), но это гораздо лучше, чем предлагаемые решения. Однако, обратите внимание, что если вы активно пишете в редис, то при такой миграции баз часть данных можно и потерять. Почитать про репликации." />
<link rel="canonical" href="http://localhost:4000/2016/02/24/redis-%D0%BA%D0%B0%D0%BA-%D1%81%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D0%B1%D0%B0%D0%B7%D1%83-%D0%B1%D0%B5%D0%B7-%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D1%8F-%D0%BF%D1%80%D0%BE/" />
<meta property="og:url" content="http://localhost:4000/2016/02/24/redis-%D0%BA%D0%B0%D0%BA-%D1%81%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D0%B1%D0%B0%D0%B7%D1%83-%D0%B1%D0%B5%D0%B7-%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D1%8F-%D0%BF%D1%80%D0%BE/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-02-24T21:04:12+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Redis: как скопировать базу без простоя проекта" />
<script type="application/ld+json">
{"headline":"Redis: как скопировать базу без простоя проекта","dateModified":"2016-02-24T21:04:12+03:00","datePublished":"2016-02-24T21:04:12+03:00","description":"Ага. У нас проблемы: нам нужно переехать сервер редиса без даунтайма проекта. Но нам надо не только переехать, но еще и данные сохранить. Чаще всего предлагается решение в виде остановки проекта, копирования базы в новый инстанс, его запуск, переключение проекта и другие танцы. Существует даже команда migrate, которая гарантирует атомарное копирование ключей и данных. Но она работает в рамках одной бд (а по дефолту у редиса их целых 16), а так же обладает рядом негативных последствий ввиду своей атомарности. Поэтому подходит она совершенно для других целей. Сразу на ум приходят репликации :) А данное решение их умеет. Допустим у нас два сервера (у меня они на портах 6379 и 6479 соответственно). И нам нужно переключить проект с первого на второй сервер. Второй нулевой только что поднятый. А с первым ведется работа. Посмотрим, что в каждой из баз покажет команда keys \\* Основной редис Новый редис Как видим пока базы не синхронизированы. Теперь нужно сделать новую базу репликой старой \\&gt; slaveof 127.0.0.1 6379 OK \\&gt; info ... role:slave master\\_host:127.0.0.1 master\\_port:6379 master\\_link\\_status:up master\\_last\\_io\\_seconds\\_ago:1 master\\_sync\\_in\\_progress:0 Дополнительно может потребоваться авторизоваться на мастере чтобы началась репликация config set masterauth \\&lt;password\\&gt; После этого можем опять посмотреть, что в базу скопировалось keys \\* Как видим: все данные успешно засинхронизировались (вполне возможно это займет продолжительное время ввиду объема данных). После того, как репликация завершена нам нужно сделать две вещи: превратить слейва в мастер настроить приложение на работу с новым мастером slaveof no one Эта команда выключает копирование данных с мастера (но не удаляет их) и теперь уже дело за настройкой приложения. Да. Небольшой даунтайм все же был (секунд 10-15), но это гораздо лучше, чем предлагаемые решения. Однако, обратите внимание, что если вы активно пишете в редис, то при такой миграции баз часть данных можно и потерять. Почитать про репликации.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/02/24/redis-%D0%BA%D0%B0%D0%BA-%D1%81%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D0%B1%D0%B0%D0%B7%D1%83-%D0%B1%D0%B5%D0%B7-%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D1%8F-%D0%BF%D1%80%D0%BE/"},"@type":"BlogPosting","url":"http://localhost:4000/2016/02/24/redis-%D0%BA%D0%B0%D0%BA-%D1%81%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D0%B1%D0%B0%D0%B7%D1%83-%D0%B1%D0%B5%D0%B7-%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D1%8F-%D0%BF%D1%80%D0%BE/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Redis: как скопировать базу без простоя проекта</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Redis: как скопировать базу без простоя проекта</h1>
<p>24 Feb 2016</p>

<p><img src="/assets/images/2016/02/redis.png?w=150" alt="redis" />Ага. У нас проблемы: нам нужно переехать сервер редиса без даунтайма проекта. Но нам надо не только переехать, но еще и данные сохранить.</p>

<p>Чаще всего предлагается решение в виде остановки проекта, копирования базы в новый инстанс, его запуск, переключение проекта и другие танцы.</p>

<p>Существует даже команда <a href="http://redis.io/commands/MIGRATE">migrate</a>, которая гарантирует атомарное копирование ключей и данных.</p>

<p>Но она работает в рамках одной бд (а по дефолту у редиса их целых 16), а так же обладает рядом негативных последствий ввиду своей атомарности. Поэтому подходит она совершенно для других целей.</p>

<p>Сразу на ум приходят репликации :) А данное решение их умеет.</p>

<p>Допустим у нас два сервера (у меня они на портах 6379 и 6479 соответственно). И нам нужно переключить проект с первого на второй сервер. Второй нулевой только что поднятый. А с первым ведется работа.</p>

<p><img src="/assets/images/2016/02/2016-02-24-202827_805x48.png" alt="2016-02-24-20:28:27_805x48" /></p>

<p>Посмотрим, что в каждой из баз покажет команда</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keys \*
</code></pre></div></div>

<p>Основной редис</p>

<p><img src="/assets/images/2016/02/2016-02-24-202930_482x426.png" alt="2016-02-24-20:29:30_482x426" /></p>

<p>Новый редис</p>

<p><img src="/assets/images/2016/02/2016-02-24-202947_190x32.png" alt="2016-02-24-20:29:47_190x32" /></p>

<p>Как видим пока базы не синхронизированы.</p>

<p>Теперь нужно сделать новую базу репликой старой</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\&gt; slaveof 127.0.0.1 6379  
OK  
\&gt; info  
...  
role:slave  
master\_host:127.0.0.1  
master\_port:6379  
master\_link\_status:up  
master\_last\_io\_seconds\_ago:1  
master\_sync\_in\_progress:0
</code></pre></div></div>

<p>Дополнительно может потребоваться авторизоваться на мастере чтобы началась репликация</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config set masterauth \&lt;password\&gt;
</code></pre></div></div>

<p>После этого можем опять посмотреть, что в базу скопировалось</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keys \*
</code></pre></div></div>

<p><img src="/assets/images/2016/02/2016-02-24-210018_441x414.png" alt="2016-02-24-21:00:18_441x414" /></p>

<p>Как видим: все данные успешно засинхронизировались (вполне возможно это займет продолжительное время ввиду объема данных).</p>

<p>После того, как репликация завершена нам нужно сделать две вещи:</p>

<ul>
  <li>превратить слейва в мастер</li>
  <li>настроить приложение на работу с новым мастером</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>slaveof no one
</code></pre></div></div>

<p>Эта команда выключает копирование данных с мастера (но не удаляет их) и теперь уже дело за настройкой приложения.</p>

<p>Да. Небольшой даунтайм все же был (секунд 10-15), но это гораздо лучше, чем предлагаемые решения.</p>

<p>Однако, обратите внимание, что если вы активно пишете в редис, то при такой миграции баз часть данных можно и потерять.</p>

<p><a href="http://redis.io/topics/replication">Почитать про репликации</a>.</p>




      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
