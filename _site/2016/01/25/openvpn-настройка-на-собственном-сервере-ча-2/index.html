<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты. | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты." />
<meta property="og:locale" content="en_US" />
<meta name="description" content="  OpenVPN: Настройка на собственном сервере. Часть 0 — подготовка системы. OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты. OpenVPN: Настройка на собственном сервере. Часть 2 — конфигурация сервера. OpenVPN: Настройка на собственном сервере. Часть 3 — iptables OpenVPN: Настройка на собственном сервере. Часть 4 — конфигурация клиента.   Первоначальная настройка успешно завершена и нам необходимо позаботится о безопасности. Т.е. о сертификатах, с которыми будут работать клиенты и сервер. Для этого нужно три компонента: Корневой сертификат (назовем его для простоты CA), которым будут подписываться ключи клиента и сервере. Крайне желательно чтобы он был на отдельной машине. Сертификат сервера, который будет подписан корневым доверительным сертификатом. Сертификат для каждого из клиентов, который тай жэ будет подписан CA Корневой сертификат и сертификат сервера Создаем корневой центр собственной сертификации (лучше делать это не на той машине, где запуен openvpn и там должен быть установлен пакет easy-rsa) $ cp -R /usr/share/easy-rsa/3.0.0/ ~/CA $ cp /usr/share/doc/easy-rsa/vars.example ~/CA/vars $ cd ~/CA Нужно отредактировать vars и поправить те параметры, которые будут вам интересны. Это имя домена, имя сервера и прочее - все подробно прокомментировано в файле. Инициализировать PKI (Public Key Infrastructure — Инфраструктура открытых ключей): $ ./easyrsa init-pki Создать корневой сертификат. Common Name сервера вводить на ваше успотрение. (лучше придумать что-то вроде vpn-server). Сложный пароль ключа обязателе. Не менее 128 бит. $ ./easyrsa build-ca Создать ключи Диффи-Хелмана $ ./easyrsa gen-dh Создать запрос на сертификат для сервера OVPN. Обращаю внимание, что сертификат будет незапаролен (параметр nopass), иначе при каждом старте OpenVPN будет запрашивать этот пароль. $ ./easyrsa gen-req vpn-server nopass Создать и подписать сертификат $ ./easyrsa sign-req server vpn-server Скопировать полученные ключи в рабочий каталог openvpn $ sudo mkdir -p /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/ca.crt /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/issued/vpn-server.crt /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/private/vpn-server.key /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/dh.pem /etc/openvpn/keys Создать «HMAC firewall» для защиты от DoS аттак и флуда UDP порта. $ cd /etc/openvpn/keys/ $ sudo openvpn --genkey --secret ta.key Генерация пользовательских ключей Создание запроса запароленного ключа для клиента (потребуется вводить при каждом подключении) с именем User $ cd ~/CA $ ./easyrsa gen-req User User - это имя пользователя для которого вы генерируете ключ. При такой генерации при каждом подключении будет запрашиваться пароль. Если вам не требуется такого уровня. Или авторизация будет осуществляться иными методами, то генерируйте ключ без пароля. $ ./easyrsa gen-req User nopass Теперь ключ надо подписать $ ./easyrsa sign-req client User Дефолтно ключ выдается на 10 лет. Можно ограничить время. И ключи придется только перевыпускать по завершению работы. $./easyrsa sign-req client User -days 90 Клиенту потребуется следующий набор файлов ~/CA/pki/issued/User.crt ~/CA/pki/private/User.key ~/CA/pki/ca.crt /etc/openvpn/keys/ta.key Отзывы сертификатов Герируем файл отозванных ключей $ cd ~/CA $ ./easyrsa gen-crl Если вы все же сделали центр сертификации на той же машине, на которой у вас сервер, то можете слинковать файл отозванных ключей. Но лучше скопировать. И эту операцию нужно повторять каждый раз при отзыве ключей. $ sudo cp ~/CA/pki/crl.pem /etc/openvpn/keys В /etc/openvpn/server.conf добавить строку crl-verify /etc/openvpn/keys/crl.pem Отзыв сертификата пользователя User $ ./easyrsa revoke User Каждый раз при отзыве сертификата необходимо обновлять crl.pem, чтобы внести в него изменения $ ./easyrsa gen-crl Примечание: одноименный файл ключа не может быть создан пока не отозван старый. При попытке создать сертификат с уже имеющимся именем выдаст ошибку failed to update database Easy-RSA error: signing failed (openssl output above may have more detail) Для исключения возможности mitm атаки, ошибка которого так выглядит в логах клиента как показано ниже служит параметр remote-cert-tls server в конфиге клиента. WARNING: No server certificate verification method has been enabled. See http://openvpn.net/howto.html#mitm for more info. Ссылки: https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts http://notessysadmin.com/quickstart-openvpn-server https://wiki.archlinux.org/index.php/OpenVPN" />
<meta property="og:description" content="  OpenVPN: Настройка на собственном сервере. Часть 0 — подготовка системы. OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты. OpenVPN: Настройка на собственном сервере. Часть 2 — конфигурация сервера. OpenVPN: Настройка на собственном сервере. Часть 3 — iptables OpenVPN: Настройка на собственном сервере. Часть 4 — конфигурация клиента.   Первоначальная настройка успешно завершена и нам необходимо позаботится о безопасности. Т.е. о сертификатах, с которыми будут работать клиенты и сервер. Для этого нужно три компонента: Корневой сертификат (назовем его для простоты CA), которым будут подписываться ключи клиента и сервере. Крайне желательно чтобы он был на отдельной машине. Сертификат сервера, который будет подписан корневым доверительным сертификатом. Сертификат для каждого из клиентов, который тай жэ будет подписан CA Корневой сертификат и сертификат сервера Создаем корневой центр собственной сертификации (лучше делать это не на той машине, где запуен openvpn и там должен быть установлен пакет easy-rsa) $ cp -R /usr/share/easy-rsa/3.0.0/ ~/CA $ cp /usr/share/doc/easy-rsa/vars.example ~/CA/vars $ cd ~/CA Нужно отредактировать vars и поправить те параметры, которые будут вам интересны. Это имя домена, имя сервера и прочее - все подробно прокомментировано в файле. Инициализировать PKI (Public Key Infrastructure — Инфраструктура открытых ключей): $ ./easyrsa init-pki Создать корневой сертификат. Common Name сервера вводить на ваше успотрение. (лучше придумать что-то вроде vpn-server). Сложный пароль ключа обязателе. Не менее 128 бит. $ ./easyrsa build-ca Создать ключи Диффи-Хелмана $ ./easyrsa gen-dh Создать запрос на сертификат для сервера OVPN. Обращаю внимание, что сертификат будет незапаролен (параметр nopass), иначе при каждом старте OpenVPN будет запрашивать этот пароль. $ ./easyrsa gen-req vpn-server nopass Создать и подписать сертификат $ ./easyrsa sign-req server vpn-server Скопировать полученные ключи в рабочий каталог openvpn $ sudo mkdir -p /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/ca.crt /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/issued/vpn-server.crt /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/private/vpn-server.key /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/dh.pem /etc/openvpn/keys Создать «HMAC firewall» для защиты от DoS аттак и флуда UDP порта. $ cd /etc/openvpn/keys/ $ sudo openvpn --genkey --secret ta.key Генерация пользовательских ключей Создание запроса запароленного ключа для клиента (потребуется вводить при каждом подключении) с именем User $ cd ~/CA $ ./easyrsa gen-req User User - это имя пользователя для которого вы генерируете ключ. При такой генерации при каждом подключении будет запрашиваться пароль. Если вам не требуется такого уровня. Или авторизация будет осуществляться иными методами, то генерируйте ключ без пароля. $ ./easyrsa gen-req User nopass Теперь ключ надо подписать $ ./easyrsa sign-req client User Дефолтно ключ выдается на 10 лет. Можно ограничить время. И ключи придется только перевыпускать по завершению работы. $./easyrsa sign-req client User -days 90 Клиенту потребуется следующий набор файлов ~/CA/pki/issued/User.crt ~/CA/pki/private/User.key ~/CA/pki/ca.crt /etc/openvpn/keys/ta.key Отзывы сертификатов Герируем файл отозванных ключей $ cd ~/CA $ ./easyrsa gen-crl Если вы все же сделали центр сертификации на той же машине, на которой у вас сервер, то можете слинковать файл отозванных ключей. Но лучше скопировать. И эту операцию нужно повторять каждый раз при отзыве ключей. $ sudo cp ~/CA/pki/crl.pem /etc/openvpn/keys В /etc/openvpn/server.conf добавить строку crl-verify /etc/openvpn/keys/crl.pem Отзыв сертификата пользователя User $ ./easyrsa revoke User Каждый раз при отзыве сертификата необходимо обновлять crl.pem, чтобы внести в него изменения $ ./easyrsa gen-crl Примечание: одноименный файл ключа не может быть создан пока не отозван старый. При попытке создать сертификат с уже имеющимся именем выдаст ошибку failed to update database Easy-RSA error: signing failed (openssl output above may have more detail) Для исключения возможности mitm атаки, ошибка которого так выглядит в логах клиента как показано ниже служит параметр remote-cert-tls server в конфиге клиента. WARNING: No server certificate verification method has been enabled. See http://openvpn.net/howto.html#mitm for more info. Ссылки: https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts http://notessysadmin.com/quickstart-openvpn-server https://wiki.archlinux.org/index.php/OpenVPN" />
<link rel="canonical" href="http://localhost:4000/2016/01/25/openvpn-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B5-%D1%87%D0%B0-2/" />
<meta property="og:url" content="http://localhost:4000/2016/01/25/openvpn-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B5-%D1%87%D0%B0-2/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-01-25T20:57:44+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты." />
<script type="application/ld+json">
{"headline":"OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты.","dateModified":"2016-01-25T20:57:44+03:00","datePublished":"2016-01-25T20:57:44+03:00","description":"  OpenVPN: Настройка на собственном сервере. Часть 0 — подготовка системы. OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты. OpenVPN: Настройка на собственном сервере. Часть 2 — конфигурация сервера. OpenVPN: Настройка на собственном сервере. Часть 3 — iptables OpenVPN: Настройка на собственном сервере. Часть 4 — конфигурация клиента.   Первоначальная настройка успешно завершена и нам необходимо позаботится о безопасности. Т.е. о сертификатах, с которыми будут работать клиенты и сервер. Для этого нужно три компонента: Корневой сертификат (назовем его для простоты CA), которым будут подписываться ключи клиента и сервере. Крайне желательно чтобы он был на отдельной машине. Сертификат сервера, который будет подписан корневым доверительным сертификатом. Сертификат для каждого из клиентов, который тай жэ будет подписан CA Корневой сертификат и сертификат сервера Создаем корневой центр собственной сертификации (лучше делать это не на той машине, где запуен openvpn и там должен быть установлен пакет easy-rsa) $ cp -R /usr/share/easy-rsa/3.0.0/ ~/CA $ cp /usr/share/doc/easy-rsa/vars.example ~/CA/vars $ cd ~/CA Нужно отредактировать vars и поправить те параметры, которые будут вам интересны. Это имя домена, имя сервера и прочее - все подробно прокомментировано в файле. Инициализировать PKI (Public Key Infrastructure — Инфраструктура открытых ключей): $ ./easyrsa init-pki Создать корневой сертификат. Common Name сервера вводить на ваше успотрение. (лучше придумать что-то вроде vpn-server). Сложный пароль ключа обязателе. Не менее 128 бит. $ ./easyrsa build-ca Создать ключи Диффи-Хелмана $ ./easyrsa gen-dh Создать запрос на сертификат для сервера OVPN. Обращаю внимание, что сертификат будет незапаролен (параметр nopass), иначе при каждом старте OpenVPN будет запрашивать этот пароль. $ ./easyrsa gen-req vpn-server nopass Создать и подписать сертификат $ ./easyrsa sign-req server vpn-server Скопировать полученные ключи в рабочий каталог openvpn $ sudo mkdir -p /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/ca.crt /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/issued/vpn-server.crt /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/private/vpn-server.key /etc/openvpn/keys $ sudo mkdir cp ~/CA/pki/dh.pem /etc/openvpn/keys Создать «HMAC firewall» для защиты от DoS аттак и флуда UDP порта. $ cd /etc/openvpn/keys/ $ sudo openvpn --genkey --secret ta.key Генерация пользовательских ключей Создание запроса запароленного ключа для клиента (потребуется вводить при каждом подключении) с именем User $ cd ~/CA $ ./easyrsa gen-req User User - это имя пользователя для которого вы генерируете ключ. При такой генерации при каждом подключении будет запрашиваться пароль. Если вам не требуется такого уровня. Или авторизация будет осуществляться иными методами, то генерируйте ключ без пароля. $ ./easyrsa gen-req User nopass Теперь ключ надо подписать $ ./easyrsa sign-req client User Дефолтно ключ выдается на 10 лет. Можно ограничить время. И ключи придется только перевыпускать по завершению работы. $./easyrsa sign-req client User -days 90 Клиенту потребуется следующий набор файлов ~/CA/pki/issued/User.crt ~/CA/pki/private/User.key ~/CA/pki/ca.crt /etc/openvpn/keys/ta.key Отзывы сертификатов Герируем файл отозванных ключей $ cd ~/CA $ ./easyrsa gen-crl Если вы все же сделали центр сертификации на той же машине, на которой у вас сервер, то можете слинковать файл отозванных ключей. Но лучше скопировать. И эту операцию нужно повторять каждый раз при отзыве ключей. $ sudo cp ~/CA/pki/crl.pem /etc/openvpn/keys В /etc/openvpn/server.conf добавить строку crl-verify /etc/openvpn/keys/crl.pem Отзыв сертификата пользователя User $ ./easyrsa revoke User Каждый раз при отзыве сертификата необходимо обновлять crl.pem, чтобы внести в него изменения $ ./easyrsa gen-crl Примечание: одноименный файл ключа не может быть создан пока не отозван старый. При попытке создать сертификат с уже имеющимся именем выдаст ошибку failed to update database Easy-RSA error: signing failed (openssl output above may have more detail) Для исключения возможности mitm атаки, ошибка которого так выглядит в логах клиента как показано ниже служит параметр remote-cert-tls server в конфиге клиента. WARNING: No server certificate verification method has been enabled. See http://openvpn.net/howto.html#mitm for more info. Ссылки: https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts http://notessysadmin.com/quickstart-openvpn-server https://wiki.archlinux.org/index.php/OpenVPN","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/01/25/openvpn-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B5-%D1%87%D0%B0-2/"},"@type":"BlogPosting","url":"http://localhost:4000/2016/01/25/openvpn-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B5-%D1%87%D0%B0-2/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты.</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты.</h1>
<p>25 Jan 2016</p>

<p> </p>

<ul>
  <li><a href="http://russianpenguin.ru/2016/01/24/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0/">OpenVPN: Настройка на собственном сервере. Часть 0 — подготовка системы.</a></li>
  <li>OpenVPN: Настройка на собственном сервере. Часть 1 — сертификаты.</li>
  <li><a href="http://russianpenguin.ru/2016/01/26/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-3/">OpenVPN: Настройка на собственном сервере. Часть 2 — конфигурация сервера.</a></li>
  <li><a href="http://russianpenguin.ru/2016/01/27/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-4/">OpenVPN: Настройка на собственном сервере. Часть 3 — iptables</a></li>
  <li><a href="http://russianpenguin.ru/2016/01/28/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0-5/">OpenVPN: Настройка на собственном сервере. Часть 4 — конфигурация клиента.</a></li>
</ul>

<p> </p>

<p><a href="http://russianpenguin.ru/2016/01/24/openvpn-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%bd%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%bc-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b5-%d1%87%d0%b0/">Первоначальная</a> настройка успешно завершена и нам необходимо позаботится о безопасности. Т.е. о сертификатах, с которыми будут работать клиенты и сервер.</p>

<p>Для этого нужно три компонента:</p>

<ul>
  <li>Корневой сертификат (назовем его для простоты CA), которым будут подписываться ключи клиента и сервере. Крайне желательно чтобы он был на отдельной машине.</li>
  <li>Сертификат сервера, который будет подписан корневым доверительным сертификатом.</li>
  <li>Сертификат для каждого из клиентов, который тай жэ будет подписан CA</li>
</ul>

<h2 id="корневой-сертификат-и-сертификат-сервера">Корневой сертификат и сертификат сервера</h2>

<p>Создаем корневой центр собственной сертификации (лучше делать это не на той машине, где запуен openvpn и там должен быть установлен пакет easy-rsa)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp -R /usr/share/easy-rsa/3.0.0/ ~/CA  
$ cp /usr/share/doc/easy-rsa/vars.example ~/CA/vars  
$ cd ~/CA
</code></pre></div></div>

<p>Нужно отредактировать vars и поправить те параметры, которые будут вам интересны. Это имя домена, имя сервера и прочее - все подробно прокомментировано в файле.</p>

<p>Инициализировать PKI (Public Key Infrastructure — Инфраструктура открытых ключей):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa init-pki
</code></pre></div></div>

<p>Создать корневой сертификат. Common Name сервера вводить на ваше успотрение. (лучше придумать что-то вроде vpn-server). Сложный пароль ключа обязателе. Не менее 128 бит.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa build-ca
</code></pre></div></div>

<p>Создать ключи Диффи-Хелмана</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa gen-dh
</code></pre></div></div>

<p>Создать запрос на сертификат для сервера OVPN. Обращаю внимание, что сертификат будет незапаролен (параметр nopass), иначе при каждом старте OpenVPN будет запрашивать этот пароль.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa gen-req vpn-server nopass
</code></pre></div></div>

<p>Создать и подписать сертификат</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa sign-req server vpn-server
</code></pre></div></div>

<p>Скопировать полученные ключи в рабочий каталог openvpn</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkdir -p /etc/openvpn/keys  
$ sudo mkdir cp ~/CA/pki/ca.crt /etc/openvpn/keys  
$ sudo mkdir cp ~/CA/pki/issued/vpn-server.crt /etc/openvpn/keys  
$ sudo mkdir cp ~/CA/pki/private/vpn-server.key /etc/openvpn/keys  
$ sudo mkdir cp ~/CA/pki/dh.pem /etc/openvpn/keys
</code></pre></div></div>

<p>Создать «HMAC firewall» для защиты от DoS аттак и флуда UDP порта.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /etc/openvpn/keys/  
$ sudo openvpn --genkey --secret ta.key
</code></pre></div></div>

<h2 id="генерация-пользовательских-ключей">Генерация пользовательских ключей</h2>

<p>Создание запроса запароленного ключа для клиента (потребуется вводить при каждом подключении) с именем User</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd ~/CA  
$ ./easyrsa gen-req User
</code></pre></div></div>

<p>User - это имя пользователя для которого вы генерируете ключ.</p>

<p>При такой генерации при каждом подключении будет запрашиваться пароль.</p>

<p>Если вам не требуется такого уровня. Или авторизация будет осуществляться иными методами, то генерируйте ключ без пароля.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa gen-req User nopass
</code></pre></div></div>

<p>Теперь ключ надо подписать</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa sign-req client User
</code></pre></div></div>

<p>Дефолтно ключ выдается на 10 лет. Можно ограничить время. И ключи придется только перевыпускать по завершению работы.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$./easyrsa sign-req client User -days 90
</code></pre></div></div>

<p>Клиенту потребуется следующий набор файлов</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ~/CA/pki/issued/User.crt  
 ~/CA/pki/private/User.key  
 ~/CA/pki/ca.crt  
 /etc/openvpn/keys/ta.key
</code></pre></div></div>

<h2 id="отзывы-сертификатов">Отзывы сертификатов</h2>

<p>Герируем файл отозванных ключей</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd ~/CA  
$ ./easyrsa gen-crl
</code></pre></div></div>

<p>Если вы все же сделали центр сертификации на той же машине, на которой у вас сервер, то можете слинковать файл отозванных ключей. Но лучше скопировать. И эту операцию нужно повторять каждый раз при отзыве ключей.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cp ~/CA/pki/crl.pem /etc/openvpn/keys
</code></pre></div></div>

<p>В /etc/openvpn/server.conf добавить строку</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crl-verify /etc/openvpn/keys/crl.pem
</code></pre></div></div>

<p>Отзыв сертификата пользователя User</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa revoke User
</code></pre></div></div>

<p>Каждый раз при отзыве сертификата необходимо обновлять crl.pem, чтобы внести в него изменения</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./easyrsa gen-crl
</code></pre></div></div>

<p>Примечание: одноименный файл ключа не может быть создан пока не отозван старый. При попытке создать сертификат с уже имеющимся именем выдаст ошибку</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>failed to update database  
Easy-RSA error:  
signing failed (openssl output above may have more detail)
</code></pre></div></div>

<p>Для исключения возможности mitm атаки, ошибка которого так выглядит в логах клиента как показано ниже служит параметр remote-cert-tls server в конфиге клиента.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING: No server certificate verification method has been enabled. See http://openvpn.net/howto.html#mitm for more info.
</code></pre></div></div>

<p>Ссылки:</p>

<ul>
  <li><a href="https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts">https://wiki.archlinux.org/index.php/Create_a_Public_Key_Infrastructure_Using_the_easy-rsa_Scripts</a></li>
  <li><a href="http://notessysadmin.com/quickstart-openvpn-server">http://notessysadmin.com/quickstart-openvpn-server</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/OpenVPN">https://wiki.archlinux.org/index.php/OpenVPN</a></li>
</ul>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
