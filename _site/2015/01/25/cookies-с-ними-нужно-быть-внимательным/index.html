<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Cookies: с ними нужно быть внимательным | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Cookies: с ними нужно быть внимательным" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Однажды на проекте случлось странное с функционалом. Выясняя причину наткнулся на очень много кода, который работает с кукисами. Но вот только работает код неправильно. Вообще чем кукиса характеризуется: имя значение путь время истечения домен секурность Здесь и далее нас будет интересовать домен, поскольку именно он является причиной множества странный и часто трудноуловимых багов. Возьмем пример https://github.com/RussianPenguin/blogSamples/blob/master/cookies.php и запустим его на локальном сервере пхп (примем за аксиому то, что у нас домен localhost.localdomain резолвится на локалхост). Теперь зайдем в браузер по нашему скрипту Видно, что скрипт выставляет две кукисы для одного и того же домена. Стандарт предписывает, что кукиса с точкой перед именем домена и без точки доступна в пределах всех поддоменов, а точка оставлена лишь для совместимости с более ранними браузерами. Казалось бы, мы ставим кукисы на одном и том же домене. Кстати, вот код: // Конфигурация (домен на котором запускаем) $domain = &#39;localhost.localdomain&#39;; $cookieName = &#39;test&#39;; setcookie($cookieName, &#39;empty host&#39;, 3600+time(), &#39;/&#39;); setcookie($cookieName, &#39;host: &#39; . $domain, 3600+time(), &#39;/&#39;, $domain); тут я оставил конфигурацию домена руками так как запуск сервера идет на нестандартном порту. Так вот. Думалось, что браузер должен поставить одну печеньку и в ней должно быть значение, которое передано последним. Но нет. Если хидер установки кукиса содержит домен, то кукису будет присвоено имя домена с точкой в начале. А если имени домена не указывать, то кукис будет поставлен на текущий домен без точки в начале. И когда мы попытаемся считать на стороне клиента (или сервера) наш поставленый кукис, то какой из них вернется - это уже немного рандом (хотя нет, все зависит от того, в какой последовательности печеньки ставились). И то же самое происходит на клиенте: если мы при установки кукиса указываем домен, то браузер поставит кукис на домен с точкой в начале, а если не укажем, то без точки. Попробуем прописать в тестовом скрипте какое-то значение для печеньки, но не указывать домен. А потом нажмем кнопку “поставить кукис”. Что мы видим? А видим мы то, что браузер считал значение для текущего домена (первое) и перезаписал его новым. Которое мы выбрали. А второй кукис до перезагрузки остался нетронутым. Круто. А значит нажмем “прочитать печеньку” и увидим наше новое значение. Однако если мы так думаем, то ошибаемся. Даже FireCookie что-то показывает - это не значит, что значение печенья поменялось. Огнелись ничего не поставил. Но как только мы домен укажем при установке Так сразу все работает как надо - устанавливается значение и при нажатии на кнопку “прочитать” мы его получаем. Так вот. Это я о том, что в проекте нельзя смешивать подходы установки мучных изделий. Это приводит к тому, что много-много времени можно угробить в поисках ошибки, которой нет. Учтите, что если вы заходите повторить этот эксперимент, то на доменах верхнего уровня подобное не работает. Т.е. если мы будем использовать localhost, то подобное поведение не воспроизведется." />
<meta property="og:description" content="Однажды на проекте случлось странное с функционалом. Выясняя причину наткнулся на очень много кода, который работает с кукисами. Но вот только работает код неправильно. Вообще чем кукиса характеризуется: имя значение путь время истечения домен секурность Здесь и далее нас будет интересовать домен, поскольку именно он является причиной множества странный и часто трудноуловимых багов. Возьмем пример https://github.com/RussianPenguin/blogSamples/blob/master/cookies.php и запустим его на локальном сервере пхп (примем за аксиому то, что у нас домен localhost.localdomain резолвится на локалхост). Теперь зайдем в браузер по нашему скрипту Видно, что скрипт выставляет две кукисы для одного и того же домена. Стандарт предписывает, что кукиса с точкой перед именем домена и без точки доступна в пределах всех поддоменов, а точка оставлена лишь для совместимости с более ранними браузерами. Казалось бы, мы ставим кукисы на одном и том же домене. Кстати, вот код: // Конфигурация (домен на котором запускаем) $domain = &#39;localhost.localdomain&#39;; $cookieName = &#39;test&#39;; setcookie($cookieName, &#39;empty host&#39;, 3600+time(), &#39;/&#39;); setcookie($cookieName, &#39;host: &#39; . $domain, 3600+time(), &#39;/&#39;, $domain); тут я оставил конфигурацию домена руками так как запуск сервера идет на нестандартном порту. Так вот. Думалось, что браузер должен поставить одну печеньку и в ней должно быть значение, которое передано последним. Но нет. Если хидер установки кукиса содержит домен, то кукису будет присвоено имя домена с точкой в начале. А если имени домена не указывать, то кукис будет поставлен на текущий домен без точки в начале. И когда мы попытаемся считать на стороне клиента (или сервера) наш поставленый кукис, то какой из них вернется - это уже немного рандом (хотя нет, все зависит от того, в какой последовательности печеньки ставились). И то же самое происходит на клиенте: если мы при установки кукиса указываем домен, то браузер поставит кукис на домен с точкой в начале, а если не укажем, то без точки. Попробуем прописать в тестовом скрипте какое-то значение для печеньки, но не указывать домен. А потом нажмем кнопку “поставить кукис”. Что мы видим? А видим мы то, что браузер считал значение для текущего домена (первое) и перезаписал его новым. Которое мы выбрали. А второй кукис до перезагрузки остался нетронутым. Круто. А значит нажмем “прочитать печеньку” и увидим наше новое значение. Однако если мы так думаем, то ошибаемся. Даже FireCookie что-то показывает - это не значит, что значение печенья поменялось. Огнелись ничего не поставил. Но как только мы домен укажем при установке Так сразу все работает как надо - устанавливается значение и при нажатии на кнопку “прочитать” мы его получаем. Так вот. Это я о том, что в проекте нельзя смешивать подходы установки мучных изделий. Это приводит к тому, что много-много времени можно угробить в поисках ошибки, которой нет. Учтите, что если вы заходите повторить этот эксперимент, то на доменах верхнего уровня подобное не работает. Т.е. если мы будем использовать localhost, то подобное поведение не воспроизведется." />
<link rel="canonical" href="http://localhost:4000/2015/01/25/cookies-%D1%81-%D0%BD%D0%B8%D0%BC%D0%B8-%D0%BD%D1%83%D0%B6%D0%BD%D0%BE-%D0%B1%D1%8B%D1%82%D1%8C-%D0%B2%D0%BD%D0%B8%D0%BC%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%BC/" />
<meta property="og:url" content="http://localhost:4000/2015/01/25/cookies-%D1%81-%D0%BD%D0%B8%D0%BC%D0%B8-%D0%BD%D1%83%D0%B6%D0%BD%D0%BE-%D0%B1%D1%8B%D1%82%D1%8C-%D0%B2%D0%BD%D0%B8%D0%BC%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%BC/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-25T16:40:57+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Cookies: с ними нужно быть внимательным" />
<script type="application/ld+json">
{"headline":"Cookies: с ними нужно быть внимательным","dateModified":"2015-01-25T16:40:57+03:00","datePublished":"2015-01-25T16:40:57+03:00","description":"Однажды на проекте случлось странное с функционалом. Выясняя причину наткнулся на очень много кода, который работает с кукисами. Но вот только работает код неправильно. Вообще чем кукиса характеризуется: имя значение путь время истечения домен секурность Здесь и далее нас будет интересовать домен, поскольку именно он является причиной множества странный и часто трудноуловимых багов. Возьмем пример https://github.com/RussianPenguin/blogSamples/blob/master/cookies.php и запустим его на локальном сервере пхп (примем за аксиому то, что у нас домен localhost.localdomain резолвится на локалхост). Теперь зайдем в браузер по нашему скрипту Видно, что скрипт выставляет две кукисы для одного и того же домена. Стандарт предписывает, что кукиса с точкой перед именем домена и без точки доступна в пределах всех поддоменов, а точка оставлена лишь для совместимости с более ранними браузерами. Казалось бы, мы ставим кукисы на одном и том же домене. Кстати, вот код: // Конфигурация (домен на котором запускаем) $domain = &#39;localhost.localdomain&#39;; $cookieName = &#39;test&#39;; setcookie($cookieName, &#39;empty host&#39;, 3600+time(), &#39;/&#39;); setcookie($cookieName, &#39;host: &#39; . $domain, 3600+time(), &#39;/&#39;, $domain); тут я оставил конфигурацию домена руками так как запуск сервера идет на нестандартном порту. Так вот. Думалось, что браузер должен поставить одну печеньку и в ней должно быть значение, которое передано последним. Но нет. Если хидер установки кукиса содержит домен, то кукису будет присвоено имя домена с точкой в начале. А если имени домена не указывать, то кукис будет поставлен на текущий домен без точки в начале. И когда мы попытаемся считать на стороне клиента (или сервера) наш поставленый кукис, то какой из них вернется - это уже немного рандом (хотя нет, все зависит от того, в какой последовательности печеньки ставились). И то же самое происходит на клиенте: если мы при установки кукиса указываем домен, то браузер поставит кукис на домен с точкой в начале, а если не укажем, то без точки. Попробуем прописать в тестовом скрипте какое-то значение для печеньки, но не указывать домен. А потом нажмем кнопку “поставить кукис”. Что мы видим? А видим мы то, что браузер считал значение для текущего домена (первое) и перезаписал его новым. Которое мы выбрали. А второй кукис до перезагрузки остался нетронутым. Круто. А значит нажмем “прочитать печеньку” и увидим наше новое значение. Однако если мы так думаем, то ошибаемся. Даже FireCookie что-то показывает - это не значит, что значение печенья поменялось. Огнелись ничего не поставил. Но как только мы домен укажем при установке Так сразу все работает как надо - устанавливается значение и при нажатии на кнопку “прочитать” мы его получаем. Так вот. Это я о том, что в проекте нельзя смешивать подходы установки мучных изделий. Это приводит к тому, что много-много времени можно угробить в поисках ошибки, которой нет. Учтите, что если вы заходите повторить этот эксперимент, то на доменах верхнего уровня подобное не работает. Т.е. если мы будем использовать localhost, то подобное поведение не воспроизведется.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2015/01/25/cookies-%D1%81-%D0%BD%D0%B8%D0%BC%D0%B8-%D0%BD%D1%83%D0%B6%D0%BD%D0%BE-%D0%B1%D1%8B%D1%82%D1%8C-%D0%B2%D0%BD%D0%B8%D0%BC%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%BC/"},"@type":"BlogPosting","url":"http://localhost:4000/2015/01/25/cookies-%D1%81-%D0%BD%D0%B8%D0%BC%D0%B8-%D0%BD%D1%83%D0%B6%D0%BD%D0%BE-%D0%B1%D1%8B%D1%82%D1%8C-%D0%B2%D0%BD%D0%B8%D0%BC%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%BC/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Cookies: с ними нужно быть внимательным</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Cookies: с ними нужно быть внимательным</h1>
<p>25 Jan 2015</p>

<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_163.png"><img src="/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_163.png" alt="cookies" /></a>Однажды на проекте случлось странное с функционалом. Выясняя причину наткнулся на очень много кода, который работает с кукисами. Но вот только работает код неправильно.</p>

<p>Вообще чем кукиса характеризуется:</p>

<ul>
  <li>имя</li>
  <li>значение</li>
  <li>путь</li>
  <li>время истечения</li>
  <li>домен</li>
  <li>секурность</li>
</ul>

<p>Здесь и далее нас будет интересовать домен, поскольку именно он является причиной множества странный и часто трудноуловимых багов.</p>

<p>Возьмем пример https://github.com/RussianPenguin/blogSamples/blob/master/cookies.php и запустим его на локальном сервере пхп (примем за аксиому то, что у нас домен localhost.localdomain резолвится на локалхост).</p>

<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_164.png"><img src="/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_164.png?w=300" alt="Пример cookie.php на локальном сервере" /></a>Теперь зайдем в браузер по нашему скрипту</p>

<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_165.png"><img src="/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_165.png?w=300" alt="Cookies.php в firebug" /></a>Видно, что скрипт выставляет две кукисы для одного и того же домена.</p>

<p>Стандарт предписывает, что кукиса с точкой перед именем домена и без точки доступна в пределах всех поддоменов, а точка оставлена лишь для совместимости с более ранними браузерами.</p>

<p>Казалось бы, мы ставим кукисы на одном и том же домене. Кстати, вот код:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Конфигурация (домен на котором запускаем)  </span>
<span class="nv">$domain</span> <span class="o">=</span> <span class="s1">'localhost.localdomain'</span><span class="p">;</span>  
<span class="nv">$cookieName</span> <span class="o">=</span> <span class="s1">'test'</span><span class="p">;</span>

<span class="nb">setcookie</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">,</span> <span class="s1">'empty host'</span><span class="p">,</span> <span class="mi">3600</span><span class="o">+</span><span class="nb">time</span><span class="p">(),</span> <span class="s1">'/'</span><span class="p">);</span>  
<span class="nb">setcookie</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">,</span> <span class="s1">'host: '</span> <span class="mf">.</span> <span class="nv">$domain</span><span class="p">,</span> <span class="mi">3600</span><span class="o">+</span><span class="nb">time</span><span class="p">(),</span> <span class="s1">'/'</span><span class="p">,</span> <span class="nv">$domain</span><span class="p">);</span>
</code></pre></div></div>

<p>тут я оставил конфигурацию домена руками так как запуск сервера идет на нестандартном порту.</p>

<p>Так вот. Думалось, что браузер должен поставить одну печеньку и в ней должно быть значение, которое передано последним.</p>

<p>Но нет. Если хидер установки кукиса содержит домен, то кукису будет присвоено имя домена с точкой в начале. А если имени домена не указывать, то кукис будет поставлен на текущий домен без точки в начале.</p>

<p>И когда мы попытаемся считать на стороне клиента (или сервера) наш поставленый кукис, то какой из них вернется - это уже немного рандом (хотя нет, все зависит от того, в какой последовательности печеньки ставились).</p>

<p>И то же самое происходит на клиенте: если мы при установки кукиса указываем домен, то браузер поставит кукис на домен с точкой в начале, а если не укажем, то без точки.</p>

<p>Попробуем прописать в тестовом скрипте какое-то значение для печеньки, но не указывать домен. А потом нажмем кнопку “поставить кукис”.</p>

<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_166.png"><img src="/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_166.png?w=300" alt="cookies.php после setCookie" /></a>Что мы видим? А видим мы то, что браузер считал значение для текущего домена (первое) и перезаписал его новым. Которое мы выбрали. А второй кукис до перезагрузки остался нетронутым. Круто. А значит нажмем “прочитать печеньку” и увидим наше новое значение.</p>

<p>Однако если мы так думаем, то ошибаемся.</p>

<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_167.png"><img src="/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_167.png?w=300" alt="cookies.php getCookie" /></a>Даже FireCookie что-то показывает - это не значит, что значение печенья поменялось.</p>

<p>Огнелись ничего не поставил.</p>

<p>Но как только мы домен укажем при установке</p>

<p><a href="https://russianpenguin.files.wordpress.com/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_168.png"><img src="/assets/images/2015/01/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_168.png?w=300" alt="cookie.php - правильный результат" /></a>Так сразу все работает как надо - устанавливается значение и при нажатии на кнопку “прочитать” мы его получаем.</p>

<p>Так вот. Это я о том, что в проекте нельзя смешивать подходы установки мучных изделий. Это приводит к тому, что много-много времени можно угробить в поисках ошибки, которой нет.</p>

<p>Учтите, что если вы заходите повторить этот эксперимент, то на доменах верхнего уровня подобное не работает. Т.е. если мы будем использовать localhost, то подобное поведение не воспроизведется.</p>




      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
