<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Systemd: Перезагружаем pipewire после спячки | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Systemd: Перезагружаем pipewire после спячки" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Начиная с Fedora 34 pipewire пришел на замену pulseaudio и стал довольно интересной альтернативой jackd. Так как теперь не требуется каких-либо телодвижений для того, чтобы все корректно заработало. Конечно же без проблем не обошлось. В моём случае после спячки сервер перестает видеть докстанцию со встроенной звуковухой. $ journalctl --user -u pipewire ... дек 12 01:25:28 xxx pipewire[2846]: [E][000338392.259201][alsa-pcm.c:33 spa_alsa_open()] &#39;hw:Dock,1&#39;: playback open failed: Device or resource busy дек 12 01:25:28 xxx pipewire[2850]: [E][000338392.261614][core.c:71 core_event_error()] core 0x56217c2f48e0: proxy 0x56217c42e9c0 id:72: bound:68 seq:1022 res:-16 (Device or resource busy) msg:&quot;enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed&quot; дек 12 01:25:28 xxx pipewire[2850]: [E][000338392.261651][media-session.c:1971 core_error()] error id:72 seq:1022 res:-16 (Device or resource busy): enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed ... В деве вроде бы проблему чинили, но в стейбле федоры - нет. Единственный вариант, который приходит на ум - перезагружать сервер после спячки. Делать это каждый раз руками лень. Сделаем сервис, который будет делать это за нас! Однако, не все так просто. Проблема заключается в том, что systemd от пользователя запускается как отдельный процесс и не имеет доступа к системным таргетам вроде sleep/suspend и т.п. Поэтому придется решать еще и эту проблему. Кастомный sleep.target в юзерспейсе Скрипт ~/.local/bin/sleep_mon #!/bin/bash dbus-monitor --system &quot;type=&#39;signal&#39;,interface=&#39;org.freedesktop.login1.Manager&#39;,member=PrepareForSleep&quot; | while read x; do case &quot;$x&quot; in *&quot;boolean false&quot;*) systemctl --user --no-block stop sleep.target;; *&quot;boolean true&quot;*) systemctl --user --no-block start sleep.target;; esac done Таргет ~/.config/systemd/user/sleep.target [Unit] Description=User level sleep target StopWhenUnneeded=yes Скрипт для активации таргета ~/.config/systemd/user/user-sleep.service [Unit] Description=watch for sleep signal to start sleep.target [Service] ExecStart=%h/.local/bin/sleep_mon Restart=on-failure [Install] WantedBy=default.target Активируем и запускаем новый сервис $ systemctl --user enable user-sleep.service $ systemctl --user start user-sleep.service Непосредственно сам сервис для перезапуска pipewire Создаем файл restart-pw.service по пути ~/.config/systemd/user. [Unit] Description=Restart pipewire after resume StopWhenUnneeded=true [Service] Type=oneshot RemainAfterExit=true ExecStop=/usr/bin/systemctl --no-block --user restart pipewire pipewire-pulse [Install] WantedBy=sleep.target Добавляем юнит в запускаемые. $ systemctl --user enable restart-pw.service Стартуем юнит $ systemctl --user start restart-pw.service Можно посмотреть статус $ systemctl --user status restart-pw.service Литература: Creating a Simple Systemd User Service How To Use Journalctl to View and Manipulate Systemd Logs Systemd: stop service before suspend, restart after resume Systemd user unit that depends on system unit (sleep.target)" />
<meta property="og:description" content="Начиная с Fedora 34 pipewire пришел на замену pulseaudio и стал довольно интересной альтернативой jackd. Так как теперь не требуется каких-либо телодвижений для того, чтобы все корректно заработало. Конечно же без проблем не обошлось. В моём случае после спячки сервер перестает видеть докстанцию со встроенной звуковухой. $ journalctl --user -u pipewire ... дек 12 01:25:28 xxx pipewire[2846]: [E][000338392.259201][alsa-pcm.c:33 spa_alsa_open()] &#39;hw:Dock,1&#39;: playback open failed: Device or resource busy дек 12 01:25:28 xxx pipewire[2850]: [E][000338392.261614][core.c:71 core_event_error()] core 0x56217c2f48e0: proxy 0x56217c42e9c0 id:72: bound:68 seq:1022 res:-16 (Device or resource busy) msg:&quot;enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed&quot; дек 12 01:25:28 xxx pipewire[2850]: [E][000338392.261651][media-session.c:1971 core_error()] error id:72 seq:1022 res:-16 (Device or resource busy): enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed ... В деве вроде бы проблему чинили, но в стейбле федоры - нет. Единственный вариант, который приходит на ум - перезагружать сервер после спячки. Делать это каждый раз руками лень. Сделаем сервис, который будет делать это за нас! Однако, не все так просто. Проблема заключается в том, что systemd от пользователя запускается как отдельный процесс и не имеет доступа к системным таргетам вроде sleep/suspend и т.п. Поэтому придется решать еще и эту проблему. Кастомный sleep.target в юзерспейсе Скрипт ~/.local/bin/sleep_mon #!/bin/bash dbus-monitor --system &quot;type=&#39;signal&#39;,interface=&#39;org.freedesktop.login1.Manager&#39;,member=PrepareForSleep&quot; | while read x; do case &quot;$x&quot; in *&quot;boolean false&quot;*) systemctl --user --no-block stop sleep.target;; *&quot;boolean true&quot;*) systemctl --user --no-block start sleep.target;; esac done Таргет ~/.config/systemd/user/sleep.target [Unit] Description=User level sleep target StopWhenUnneeded=yes Скрипт для активации таргета ~/.config/systemd/user/user-sleep.service [Unit] Description=watch for sleep signal to start sleep.target [Service] ExecStart=%h/.local/bin/sleep_mon Restart=on-failure [Install] WantedBy=default.target Активируем и запускаем новый сервис $ systemctl --user enable user-sleep.service $ systemctl --user start user-sleep.service Непосредственно сам сервис для перезапуска pipewire Создаем файл restart-pw.service по пути ~/.config/systemd/user. [Unit] Description=Restart pipewire after resume StopWhenUnneeded=true [Service] Type=oneshot RemainAfterExit=true ExecStop=/usr/bin/systemctl --no-block --user restart pipewire pipewire-pulse [Install] WantedBy=sleep.target Добавляем юнит в запускаемые. $ systemctl --user enable restart-pw.service Стартуем юнит $ systemctl --user start restart-pw.service Можно посмотреть статус $ systemctl --user status restart-pw.service Литература: Creating a Simple Systemd User Service How To Use Journalctl to View and Manipulate Systemd Logs Systemd: stop service before suspend, restart after resume Systemd user unit that depends on system unit (sleep.target)" />
<link rel="canonical" href="http://localhost:4000/2021/08/20/restart-pipewire-after-sleep/" />
<meta property="og:url" content="http://localhost:4000/2021/08/20/restart-pipewire-after-sleep/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-20T00:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Systemd: Перезагружаем pipewire после спячки" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2021/08/20/restart-pipewire-after-sleep/","description":"Начиная с Fedora 34 pipewire пришел на замену pulseaudio и стал довольно интересной альтернативой jackd. Так как теперь не требуется каких-либо телодвижений для того, чтобы все корректно заработало. Конечно же без проблем не обошлось. В моём случае после спячки сервер перестает видеть докстанцию со встроенной звуковухой. $ journalctl --user -u pipewire ... дек 12 01:25:28 xxx pipewire[2846]: [E][000338392.259201][alsa-pcm.c:33 spa_alsa_open()] &#39;hw:Dock,1&#39;: playback open failed: Device or resource busy дек 12 01:25:28 xxx pipewire[2850]: [E][000338392.261614][core.c:71 core_event_error()] core 0x56217c2f48e0: proxy 0x56217c42e9c0 id:72: bound:68 seq:1022 res:-16 (Device or resource busy) msg:&quot;enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed&quot; дек 12 01:25:28 xxx pipewire[2850]: [E][000338392.261651][media-session.c:1971 core_error()] error id:72 seq:1022 res:-16 (Device or resource busy): enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed ... В деве вроде бы проблему чинили, но в стейбле федоры - нет. Единственный вариант, который приходит на ум - перезагружать сервер после спячки. Делать это каждый раз руками лень. Сделаем сервис, который будет делать это за нас! Однако, не все так просто. Проблема заключается в том, что systemd от пользователя запускается как отдельный процесс и не имеет доступа к системным таргетам вроде sleep/suspend и т.п. Поэтому придется решать еще и эту проблему. Кастомный sleep.target в юзерспейсе Скрипт ~/.local/bin/sleep_mon #!/bin/bash dbus-monitor --system &quot;type=&#39;signal&#39;,interface=&#39;org.freedesktop.login1.Manager&#39;,member=PrepareForSleep&quot; | while read x; do case &quot;$x&quot; in *&quot;boolean false&quot;*) systemctl --user --no-block stop sleep.target;; *&quot;boolean true&quot;*) systemctl --user --no-block start sleep.target;; esac done Таргет ~/.config/systemd/user/sleep.target [Unit] Description=User level sleep target StopWhenUnneeded=yes Скрипт для активации таргета ~/.config/systemd/user/user-sleep.service [Unit] Description=watch for sleep signal to start sleep.target [Service] ExecStart=%h/.local/bin/sleep_mon Restart=on-failure [Install] WantedBy=default.target Активируем и запускаем новый сервис $ systemctl --user enable user-sleep.service $ systemctl --user start user-sleep.service Непосредственно сам сервис для перезапуска pipewire Создаем файл restart-pw.service по пути ~/.config/systemd/user. [Unit] Description=Restart pipewire after resume StopWhenUnneeded=true [Service] Type=oneshot RemainAfterExit=true ExecStop=/usr/bin/systemctl --no-block --user restart pipewire pipewire-pulse [Install] WantedBy=sleep.target Добавляем юнит в запускаемые. $ systemctl --user enable restart-pw.service Стартуем юнит $ systemctl --user start restart-pw.service Можно посмотреть статус $ systemctl --user status restart-pw.service Литература: Creating a Simple Systemd User Service How To Use Journalctl to View and Manipulate Systemd Logs Systemd: stop service before suspend, restart after resume Systemd user unit that depends on system unit (sleep.target)","headline":"Systemd: Перезагружаем pipewire после спячки","dateModified":"2021-07-20T00:00:00+03:00","datePublished":"2021-07-20T00:00:00+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/08/20/restart-pipewire-after-sleep/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Systemd: Перезагружаем pipewire после спячки</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Systemd: Перезагружаем pipewire после спячки</h1>
<p>20 Jul 2021</p>

<p>Начиная с Fedora 34 pipewire пришел на замену pulseaudio и стал довольно интересной альтернативой jackd. Так как теперь не требуется каких-либо телодвижений для того, чтобы все корректно заработало.</p>

<p>Конечно же без проблем не обошлось. В моём случае после спячки сервер перестает видеть докстанцию со встроенной звуковухой.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>journalctl <span class="nt">--user</span> <span class="nt">-u</span> pipewire
...
дек 12 01:25:28 xxx pipewire[2846]: <span class="o">[</span>E][000338392.259201][alsa-pcm.c:33 spa_alsa_open<span class="o">()]</span> <span class="s1">'hw:Dock,1'</span>: playback open failed: Device or resource busy
дек 12 01:25:28 xxx pipewire[2850]: <span class="o">[</span>E][000338392.261614][core.c:71 core_event_error<span class="o">()]</span> core 0x56217c2f48e0: proxy 0x56217c42e9c0 <span class="nb">id</span>:72: bound:68 <span class="nb">seq</span>:1022 res:-16 <span class="o">(</span>Device or resource busy<span class="o">)</span> msg:<span class="s2">"enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed"</span>
дек 12 01:25:28 xxx pipewire[2850]: <span class="o">[</span>E][000338392.261651][media-session.c:1971 core_error<span class="o">()]</span> error <span class="nb">id</span>:72 <span class="nb">seq</span>:1022 res:-16 <span class="o">(</span>Device or resource busy<span class="o">)</span>: enum params <span class="nb">id</span>:3 <span class="o">(</span>Spa:Enum:ParamId:EnumFormat<span class="o">)</span> failed
...
</code></pre></div></div>

<p>В деве вроде бы проблему <a href="https://gitlab.freedesktop.org/pipewire/pipewire/-/issues/332">чинили</a>, но в стейбле федоры - нет.</p>

<p>Единственный вариант, который приходит на ум - перезагружать сервер после спячки. Делать это каждый раз руками лень.</p>

<p>Сделаем сервис, который будет делать это за нас!</p>

<p>Однако, не все так просто. Проблема заключается в том, что systemd от пользователя запускается как отдельный процесс и не имеет доступа к системным таргетам вроде sleep/suspend и т.п.</p>

<p>Поэтому придется решать еще и эту проблему.</p>

<p><strong>Кастомный sleep.target в юзерспейсе</strong></p>

<ol>
  <li>Скрипт <code class="language-plaintext highlighter-rouge">~/.local/bin/sleep_mon</code>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

dbus-monitor <span class="nt">--system</span> <span class="s2">"type='signal',interface='org.freedesktop.login1.Manager',member=PrepareForSleep"</span> | <span class="k">while </span><span class="nb">read </span>x<span class="p">;</span> <span class="k">do
    case</span> <span class="s2">"</span><span class="nv">$x</span><span class="s2">"</span> <span class="k">in</span>
        <span class="k">*</span><span class="s2">"boolean false"</span><span class="k">*</span><span class="p">)</span> systemctl <span class="nt">--user</span> <span class="nt">--no-block</span> stop sleep.target<span class="p">;;</span>
        <span class="k">*</span><span class="s2">"boolean true"</span><span class="k">*</span><span class="p">)</span> systemctl <span class="nt">--user</span> <span class="nt">--no-block</span> start sleep.target<span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>
</code></pre></div>    </div>
  </li>
  <li>Таргет <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/sleep.target</code>
    <pre><code class="language-editorconfig">[Unit]
Description=User level sleep target
StopWhenUnneeded=yes
</code></pre>
  </li>
  <li>Скрипт для активации таргета <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/user-sleep.service</code>
    <pre><code class="language-editorconfig">[Unit]
Description=watch for sleep signal to start sleep.target

[Service]
ExecStart=%h/.local/bin/sleep_mon
Restart=on-failure

[Install]
WantedBy=default.target
</code></pre>
  </li>
  <li>Активируем и запускаем новый сервис
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> <span class="nb">enable </span>user-sleep.service
<span class="nv">$ </span>systemctl <span class="nt">--user</span> start user-sleep.service
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>Непосредственно сам сервис для перезапуска pipewire</strong></p>

<ol>
  <li>Создаем файл <code class="language-plaintext highlighter-rouge">restart-pw.service</code> по пути <code class="language-plaintext highlighter-rouge">~/.config/systemd/user</code>.
    <pre><code class="language-editorconfig">[Unit]
Description=Restart pipewire after resume
StopWhenUnneeded=true

[Service]
Type=oneshot
RemainAfterExit=true
ExecStop=/usr/bin/systemctl --no-block --user restart pipewire pipewire-pulse

[Install]
WantedBy=sleep.target
</code></pre>
  </li>
  <li>Добавляем юнит в запускаемые.
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> <span class="nb">enable </span>restart-pw.service
</code></pre></div>    </div>
  </li>
  <li>Стартуем юнит
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> start restart-pw.service
</code></pre></div>    </div>
  </li>
  <li>Можно посмотреть статус
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> status restart-pw.service
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>Литература:</strong></p>

<ul>
  <li><a href="https://blog.victormendonca.com/2018/05/14/creating-a-simple-systemd-user-service/">Creating a Simple Systemd User Service</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs">How To Use Journalctl to View and Manipulate Systemd Logs</a></li>
  <li><a href="https://unix.stackexchange.com/questions/329445/systemd-stop-service-before-suspend-restart-after-resume">Systemd: stop service before suspend, restart after resume</a></li>
  <li><a href="https://unix.stackexchange.com/questions/147904/systemd-user-unit-that-depends-on-system-unit-sleep-target">Systemd user unit that depends on system unit (sleep.target)</a></li>
</ul>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
