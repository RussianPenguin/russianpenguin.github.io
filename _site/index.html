<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Чтобы не забыть | Записная книжка рассеянного [в пространстве и времени] программиста</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Чтобы не забыть" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<meta property="og:description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<link rel="canonical" href="http://localhost:4000/" />
<meta property="og:url" content="http://localhost:4000/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<link rel="next" href="http://localhost:4000/blog/page2/" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Чтобы не забыть" />
<script type="application/ld+json">
{"url":"http://localhost:4000/","description":"Записная книжка рассеянного [в пространстве и времени] программиста","headline":"Чтобы не забыть","@type":"WebSite","name":"Чтобы не забыть","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Чтобы не забыть</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <!-- This loops through the paginated posts -->

  <h1><a href="/2021/08/20/restart-pipewire-after-sleep/">Systemd: Перезагружаем pipewire после спячки</a></h1>
  <p class="author">
    <span class="date">2021-07-20 00:00:00 +0300</span>
  </p>
  <div class="content">
   <p>Начиная с Fedora 34 pipewire пришел на замену pulseaudio и стал довольно интересной альтернативой jackd. Так как теперь не требуется каких-либо телодвижений для того, чтобы все корректно заработало.</p>

<p>Конечно же без проблем не обошлось. В моём случае после спячки сервер перестает видеть докстанцию со встроенной звуковухой.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>journalctl <span class="nt">--user</span> <span class="nt">-u</span> pipewire
...
дек 12 01:25:28 xxx pipewire[2846]: <span class="o">[</span>E][000338392.259201][alsa-pcm.c:33 spa_alsa_open<span class="o">()]</span> <span class="s1">'hw:Dock,1'</span>: playback open failed: Device or resource busy
дек 12 01:25:28 xxx pipewire[2850]: <span class="o">[</span>E][000338392.261614][core.c:71 core_event_error<span class="o">()]</span> core 0x56217c2f48e0: proxy 0x56217c42e9c0 <span class="nb">id</span>:72: bound:68 <span class="nb">seq</span>:1022 res:-16 <span class="o">(</span>Device or resource busy<span class="o">)</span> msg:<span class="s2">"enum params id:3 (Spa:Enum:ParamId:EnumFormat) failed"</span>
дек 12 01:25:28 xxx pipewire[2850]: <span class="o">[</span>E][000338392.261651][media-session.c:1971 core_error<span class="o">()]</span> error <span class="nb">id</span>:72 <span class="nb">seq</span>:1022 res:-16 <span class="o">(</span>Device or resource busy<span class="o">)</span>: enum params <span class="nb">id</span>:3 <span class="o">(</span>Spa:Enum:ParamId:EnumFormat<span class="o">)</span> failed
...
</code></pre></div></div>

<p>В деве вроде бы проблему <a href="https://gitlab.freedesktop.org/pipewire/pipewire/-/issues/332">чинили</a>, но в стейбле федоры - нет.</p>

<p>Единственный вариант, который приходит на ум - перезагружать сервер после спячки. Делать это каждый раз руками лень.</p>

<p>Сделаем сервис, который будет делать это за нас!</p>

<p>Однако, не все так просто. Проблема заключается в том, что systemd от пользователя запускается как отдельный процесс и не имеет доступа к системным таргетам вроде sleep/suspend и т.п.</p>

<p>Поэтому придется решать еще и эту проблему.</p>

<p><strong>Кастомный sleep.target в юзерспейсе</strong></p>

<ol>
  <li>Скрипт <code class="language-plaintext highlighter-rouge">~/.local/bin/sleep_mon</code>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

dbus-monitor <span class="nt">--system</span> <span class="s2">"type='signal',interface='org.freedesktop.login1.Manager',member=PrepareForSleep"</span> | <span class="k">while </span><span class="nb">read </span>x<span class="p">;</span> <span class="k">do
    case</span> <span class="s2">"</span><span class="nv">$x</span><span class="s2">"</span> <span class="k">in</span>
        <span class="k">*</span><span class="s2">"boolean false"</span><span class="k">*</span><span class="p">)</span> systemctl <span class="nt">--user</span> <span class="nt">--no-block</span> stop sleep.target<span class="p">;;</span>
        <span class="k">*</span><span class="s2">"boolean true"</span><span class="k">*</span><span class="p">)</span> systemctl <span class="nt">--user</span> <span class="nt">--no-block</span> start sleep.target<span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>
</code></pre></div>    </div>
  </li>
  <li>Таргет <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/sleep.target</code>
    <pre><code class="language-editorconfig">[Unit]
Description=User level sleep target
StopWhenUnneeded=yes
</code></pre>
  </li>
  <li>Скрипт для активации таргета <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/user-sleep.service</code>
    <pre><code class="language-editorconfig">[Unit]
Description=watch for sleep signal to start sleep.target

[Service]
ExecStart=%h/.local/bin/sleep_mon
Restart=on-failure

[Install]
WantedBy=default.target
</code></pre>
  </li>
  <li>Активируем и запускаем новый сервис
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> <span class="nb">enable </span>user-sleep.service
<span class="nv">$ </span>systemctl <span class="nt">--user</span> start user-sleep.service
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>Непосредственно сам сервис для перезапуска pipewire</strong></p>

<ol>
  <li>Создаем файл <code class="language-plaintext highlighter-rouge">restart-pw.service</code> по пути <code class="language-plaintext highlighter-rouge">~/.config/systemd/user</code>.
    <pre><code class="language-editorconfig">[Unit]
Description=Restart pipewire after resume
StopWhenUnneeded=true

[Service]
Type=oneshot
RemainAfterExit=true
ExecStop=/usr/bin/systemctl --no-block --user restart pipewire pipewire-pulse

[Install]
WantedBy=sleep.target
</code></pre>
  </li>
  <li>Добавляем юнит в запускаемые.
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> <span class="nb">enable </span>restart-pw.service
</code></pre></div>    </div>
  </li>
  <li>Стартуем юнит
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> start restart-pw.service
</code></pre></div>    </div>
  </li>
  <li>Можно посмотреть статус
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl <span class="nt">--user</span> status restart-pw.service
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>Литература:</strong></p>

<ul>
  <li><a href="https://blog.victormendonca.com/2018/05/14/creating-a-simple-systemd-user-service/">Creating a Simple Systemd User Service</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs">How To Use Journalctl to View and Manipulate Systemd Logs</a></li>
  <li><a href="https://unix.stackexchange.com/questions/329445/systemd-stop-service-before-suspend-restart-after-resume">Systemd: stop service before suspend, restart after resume</a></li>
  <li><a href="https://unix.stackexchange.com/questions/147904/systemd-user-unit-that-depends-on-system-unit-sleep-target">Systemd user unit that depends on system unit (sleep.target)</a></li>
</ul>

  </div>

  <h1><a href="/2020/12/20/midi-to-keyboard-event/">MIDI: Превращаем сообщения в нажатия кнопок клавиатуры</a></h1>
  <p class="author">
    <span class="date">2020-12-20 00:00:00 +0300</span>
  </p>
  <div class="content">
   <p>Как конвертировать сообщения от midi-клавиатуры в нажатия кнопок на клавиатуре?</p>

<p>Где это может потребоваться - это в приложениях, которые не умеют в миди, но умеют в хоткеи. Например musescore - это приложение очень плохо умеет в миди.</p>

<p>Создадим простейший скрипт midi-to-keyboard. Все что он делает - это слушает события на шине и транслирует их в нажатия кнопок клавиатуры.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
<span class="nv">THROTTLE</span><span class="o">=</span>150
<span class="nv">old_time</span><span class="o">=</span>0
<span class="nv">last_change</span><span class="o">=</span>0
<span class="c">#aseqdump -p "Arturia MiniLab mkII" | \</span>
aseqdump <span class="nt">-p</span> <span class="s2">"System"</span> | <span class="se">\</span>
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span><span class="s2">" ,"</span> <span class="nb">read </span>src ev1 ev2 ch label1 data1 label2 data2 rest<span class="p">;</span> <span class="k">do
    </span><span class="nv">current_time</span><span class="o">=</span><span class="k">$((</span><span class="si">$(</span><span class="nb">date</span> +%s%N<span class="si">)</span><span class="o">/</span><span class="m">1000000</span><span class="k">))</span>
    <span class="nv">diff</span><span class="o">=</span><span class="k">$((</span><span class="nv">$current_time</span><span class="o">-</span><span class="nv">$old_time</span><span class="k">))</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$diff</span> <span class="nt">-gt</span> <span class="nv">$THROTTLE</span> <span class="o">&amp;&amp;</span> <span class="s2">"</span><span class="nv">$ch</span><span class="s2">"</span> <span class="o">=</span> 15 <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c"># тротлинг событий обязателен</span>
        <span class="nv">change</span><span class="o">=</span>0
        <span class="k">case</span> <span class="nv">$data1</span> <span class="k">in
            </span>48 <span class="p">)</span> <span class="c"># effects 1</span>
                <span class="k">if</span> <span class="o">[[</span> <span class="nv">$data2</span> <span class="nt">-gt</span> 64 <span class="o">]]</span><span class="p">;</span> <span class="k">then
                    </span>xdotool key Right
                    <span class="nv">change</span><span class="o">=</span>1
                <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$data2</span> <span class="nt">-lt</span> 64 <span class="o">]]</span><span class="p">;</span> <span class="k">then
                    </span>xdotool key Left
                    <span class="nv">change</span><span class="o">=</span>1
                <span class="k">fi</span>
            <span class="p">;;</span>
            49 <span class="p">)</span> <span class="c"># effects 2</span>
                <span class="k">if</span> <span class="o">[[</span> <span class="nv">$data2</span> <span class="nt">-gt</span> 64 <span class="o">]]</span><span class="p">;</span> <span class="k">then
                    </span>xdotool key Up
                    <span class="nv">change</span><span class="o">=</span>1
                <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$data2</span> <span class="nt">-lt</span> 64 <span class="o">]]</span><span class="p">;</span> <span class="k">then
                    </span>xdotool key Down
                    <span class="nv">change</span><span class="o">=</span>1
                <span class="k">fi</span>
            <span class="p">;;</span>
        <span class="k">esac</span>
        <span class="k">if</span> <span class="o">[[</span> change <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">echo</span> <span class="s2">"Change after </span><span class="k">$((</span><span class="nv">$current_time</span><span class="o">-</span><span class="nv">$old_time</span><span class="k">))</span><span class="s2">"</span>
            <span class="nv">old_time</span><span class="o">=</span><span class="nv">$current_time</span>
        <span class="k">fi
    fi
done</span>
</code></pre></div></div>

<p><strong>Литература:</strong></p>
<ul>
  <li><a href="https://superuser.com/questions/1170136/translating-midi-input-into-computer-keystrokes-on-linux">SO: Translating MIDI input into computer keystrokes on Linux?</a></li>
</ul>


  </div>

  <h1><a href="/2020/10/11/pulseaudio-loopback/">PulseAudio: Перенаправление потоков аля jackd</a></h1>
  <p class="author">
    <span class="date">2020-10-11 00:48:48 +0300</span>
  </p>
  <div class="content">
   На простом примере рассмотрим как можно микшировать несколько источников звука в pulseaudio. Статья будет полезна так же и тем, кто любит стримить что-либо, но не имеет звуковой карты с модной loopback-функциональностью.
  </div>

  <h1><a href="/2020/09/06/jackd/">Jackd: Измеряем задержку аудио сигнала в цепочке обработки</a></h1>
  <p class="author">
    <span class="date">2020-09-06 16:10:43 +0300</span>
  </p>
  <div class="content">
   Посмотрим как правильно мериться задержками аудиоинтерфейса в Linux.
  </div>

  <h1><a href="/2020/08/29/linux-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%b0%d0%b8%d0%b2%d0%b0%d0%b5%d0%bc-%d0%bc%d1%84%d1%83-pantum/">Linux: Настраиваем МФУ pantum</a></h1>
  <p class="author">
    <span class="date">2020-08-29 18:58:34 +0300</span>
  </p>
  <div class="content">
   Рассматриваем работу с принтерами фирмы pantum. А так же настройку sane для удаленного сканирования.
  </div>


<!-- Pagination links -->
<div class="pagination">
  
    <span class="previous">Назад</span>
  
  <span class="page_number ">Страница: 1 из 35</span>
  
    <a href="/blog/page2/" class="next">Далее</a>
  
</div>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
