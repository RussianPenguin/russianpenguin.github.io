<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Часть 7: PHPUnit (Тестирование ПО) | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Часть 7: PHPUnit (Тестирование ПО)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="В этой части мы разберемся что такое PHPUnit и как наш пример из 6 части превратить в полноценные тесты." />
<meta property="og:description" content="В этой части мы разберемся что такое PHPUnit и как наш пример из 6 части превратить в полноценные тесты." />
<link rel="canonical" href="http://localhost:4000/2017/05/20/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-7/" />
<meta property="og:url" content="http://localhost:4000/2017/05/20/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-7/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-05-20T22:09:06+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Часть 7: PHPUnit (Тестирование ПО)" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2017/05/20/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-7/","description":"В этой части мы разберемся что такое PHPUnit и как наш пример из 6 части превратить в полноценные тесты.","headline":"Часть 7: PHPUnit (Тестирование ПО)","dateModified":"2017-05-20T22:09:06+03:00","datePublished":"2017-05-20T22:09:06+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/05/20/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-7/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Часть 7: PHPUnit (Тестирование ПО)</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Часть 7: PHPUnit (Тестирование ПО)</h1>
<p>20 May 2017</p>

<h2 id="оглавление"><a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/"><img src="/assets/images/2017/05/php-unit-logo-big.jpg?w=150" alt="php-unit-logo-big" />Оглавление</a></h2>

<p>Продолжаем <a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/">цикл</a> статей по разработке веб-приложений с использованием методологии TDD.</p>

<p>Ранее утверждалось, что для понимания того, как функционирует тот или иной фреймворк или технология нужно сначала попытаться реализовать похожий функционал самостоятельно. И только затем пытаться использовать уже существующие наработки.</p>

<p>В предыдущей части мы попытались создать собственный минималистичный код, который осуществляет тестирование проекта. Если продолжать и дальше, то в конечном счете можно довести имеющиеся наработки до вида, годного для использования в маленьких или не очень проектах. Но так делать не стоит ибо современная индустрия разработки требует высокой скорости создания продуктов и высокого их качества. Тратить усилия на поддержание уже не раз придуманного и реализованного, но своего - это не совсем хорошая идея. Поэтому в этой главе мы познакомимся с PHPUnit и научимся правильно его применять вместе с yii.</p>

<!--more-->

<p>Это немного удивительно, но предыдущие наработки можно легко использовать лишь изменив родительский класс для <em>UserTest</em> с <em>\common\tests\TestCase</em> на <em>\PHPUnit\Framework\TestCase</em> и несколько изменив порядок запуска тестов.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">common\tests\unit</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">common\models\User</span><span class="p">;</span>  
<span class="kn">use</span> <span class="err">\</span><span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">UserTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>  
<span class="p">{</span>  
 <span class="c1">// код без изменений  </span>
<span class="p">}</span>
</code></pre></div></div>

<p>Помимо изменения родительского класса мы еще и убрали подключение файла _bootstrap.php. Запуск тестов будет выглядеть так, как показано ниже.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer exec -v -- "phpunit --bootstrap common/tests/\_bootstrap.php common/tests/unit"
</code></pre></div></div>

<p><strong>Примечание</strong> : кавычки нужны из-за неправильной обработки передаваемых в команду аргументов. Эта <a href="https://github.com/composer/composer/issues/5632">ошибка</a> уже исправлена, но ее портирование в composer будет выполнено только после того как разработчики проекта откажутся от поддержки версий php ниже 5.5.</p>

<p>Здесь мы вызываем исполняемый скрипт phpunit, который расположен в каталоге <em>vendor/bin</em> и передаем ему несколько аргументов.</p>

<ul>
  <li><em>–bootstrap common/tests/_bootstrap.php</em> - указывает, что перед запуском тестов фреймворк обязан запустить файл, переданный как часть опции. В нашем случае он отвечает за инициализацию окружения так же, как и в случае с <em>unitSuite.php</em>.</li>
  <li><em>common/tests/unit</em> - этот аргумент обозначает каталог, в котором phpunit будет искать тесты</li>
</ul>

<p>Результат выполнения это восемь точек, каждая из которых обозначает успешно выполненный тест. Если тест не выполнен, то вместо точки мы увидим букву F, а ниже будет следовать расшифровка, в которой написано, какой тест упал (во втором примере поломан первый тест).</p>

<p>[gallery ids=”2158,2157” type=”rectangular”]</p>

<p>Конечно же каждый раз писать подобную командную строку не очень удобно. И PHPUnit предусмотрена возможность конфигурирования. Один из этих способов - использование xml-файла настроек, с которым мы работали в рамках предыдущей лекции. О средствах интеграции phpunit и yii, которые существую мы поговорим на одной из следующих лекций. Создадим файл настроек phpunit.xml и разместим его в каталоге с конфигурацией тестового окружения environments/dev/. После этого нужно выполнить провизию машины или скопировать файл phpunit.xml в корень проекта (как описывалось ранее).</p>

<p><strong>phpunit.xml</strong></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;phpunit</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/5.7/phpunit.xsd"</span> <span class="na">bootstrap=</span><span class="s">"common/tests/\_bootstrap.php"</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;testsuites</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"Core functionality"</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;directory</span><span class="err">\</span><span class="nt">&gt;</span>common/tests/unit\<span class="err">&lt;</span>/directory\&gt;  
 \<span class="err">&lt;</span>/testsuite\&gt;  
 \<span class="err">&lt;</span>/testsuites\&gt;  
 \<span class="nt">&lt;filter</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;whitelist</span> <span class="na">processUncoveredFilesFromWhitelist=</span><span class="s">"true"</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;directory</span> <span class="na">suffix=</span><span class="s">".php"</span><span class="err">\</span><span class="nt">&gt;</span>models\<span class="err">&lt;</span>/directory\&gt;  
 \<span class="err">&lt;</span>/whitelist\&gt;  
 \<span class="err">&lt;</span>/filter\&gt;  
\<span class="err">&lt;</span>/phpunit\&gt;
</code></pre></div></div>

<p>Файл конфигурации - это xml файл, который содержит в себе несколько секций, описывающих определенные аспекты тестирования. Атрибуты тега phpunit <em>xmlns:xsi</em> и <em>xsi:noNamespaceSchemaLocation</em> являются обязательными. Все остальные - это настройки. Самая важная настройка - bootstrap. Она показывает, что за файл нужно выполнить перед запуском тестов. Это тот самый _bootstrap.php, который мы писали выше.</p>

<p>Внутри phpunit вкладываются элементы testsuites и filter. Первый описывает группы тестов, а второй - список файлов и каталогов, на которых будет проводится анализ покрытия кода тестами. Не будем подробно на них останавливаться поскольку данные теги очень хорошо описаны в официальной документации.</p>

<p>Таким образом мы говорим фреймворку, что у нас есть только одна группа тестов, которая расположена в каталоге <em>common/tests/unit</em>, и файлы в только этом каталоге нужно анализировать на процент покрытия тестами (если указана соответствующая опция запуска).</p>

<p>Строка запуска теперь будет выглядеть гораздо лаконичнее. Зайдя через консоль в каталог проекта и выполнив команду ниже мы увидим тот же самый результат, который был получен на предыдущем шаге.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer exec -v -- "phpunit -c phpunit.xml"
</code></pre></div></div>

<p>Строго говоря, все возможные опции, которые доступны через аргументы командной строки (посмотреть, какие опции вам доступны можно либо на официальном сайте проекта, либо выполнив composer exec -v – “phpunit –help”) мы можем указывать в конфигурационном файле. Никто не запрещает нам иметь несколько файлов конфигурации в одном проекте и использовать их поочередно, но делать так не стоит.</p>

<h2 id="отличия-интеграционных-и-модульных-тестов">Отличия интеграционных и модульных тестов</h2>

<p>Стоит сделать очень важное замечание, которое касается описанных выше тестов. Если следовать определениям, то это не совсем модульные тесты, а скорее интеграционные. Суть проста - в большинстве тестов мы используем реализацию модели пользователя, которая является наследником ActiveRecord, а уже она настолько тесно интегрирована с базой данных, что подменить ее объектом-заглушкой очень и очень сложно.</p>

<p>Смотрите, первый же вызываемый метод setUp() работает с базой, очищая ее и наполняя данными. Дальше идут тесты сохранения пользователя в базу и т.д. Если следовать букве определения, то мы должны разместить тесты модели не в подкаталоге unit, а в подкаталоге integration например, но, увы, это не будет отражать суть того, что же мы тестируем. Поэтому порой приходится идти на некоторые уступки.</p>

<p>Правильны же модульный тест тестирует только один класс в отрыве от всей остальной инфраструктуры, подменяя все внешние зависимости своими заглушками. Интеграционный же тест проверяет некоторую единицу, которая взаимодействует с различными частями системы.</p>

<h2 id="интеграционные-тесты">Интеграционные тесты</h2>

<p>Исторически сложилось, что интеграционное и блочное тестирование не разделяется в yii на два отдельных процесса и запускается одновременно (одна из причин описана в предыдущем разделе - их просто невозможно отделить). Изолировать их запуск можно самостоятельно. В раздел testsuites конфигурационного файла phpunit.xml мы добавим запись еще об одной группе тестов - интеграционной.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;testsuites</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"Core functionality"</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;directory</span><span class="err">\</span><span class="nt">&gt;</span>common/tests/unit\<span class="err">&lt;</span>/directory\&gt;  
 \<span class="err">&lt;</span>/testsuite\&gt;  
 \<span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"Integration"</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;directory</span><span class="err">\</span><span class="nt">&gt;</span>common/tests/integration\<span class="err">&lt;</span>/directory\&gt;  
 \<span class="err">&lt;</span>/testsuite\&gt;  
\<span class="err">&lt;</span>/testsuites\&gt;
</code></pre></div></div>

<p>С помощью ключа –testsuite название_группы можно запустить конкретную группу тестов.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer exec -v -- 'phpunit -c phpunit.xml'  
composer exec -v -- 'phpunit -c phpunit.xml --testsuite "Core functionality"'  
composer exec -v -- 'phpunit -c phpunit.xml --testsuite "Integration"'
</code></pre></div></div>

<p>Первая команда запустит все тестовые группы. Вторая и третья только группы с соответствующем именем.</p>

<h2 id="mock-объекты">Mock-объекты</h2>

<p>Теперь нам нужно поговорить об очень важной составляющей любых тестов. Об объектах-заглушках. Суть этих элементов в том, чтобы подменять на время некоторую функциональность проекта.</p>

<p>Например, у нас есть <em>\Yii::$app-&gt;user</em>, который является текущим пользователем системы и содержит в себе процедуры авторизации (процедуры аутентификации происходят в модели <em>LoginForm</em>).</p>

<p>При тестировании формы одним из аспектов, который обязательно требуется проверить, является наличие вызова метода авторизации из объекта user (чаще всего используется <em>\yii\web\user</em>). Как мы можем это проверить простым способом?<br />
Никак. Но что если мы сможем подменить объект user на свой? И эта сущность сможет сообщить о том был ли вызов нужно процедуры или нет. Кратко это и есть вся суть mock-объектов - объектов, которые подменяют оригинальный класс на специфический, подконтрольный разработчику. Историю появления и больше сведений можно прочесть в <a href="https://en.wikipedia.org/wiki/Mock_object">википедии</a>.</p>

<p>Первое, что мы сделаем для тестирования <em>LoginForm</em> - создадим класс тестов.</p>

<p><img src="/assets/images/2017/05/03-create_class.png" alt="03-create_class" /></p>

<p><strong>common/tests/unit/LoginFormTest.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">common\tests\unit</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">common\models\LoginForm</span><span class="p">;</span>  
<span class="kn">use</span> <span class="nc">yii\web\User</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">LoginFormTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit\_Framework\_TestCase</span>  
<span class="p">{</span>  
 <span class="k">protected</span> <span class="k">const</span> <span class="no">USER</span><span class="err">\</span><span class="n">_EMAIL</span> <span class="o">=</span> <span class="s1">'test@test.test'</span><span class="p">;</span>  
 <span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="o">@</span><span class="k">var</span> <span class="n">string</span> <span class="nc">Constant</span> <span class="n">result</span> <span class="n">of</span> <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">security</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">generatePasswordHash</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">protected</span> <span class="k">const</span> <span class="no">PASSWORD</span><span class="err">\</span><span class="n">_HASH</span> <span class="o">=</span> <span class="s1">'$2y$13$PP1EDCr7ujdhTxZT2DV96uM8e2rcdXHY1xAQINCIiB0gOck/VBwN6'</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">setUpBeforeClass</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">db</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">createCommand</span><span class="p">(</span><span class="s1">'truncate table '</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">execute</span><span class="p">();</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">db</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">createCommand</span><span class="p">(</span><span class="s1">'insert into  (id, password\_hash, username, email, auth\_key) values (:id, :password\_hash, :username, :email, :auth\_key)'</span><span class="p">)</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">bindValues</span><span class="p">([</span>  
 <span class="s1">'id'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>  
 <span class="s1">'password\_hash'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="k">self</span><span class="o">::</span><span class="n">PASSWORD\_HASH</span><span class="p">,</span>  
 <span class="s1">'username'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="s1">'test'</span><span class="p">,</span>  
 <span class="s1">'email'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="k">self</span><span class="o">::</span><span class="n">USER\_EMAIL</span><span class="p">,</span>  
 <span class="s1">'auth\_key'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="nf">str\_repeat</span><span class="p">(</span><span class="s1">'s'</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>  
 <span class="p">])</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">execute</span><span class="p">();</span>  
 <span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">tearDownAfterClass</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">db</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">createCommand</span><span class="p">(</span><span class="s1">'truncate table '</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">execute</span><span class="p">();</span>  
 <span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testOne</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="nv">$user</span> <span class="o">=</span> <span class="err">\</span><span class="nc">common\models\User</span><span class="o">::</span><span class="nf">findByEmail</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="n">USER\_EMAIL</span><span class="p">);</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">assertNotEmpty</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>  
 <span class="p">}</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Разберем этот код подробно. Метод <em>setUpBeforeClass()</em> выполняется единожды при инициализации класса (аналогично setUp(), который выполняется перед каждым тестом), в нем мы создаем в базе тестового пользователя. <em>tearDownAfterClass()</em> запускается после прохождения всех тестов и в нем мы очищаем за собой базу. Для проверки того, что все идет хорошо мы используем testOne(). Он покажет все ли идет хорошо.</p>

<p>обратите внимание на то, что мы используем константный хеш. Это нужно для повторяемости тестов. Не используйте рандомные данные в своих кейсах - воспроизвести ошибку будет практически невозможно.</p>

<p>Запускаем через phpunit способом, который мы изучили ранее и убеждаемся, что ни один тест не упал.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer exec -v -- "phpunit -c phpunit.xml"
</code></pre></div></div>

<p>Первый реальный тест, который мы напишем будет проверять валидаторы полей формы.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testValidationIsTrue</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="nv">$loginForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginForm</span><span class="p">([</span>  
 <span class="s1">'email'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="s1">'test@test.test'</span><span class="p">,</span>  
 <span class="s1">'password'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">security</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">generatePasswordHash</span><span class="p">(</span><span class="s1">'test'</span><span class="p">),</span>  
 <span class="p">]);</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$loginForm</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">validate</span><span class="p">());</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Тест не проходит и показывает, что есть ошибка. Это очевидно поскольку все шаблоны приложений Yii ориентируются на username, а мы в предыдущих частях условились использовать email как уникальный идентификатор пользователя.<br />
Вашей задачей будет модифицировать <em>LoginForm</em> так, чтобы данный кейс прошел. Да, в процессе работы над проектом у вас будут самостоятельные задания ответы на которые вы сможете подсмотреть в исходном коде прилагаемой к статье.<br />
А теперь мы хотим проверить, что после успешной аутентификации запускается механизм авторизации. Для этого нужно убедиться, что запускается метод \Yii\web\User::login(). Но как? Здесь нам помогут mock-объекты. На время теста мы подменим актуальный класс на наш, который укажет на то, выполнялся конкретный метод или нет.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  
<span class="c1">//...  </span>
<span class="kn">use</span> <span class="nc">yii\web\User</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">LoginFormTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit\_Framework\_TestCase</span>  
<span class="p">{</span>  
 <span class="c1">//...</span>

<span class="k">protected</span> <span class="k">static</span> <span class="err">$\</span><span class="n">_storedEntities</span> <span class="o">=</span> <span class="p">[</span>  
 <span class="s1">'user'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="kc">null</span><span class="p">,</span>  
 <span class="p">];</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="nc">Add</span> <span class="k">default</span> <span class="n">user</span> <span class="n">to</span> <span class="n">database</span><span class="p">,</span>  
 <span class="err">\</span><span class="o">*</span> <span class="nc">Save</span> <span class="n">original</span> <span class="n">components</span> <span class="n">from</span> <span class="n">engine</span> <span class="n">to</span> <span class="n">temporary</span> <span class="n">storage</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">setUpBeforeClass</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="c1">//...  </span>
 <span class="k">foreach</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="err">$\</span><span class="n">_storedEntities</span> <span class="k">as</span> <span class="nv">$entity</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>  
 <span class="k">static</span><span class="o">::</span><span class="err">$\</span><span class="n">_storedEntities</span><span class="p">[</span><span class="nv">$entity</span><span class="p">]</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$entity</span><span class="p">);</span>  
 <span class="p">}</span>  
 <span class="p">}</span>

<span class="c1">//...</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="nc">Restore</span> <span class="n">original</span> <span class="n">components</span> <span class="n">after</span> <span class="n">every</span> <span class="n">test</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">protected</span> <span class="k">function</span> <span class="n">tearDown</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="k">foreach</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="err">$\</span><span class="n">_storedEntities</span> <span class="k">as</span> <span class="nv">$entity</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>  
 <span class="p">}</span>  
 <span class="p">}</span>

<span class="c1">//...  </span>
 <span class="k">public</span> <span class="k">function</span> <span class="n">testAuthorizationCall</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="nv">$mock</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">setMethods</span><span class="p">([</span><span class="s1">'login'</span><span class="p">])</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">disableOriginalConstructor</span><span class="p">()</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getMock</span><span class="p">();</span>  
 <span class="nv">$mock</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'login'</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">withAnyParameters</span><span class="p">()</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="nv">$mock</span><span class="p">);</span>  
 <span class="nv">$loginForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginForm</span><span class="p">([</span>  
 <span class="s1">'email'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="k">self</span><span class="o">::</span><span class="n">USER\_EMAIL</span><span class="p">,</span>  
 <span class="s1">'password'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="s1">'test'</span><span class="p">,</span>  
 <span class="p">]);</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$loginForm</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">login</span><span class="p">());</span>  
 <span class="p">}</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Рассмотрим метод <em>testAuthorizationCall()</em>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
</code></pre></div></div>

<p>Создается mock на базе класса <em>\Yii\web\user</em>. Это значит, что будет использоваться оригинальный класс с сохранением всех его методов.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">setMethods</span><span class="p">([</span><span class="s1">'login'</span><span class="p">])</span>
</code></pre></div></div>

<p>Указываем какие методы будут заменены на новые.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">disableOriginalConstructor</span><span class="p">()</span>
</code></pre></div></div>

<p>Отключаем конструктор (так как оригинальный выполняет слишком много действий, которые нам для этого теста не нужны.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getMock</span><span class="p">()</span>
</code></pre></div></div>

<p>Получаем итоговый объект.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$mock</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'login'</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">withAnyParameters</span><span class="p">()</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</code></pre></div></div>

<p>Указываем, что метод <em>login()</em> будучи вызванный с любыми параметрами всегда вернет true.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="nv">$mock</span><span class="p">);</span>
</code></pre></div></div>

<p>Подменяем оригинального пользователя на нашего.</p>

<p>А дальше идет простой тест, который будет искать ошибки кейса. И конечно же не стоит забывать о сохранении и восстановлении оригинальных значений. Это делают методы setUpBeforeClass() и teadDown() соответственно.</p>

<p>На этом мы заканчиваем знакомство с PHPUnit и дальше будем применять его на практике (конечно же заглядывая в документацию).</p>

<p>В качестве практики попробуйте реализовать еще несколько кейсов тестирования LoginForm. При этом вы можете заметить, что мы не покрыли тестами все пути исполнения кода. Об этой метрике мы поговорим в одной из следующих частей.</p>

<p><img src="/assets/images/2017/05/04-success.png" alt="04-success" /></p>

<h2 id="исходный-код">Исходный код</h2>

<ul>
  <li><a href="https://github.com/RussianPenguin/TDD_yii2_app/releases/tag/v0.0.4">Код, который должен у вас получиться после седьмой части</a></li>
</ul>

<h2 id="литература">Литература</h2>

<ul>
  <li><a href="http://www.ozon.ru/context/detail/id/27702624/?partner=russianpenguin&amp;from=bar">“Phpunit Essentials” Zdenek Machek, ISBN: 9781783283439</a></li>
  <li><a href="https://jtreminio.com/2013/03/unit-testing-tutorial-part-5-mock-methods-and-overriding-constructors/">Unit Testing Tutorial Part V: Mock Methods and Overriding Constructors</a></li>
  <li><a href="https://phpunit.de/manual/current/en/test-doubles.html#test-doubles.mock-objects">PHPUnit manual: Chapter 9. Test Doubles</a></li>
  <li><a href="http://vladimir-ivanov.net/mock-yii2-components/">Mock Yii2 components</a></li>
</ul>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
