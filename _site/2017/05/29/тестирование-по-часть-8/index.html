<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Часть 8: DBUnit (Тестирование ПО) | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Часть 8: DBUnit (Тестирование ПО)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="В восьмой части цикла тестирование ПО мы познакомимся с очень полезным модулем PHPUnit под названием DBUnit." />
<meta property="og:description" content="В восьмой части цикла тестирование ПО мы познакомимся с очень полезным модулем PHPUnit под названием DBUnit." />
<link rel="canonical" href="http://localhost:4000/2017/05/29/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-8/" />
<meta property="og:url" content="http://localhost:4000/2017/05/29/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-8/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-05-29T20:49:30+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Часть 8: DBUnit (Тестирование ПО)" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2017/05/29/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-8/","description":"В восьмой части цикла тестирование ПО мы познакомимся с очень полезным модулем PHPUnit под названием DBUnit.","headline":"Часть 8: DBUnit (Тестирование ПО)","dateModified":"2017-05-29T20:49:30+03:00","datePublished":"2017-05-29T20:49:30+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/05/29/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-%D1%87%D0%B0%D1%81%D1%82%D1%8C-8/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Часть 8: DBUnit (Тестирование ПО)</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Часть 8: DBUnit (Тестирование ПО)</h1>
<p>29 May 2017</p>

<h2 id="оглавление"><img src="/assets/images/2017/05/db.png?w=108" alt="db" /><a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/">Оглавление</a></h2>

<p>Продолжаем серию статей <a href="http://russianpenguin.ru/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be/">Тестирование ПО</a>, которая посвящена разработке ПО с применением методологии TDD.</p>

<p>В этой части будет рассматривать полезное дополнение к PHPUnit под названием <a href="https://phpunit.de/manual/current/en/database.html">DBUnit</a>. Оно позволяет тестировать базу данных.</p>

<!--more-->

<p>На <a href="http://russianpenguin.ru/2017/05/20/%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be-%d1%87%d0%b0%d1%81%d1%82%d1%8c-7/">предыдущем занятии</a> мы тестировали форму аутентификации (не путайте процесс аутентификации и авторизации!). Для того чтобы проверить кейс входа существующего пользователя нам надо было создать запись об этом пользователе в бд. Делали мы это в методах. которые выполняются перез запуском тестов.</p>

<p>Писать подобные вещи вручную можно, но представьте, что мы тестируем множество кейсов со множеством пользователей. Каждый раз надо создавать новую запись в бд (и это должны быть не рандомные, а фиксированные записи). Процесс долгий и муторный, а файл с кейсами постепенно разрастается и заполняется данными, которые мы хотим писать в таблички.</p>

<p>Чтобы избежать подобного усложнения тестов и был разработан модуль DBUnit. По сути это просто удобная обвязка, которая берет на себя промежуточную работу по наполнению базы зчначениями.</p>

<h2 id="установка-и-настройка">Установка и настройка</h2>

<p>Проще всего установить DBUnit через менеджер пакетов composer. Для этого в каталоге /var/www/ виртуальной машины вводим команду добавления пакета.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require --dev phpunit/dbunit ^2
</code></pre></div></div>

<p>Этот код добавит последнюю версию пакета в раздел require-dev файла composer,json. Затем поставить его и обновит composer.lock. Конечно же вам потребуется закоммитить измененные файлы в систему контроля версий.</p>

<p>Почему мы используем версию 2.x.x, а не 3.x.x? Потому что некоторые модули из шаблона advanced-template еще не адаптированы под новую версию пакета на момент написания этого текста.</p>

<p>Теперь доработаем конфигурацию PHPUnit (файл environments/dev/phpunit.xml) добавив в него строки, которые содержат конфигурацию подключения к бд.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;phpunit</span>  
<span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>  
<span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/5.7/phpunit.xsd"</span>  
<span class="na">bootstrap=</span><span class="s">"common/tests/\_bootstrap.php"</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="c">&lt;!-- старый код оставляем без изменений --\&gt;  
 \&lt;php\&gt;  
 \&lt;var name="DB\_DSN" value="mysql:dbname=tdd\_tests;host=127.0.0.1" /\&gt;  
 \&lt;var name="DB\_USER" value="tdd" /\&gt;  
 \&lt;var name="DB\_PASSWD" value="tdd" /\&gt;  
 \&lt;var name="DB\_DBNAME" value="tdd\_tests" /\&gt;  
 \&lt;/php\&gt;  
\&lt;/phpunit\&gt;
</span></code></pre></div></div>

<p>Мы добавили секцию php содержащую переменные доступные при запуске тестов в супермассиве $GLOBALS. DBUnit не использует конфигурацию yii. Можно задействовать ее в процессе работы и это будет правильно. Но в общем случае конфигурацию подключения к базе для тестов хранится отдельно. Чуть позже мы увидим как объединить конфигурацию Yii и DBUnit.</p>

<p>Не забываем, что после изменения шаблонов конфигурации нужно выполнить провизию машины. Или руками скопировать файлы в нужное место.</p>

<h2 id="тестовая-база">Тестовая база</h2>

<p>Предварительно потребуется сформировать набор данных, который будет составлять основу для наших тестов.</p>

<p>Форматов хранения существует <a href="https://phpunit.de/manual/current/en/database.html#database.available-implementations">несколько</a>. Используем самый простой из них - flatXML.</p>

<p><strong>common/tests/_data/database.xml</strong></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="err">&lt;</span>?xml version="1.0" ?\&gt;  
\<span class="nt">&lt;dataset</span><span class="err">\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;user</span> <span class="na">id=</span><span class="s">"1"</span> <span class="na">username=</span><span class="s">"test"</span> <span class="na">email=</span><span class="s">"test@test.test"</span> <span class="err">auth\</span><span class="na">_key=</span><span class="s">"ssssssssssssssssssssssssssssssss"</span> <span class="err">password\</span><span class="na">_hash=</span><span class="s">"$2y$13$PP1EDCr7ujdhTxZT2DV96uM8e2rcdXHY1xAQINCIiB0gOck/VBwN6"</span> <span class="err">/\</span><span class="nt">&gt;</span>  
 \<span class="nt">&lt;user</span> <span class="na">id=</span><span class="s">"2"</span> <span class="na">username=</span><span class="s">"test1"</span> <span class="na">email=</span><span class="s">"test1@test.test"</span> <span class="err">auth\</span><span class="na">_key=</span><span class="s">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span> <span class="err">password\</span><span class="na">_hash=</span><span class="s">"$2y$13$PP1EDCr7ujdhTxZT2DV96uM8e2rcdXHY1xAQINCIiB0gOck/VBwN6"</span> <span class="err">/\</span><span class="nt">&gt;</span>  
\<span class="err">&lt;</span>/dataset\&gt;
</code></pre></div></div>

<p>Элементы набора dataset представляют из себя записи, где имя тега - это имя таблицы, куда будет записаны значения, а атрибуты - это значения текущей записи. Не забывайте, что пароли в базе хранятся в хешированом виде, поэтому потребуется каким-либо образом получить хеш пароля из Yii. Итого в таблице user у нас будет две записи - админ и пользователь. Пароли соответственно admin и user (в зашифрованном виде конечно же). Вы можете добавить сюда еще и те записи, которые использовали в своих тестовых сценариях. Это даже стоит сделать для того, чтобы не поломать уже существующие кейсы.</p>

<h2 id="тестовый-сценарий">Тестовый сценарий</h2>

<p>Редактируем код LoginFormTest и переводим его на использование DBUnit.</p>

<p><strong>common/tests/unit/LoginFormTest.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">common\tests\unit</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">common\models\LoginForm</span><span class="p">;</span>  
<span class="kn">use</span> <span class="n">PHPUnit\_Extensions\_Database\_DataSet\_IDataSet</span><span class="p">;</span>  
<span class="kn">use</span> <span class="n">PHPUnit\_Extensions\_Database\_DB\_IDatabaseConnection</span><span class="p">;</span>  
<span class="kn">use</span> <span class="nc">yii\web\User</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">LoginFormTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit\_Extensions\_Database\_TestCase</span>  
<span class="p">{</span>  
 <span class="k">protected</span> <span class="k">const</span> <span class="no">USER</span><span class="err">\</span><span class="n">_EMAIL</span> <span class="o">=</span> <span class="s1">'test@test.test'</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">static</span> <span class="err">$\</span><span class="n">_storedEntities</span> <span class="o">=</span> <span class="p">[</span>  
 <span class="s1">'user'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="kc">null</span><span class="p">,</span>  
 <span class="p">];</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="o">@</span><span class="k">var</span> <span class="err">\</span><span class="no">PDO</span> <span class="nc">Подключение</span> <span class="n">к</span> <span class="n">бд</span><span class="mf">.</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">protected</span> <span class="k">static</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="o">@</span><span class="k">var</span> <span class="err">\</span><span class="n">PHPUnit\_Extensions\_Database\_DB\_IDatabaseConnection</span> <span class="nc">Подключение</span> <span class="n">к</span> <span class="n">базе</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">private</span> <span class="err">$\</span><span class="n">_conn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">function</span> <span class="n">getConnection</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="err">\</span><span class="n">_conn</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>  
 <span class="k">if</span> <span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$pdo</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>  
 <span class="k">self</span><span class="o">::</span><span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'DB\_DSN'</span><span class="p">],</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'DB\_USER'</span><span class="p">],</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'DB\_PASSWD'</span><span class="p">]);</span>  
 <span class="p">}</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="err">\</span><span class="n">_conn</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">createDefaultDBConnection</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'DB\_DBNAME'</span><span class="p">]);</span>  
 <span class="p">}</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="err">\</span><span class="n">_conn</span><span class="p">;</span>  
 <span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="n">getDataSet</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="k">return</span> <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">createFlatXMLDataSet</span><span class="p">(</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getBasePath</span><span class="p">()</span>  
 <span class="mf">.</span> <span class="n">DIRECTORY\_SEPARATOR</span> <span class="mf">.</span> <span class="s1">'../common/tests/\_data/database.xml'</span>  
 <span class="p">);</span>  
 <span class="p">}</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="nc">Add</span> <span class="k">default</span> <span class="n">user</span> <span class="n">to</span> <span class="n">database</span><span class="p">,</span>  
 <span class="err">\</span><span class="o">*</span> <span class="nc">Save</span> <span class="n">original</span> <span class="n">components</span> <span class="n">from</span> <span class="n">engine</span> <span class="n">to</span> <span class="n">temporary</span> <span class="n">storage</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">setUpBeforeClass</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="k">foreach</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="err">$\</span><span class="n">_storedEntities</span> <span class="k">as</span> <span class="nv">$entity</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>  
 <span class="k">static</span><span class="o">::</span><span class="err">$\</span><span class="n">_storedEntities</span><span class="p">[</span><span class="nv">$entity</span><span class="p">]</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$entity</span><span class="p">);</span>  
 <span class="p">}</span>  
 <span class="p">}</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="nc">Restore</span> <span class="n">original</span> <span class="n">components</span> <span class="n">after</span> <span class="n">every</span> <span class="n">test</span>  
 <span class="err">\</span><span class="o">*/</span>  
 <span class="k">protected</span> <span class="k">function</span> <span class="n">tearDown</span><span class="p">()</span>  
 <span class="p">{</span>  
 <span class="k">foreach</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="err">$\</span><span class="n">_storedEntities</span> <span class="k">as</span> <span class="nv">$entity</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>  
 <span class="p">}</span>  
 <span class="p">}</span>

<span class="c1">// все тесты остаются без изменений  </span>
<span class="p">}</span>  

</code></pre></div></div>

<p>Первое, что должно бросаться в глаза - это изменение иерархии наследования - теперь наш тест является прямым потомком PHPUnit_Extensions_Database_TestCase и к реализации становятся обязательны два метода:</p>

<ul>
  <li>getConnection() - получение подключения к тестовой бд</li>
  <li>getDataSet() - загрузка в базу тестового набора данных</li>
</ul>

<p>В первом на базе значений, которые были заданы в phpunit.xml мы получаем подключение к бд. PHPUnit использует интерфейс \PDO для работы с базой, поэтому не пытайтесь подключаться к базе через mysqli_connect. Второй метод - это источник данных. Посредством хитрых манипуляций внутри самого фреймворка он будет вызван попытке загрузить данные в бд.</p>

<p>Напишем канареечные тесты, которые проверяют, что инфраструктура не содержит ошибок и может использоваться для работы и написания тестов. У нас в базе два пользователя. Поэтому стоит проверить, что оба они существуют и доступны для манипуляций.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testTestUserExists</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="nv">$user</span> <span class="o">=</span> <span class="err">\</span><span class="nc">common\models\User</span><span class="o">::</span><span class="nf">findByEmail</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="n">USER\_EMAIL</span><span class="p">);</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">assertNotEmpty</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>  
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testTest1UserExists</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="nv">$user</span> <span class="o">=</span> <span class="err">\</span><span class="nc">common\models\User</span><span class="o">::</span><span class="nf">findByEmail</span><span class="p">(</span><span class="s1">'test1@test.test'</span><span class="p">);</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">assertNotEmpty</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>У нас уже был testOne - переименовываем его в testTestUserExists.</p>

<p>Запуск тестов должен показать, что все работает и пользователи существуют в базе. Если нет, что есть определенные проблемы с инфраструктурой, которые самое время решить.</p>

<p>Если у вас были свои кейсы и к датасету были добавлены нужные записи, то он заработают без какой-либо доработки. Возьмем для примера тест, который проверяет авторизацию пользователя.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testTestUserLogin</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="nv">$mock</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">setMethods</span><span class="p">([</span><span class="s1">'login'</span><span class="p">])</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">disableOriginalConstructor</span><span class="p">()</span>  
 <span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">getMock</span><span class="p">();</span>  
 <span class="nv">$mock</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'login'</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">withAnyParameters</span><span class="p">()</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>  
 <span class="err">\</span><span class="nc">Yii</span><span class="o">::</span><span class="nv">$app</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="nv">$mock</span><span class="p">);</span>  
 <span class="nv">$loginForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginForm</span><span class="p">();</span>  
 <span class="nv">$loginForm</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">load</span><span class="p">([</span><span class="s1">'LoginForm'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="p">[</span><span class="s1">'email'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="k">static</span><span class="o">::</span><span class="n">USER\_EMAIL</span><span class="p">,</span> <span class="s1">'password'</span> <span class="o">=</span><span class="err">\</span><span class="o">&gt;</span> <span class="k">static</span><span class="o">::</span><span class="n">USER\_PASSWORD</span><span class="p">]]);</span>  
 <span class="nv">$this</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$loginForm</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="nf">login</span><span class="p">());</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Чтобы пока не разбираться с авторизацией в консоли подменим метод \yii\web\User::login() своим, который возвращает true. Это необходимо потому что в консоли отсутствуют объекты Request и сессии. К ним мы еще вернемся.</p>

<p>Тест работает. Ошибок пока не находит. Отметим, что работать с базой при помощи DBUnit гораздо приятнее, нежели руками через setUp.</p>

<h2 id="внутреннее-устройство">Внутреннее устройство</h2>

<p>Для того, чтобы лучше понимать, как происходит тестирование с рассматриваемым фреймворком посмотрим, как это устроено.</p>

<p>Конечно же стоит заметить, что поле id или любой другой первичный ключ (если он не является автогенерируемым должен присутствовать в датасете. И автогенерируемый ключ так же стоит включать в датасет - это обеспечит одинаковое состояние набора данных при запуске теста.</p>

<h3 id="1-очистка-базы">1. Очистка базы</h3>

<p>Прежде чем хоть один тест будет запущен PHPUnit выполняет операцию TRUNCATE для всех таблиц, которые указаны в датасете.</p>

<h3 id="2-загрузка-фикстур">2. Загрузка фикстур</h3>

<p>PHPUnit проходит по всему набору данных из датасета и выполняет операцию INSERT чтобы вставить строки данных.</p>

<h3 id="35-запуск-тестов-проверка-и-завершение-teardown">3–5. Запуск тестов, проверка и завершение (tearDown)</h3>

<p>Как только состояние базы данных обнулено и загружены фикстуры, фреймворк запускает тесты. Никаких действий со стороны разработчика не требуется.</p>

<p>Тест может вызывать метод assertDataSetsEqual(), однако, эта функциональность опциональна.</p>

<h2 id="литература">Литература</h2>

<ul>
  <li><a href="https://phpunit.de/manual/current/en/database.html">PHPUnit Manual: Chapter 8. Database Testing</a></li>
</ul>

<h2 id="исходный-код">Исходный код</h2>

<ul>
  <li><a href="https://github.com/RussianPenguin/TDD_yii2_app/releases/tag/v0.0.5">Код восьмой части цикла Тестирование ПО</a></li>
</ul>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
