<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Linux: произвольное падение приложений на mono | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Linux: произвольное падение приложений на mono" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Столкнулся с неочевидной проблемой - раз за разом закрывался RepetierHost и не давал напечатать модель на принтере." />
<meta property="og:description" content="Столкнулся с неочевидной проблемой - раз за разом закрывался RepetierHost и не давал напечатать модель на принтере." />
<link rel="canonical" href="http://localhost:4000/2017/06/05/linux-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9-mono/" />
<meta property="og:url" content="http://localhost:4000/2017/06/05/linux-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9-mono/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-06-05T14:57:33+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Linux: произвольное падение приложений на mono" />
<script type="application/ld+json">
{"headline":"Linux: произвольное падение приложений на mono","dateModified":"2017-06-05T14:57:33+03:00","datePublished":"2017-06-05T14:57:33+03:00","description":"Столкнулся с неочевидной проблемой - раз за разом закрывался RepetierHost и не давал напечатать модель на принтере.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/06/05/linux-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9-mono/"},"@type":"BlogPosting","url":"http://localhost:4000/2017/06/05/linux-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9-mono/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Linux: произвольное падение приложений на mono</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Linux: произвольное падение приложений на mono</h1>
<p>05 Jun 2017</p>

<p><img src="/assets/images/2017/06/53395.png?w=150" alt="53395" />Столкнулся со странной проблемой: без сторонней помощи стал закрываться RepetierHost. Ему было все равно печатал он модель, слайсил или просто был открытым. Сам хост я всегда открывал на отдельном воркспейсе и поначалу грешил на то, что какие-то проблемы могут быть у cinnamon, который сейчас использую как дефолтный стол. Если оставить хост отрытым и не менять рабочие столы, не запускать никаких приложений, то все нормально и приложение не отваливалось. Гугл ничего не смог сказать мне про систематический вылеты. Откат на предыдушие версии не помог - они так же вылетали.</p>

<p>Добавил в repetierHost строки, которые перенаправляли лог запуска в файл и он стал выглядеть вот так.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash  </span>
<span class="nb">cd</span> /home/penguin/.soft/RepetierHost  
<span class="nb">env </span><span class="nv">LANG</span><span class="o">=</span>en<span class="se">\_</span>US.utf8 mono RepetierHost.exe <span class="nt">-home</span> <span class="o">{</span><span class="nv">$HOME</span><span class="o">}</span>.soft/RepetierHost &amp;<span class="se">\&gt;</span> <span class="o">{</span><span class="nv">$HOME</span><span class="o">}</span>/log&amp;
</code></pre></div></div>

<p>После пары запусков я таки поймал в лог креш приложения. Да, не обращаете внимание на то, что принудительно используется локаль en_US - это решает проблему слайсера Slic3r, который по каким-то причинам отказывается работать с группами объектов названными символами, отличными от латинских.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/slic3r --load "slic3r\_settings.ini" --print-center 100.00,100.00 -o "composition.gcode" "composition.amf"  
Wide character at /usr/lib64/perl5/vendor\_perl/Encode.pm line 212.
</code></pre></div></div>

<p>В amf-файле все группы должны иметь латинские имена, а repetier генерирует имена в текущей локали.</p>

<p>Пойманный трейс выглядит следующим образом.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Stacktrace:

at \&lt;unknown\&gt; \&lt;0xffffffff\&gt;  
at (wrapper managed-to-native) System.Windows.Forms.X11Keyboard.Xutf8LookupString (intptr,System.Windows.Forms.XEvent&amp;,byte[],int,intptr&amp;,System.Windows.Forms.XLookupStatus&amp;) \&lt;0x000a4\&gt;  
at System.Windows.Forms.X11Keyboard.LookupString (System.Windows.Forms.XEvent&amp;,int,System.Windows.Forms.XKeySym&amp;,System.Windows.Forms.XLookupStatus&amp;) \&lt;0x000bb\&gt;  
at System.Windows.Forms.X11Keyboard.EventToVkey (System.Windows.Forms.XEvent) \&lt;0x0003f\&gt;  
at System.Windows.Forms.X11Keyboard.ToUnicode (int,int,string&amp;) \&lt;0x0034f\&gt;  
at System.Windows.Forms.X11Keyboard.TranslateMessage (System.Windows.Forms.MSG&amp;) \&lt;0x0011f\&gt;  
at System.Windows.Forms.XplatUIX11.TranslateMessage (System.Windows.Forms.MSG&amp;) \&lt;0x00027\&gt;  
at System.Windows.Forms.XplatUI.TranslateMessage (System.Windows.Forms.MSG&amp;) \&lt;0x00024\&gt;  
at System.Windows.Forms.Application.RunLoop (bool,System.Windows.Forms.ApplicationContext) \&lt;0x00d6b\&gt;  
at System.Windows.Forms.Application.Run (System.Windows.Forms.ApplicationContext) \&lt;0x00047\&gt;  
at System.Windows.Forms.Application.Run (System.Windows.Forms.Form) \&lt;0x00037\&gt;  
at RepetierHost.Program.Main (string[]) \&lt;0x0003f\&gt;  
at (wrapper runtime-invoke) \&lt;Module\&gt;.runtime\_invoke\_void\_object (object,intptr,intptr,intptr) \&lt;0x000d1\&gt;

Native stacktrace:

mono(+0xc3794) [0x55d10cc73794]  
mono(+0x11a8ce) [0x55d10ccca8ce]  
mono(+0x3c633) [0x55d10cbec633]  
/lib64/libpthread.so.0(+0x115c0) [0x7f4b23cea5c0]  
/lib64/libc.so.6(strlen+0x26) [0x7f4b23788fe6]  
/lib64/libX11.so.6(\_XimLocalUtf8LookupString+0xde) [0x7f4b1870b8fe]  
[0x4249f8b5]

Debug info from gdb:

[New LWP 5108]  
[New LWP 5112]  
[New LWP 5116]  
[New LWP 5117]  
[New LWP 5118]  
[New LWP 5119]  
[New LWP 5121]  
[New LWP 5122]  
[New LWP 5123]  
warning: File "/usr/bin/mono-sgen-gdb.py" auto-loading has been declined by your `auto-load safe-path' set to "$debugdir:$datadir/auto-load".  
To enable execution of this file add  
add-auto-load-safe-path /usr/bin/mono-sgen-gdb.py  
line to your configuration file "/home/penguin/.gdbinit".  
To completely disable this security protection add  
set auto-load safe-path /  
line to your configuration file "/home/penguin/.gdbinit".  
For more information about this security protection see the  
"Auto-loading safe path" section in the GDB manual.&amp;nbsp; E.g., run from the shell:  
info "(gdb)Auto-loading safe path"  
warning: File "/usr/bin/mono-sgen-gdb.py" auto-loading has been declined by your `auto-load safe-path' set to "$debugdir:$datadir/auto-load".  
[Thread debugging using libthread\_db enabled]  
Using host libthread\_db library "/lib64/libthread\_db.so.1".  
0x00007f4b23ce9fdb in waitpid () from /lib64/libpthread.so.0  
Id&amp;nbsp;&amp;nbsp; Target Id&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Frame  
\* 1&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b247fa780 (LWP 5104) "mono" 0x00007f4b23ce9fdb in waitpid () from /lib64/libpthread.so.0  
2&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b1c3ff700 (LWP 5108) "mono" 0x00007f4b23ce6460 in pthread\_cond\_wait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0  
3&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b1cb62700 (LWP 5112) "Finalizer" 0x00007f4b23ce8957 in do\_futex\_wait.constprop () from /lib64/libpthread.so.0  
4&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b0c301700 (LWP 5116) "Timer-Scheduler" 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0  
5&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b18044700 (LWP 5117) "Timer-Scheduler" 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0  
6&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b06eef700 (LWP 5118) "Threadpool work" 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0  
7&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b06cee700 (LWP 5119) "Threadpool work" 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0  
8&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b05af4700 (LWP 5121) "Threadpool work" 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0  
9&amp;nbsp;&amp;nbsp;&amp;nbsp; Thread 0x7f4b06241700 (LWP 5122) "Threadpool work" 0x00007f4b237f801d in poll () from /lib64/libc.so.6  
10&amp;nbsp;&amp;nbsp; Thread 0x7f4b04c93700 (LWP 5123) "Threadpool work" 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () from /lib64/libpthread.so.0

Thread 10 (Thread 0x7f4b04c93700 (LWP 5123)):  
#0&amp;nbsp; 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cd6b9ab in worker\_thread ()  
#2&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#3&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#4&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#5&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 9 (Thread 0x7f4b06241700 (LWP 5122)):  
#0&amp;nbsp; 0x00007f4b237f801d in poll () at /lib64/libc.so.6  
#1&amp;nbsp; 0x000055d10cd6d2f2 in poll\_event\_wait ()  
#2&amp;nbsp; 0x000055d10cd6e136 in selector\_thread ()  
#3&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#4&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#5&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#6&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 8 (Thread 0x7f4b05af4700 (LWP 5121)):  
#0&amp;nbsp; 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cd6b9ab in worker\_thread ()  
#2&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#3&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#4&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#5&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 7 (Thread 0x7f4b06cee700 (LWP 5119)):  
#0&amp;nbsp; 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cd6b9ab in worker\_thread ()  
#2&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#3&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#4&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#5&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 6 (Thread 0x7f4b06eef700 (LWP 5118)):  
#0&amp;nbsp; 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cd6b9ab in worker\_thread ()  
#2&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#3&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#4&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#5&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 5 (Thread 0x7f4b18044700 (LWP 5117)):  
#0&amp;nbsp; 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10ce19a7d in mono\_thread\_info\_sleep ()  
#2&amp;nbsp; 0x000055d10cd6a91e in monitor\_thread ()  
#3&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#4&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#5&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#6&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 4 (Thread 0x7f4b0c301700 (LWP 5116)):  
#0&amp;nbsp; 0x00007f4b23ce6809 in pthread\_cond\_timedwait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cdefb3f in \_wapi\_handle\_timedwait\_signal\_handle ()  
#2&amp;nbsp; 0x000055d10ce06304 in wapi\_WaitForSingleObjectEx ()  
#3&amp;nbsp; 0x000055d10cd659d8 in mono\_wait\_uninterrupted.isra.18.constprop ()  
#4&amp;nbsp; 0x000055d10cd65aa3 in ves\_icall\_System\_Threading\_WaitHandle\_WaitOne\_internal ()  
#5&amp;nbsp; 0x00000000420b2604 in&amp;nbsp; ()  
#6&amp;nbsp; 0x0000000000000002 in&amp;nbsp; ()  
#7&amp;nbsp; 0x0000000000000001 in&amp;nbsp; ()  
#8&amp;nbsp; 0x0000000000000064 in&amp;nbsp; ()  
#9&amp;nbsp; 0x00007f4b1c6a7bb0 in&amp;nbsp; ()  
#10 0x0000000000000063 in&amp;nbsp; ()  
#11 0x00007f4b08001960 in&amp;nbsp; ()  
#12 0x00007f4b1c6a7bb0 in&amp;nbsp; ()  
#13 0x00007f4b0c300660 in&amp;nbsp; ()  
#14 0x00007f4b0c3005d0 in&amp;nbsp; ()  
#15 0x00000000420b23d0 in&amp;nbsp; ()  
#16 0x0000000000000000 in&amp;nbsp; ()

Thread 3 (Thread 0x7f4b1cb62700 (LWP 5112)):  
#0&amp;nbsp; 0x00007f4b23ce8957 in do\_futex\_wait.constprop () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x00007f4b23ce8a04 in \_\_new\_sem\_wait\_slow.constprop.0 () at /lib64/libpthread.so.0  
#2&amp;nbsp; 0x00007f4b23ce8aaa in sem\_wait@@GLIBC\_2.2.5 () at /lib64/libpthread.so.0  
#3&amp;nbsp; 0x000055d10cd877bb in finalizer\_thread ()  
#4&amp;nbsp; 0x000055d10cd661d6 in start\_wrapper ()  
#5&amp;nbsp; 0x000055d10ce1af4a in inner\_start\_thread ()  
#6&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#7&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 2 (Thread 0x7f4b1c3ff700 (LWP 5108)):  
#0&amp;nbsp; 0x00007f4b23ce6460 in pthread\_cond\_wait@@GLIBC\_2.3.2 () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cde963f in thread\_func ()  
#2&amp;nbsp; 0x00007f4b23ce06ca in start\_thread () at /lib64/libpthread.so.0  
#3&amp;nbsp; 0x00007f4b23803f7f in clone () at /lib64/libc.so.6

Thread 1 (Thread 0x7f4b247fa780 (LWP 5104)):  
#0&amp;nbsp; 0x00007f4b23ce9fdb in waitpid () at /lib64/libpthread.so.0  
#1&amp;nbsp; 0x000055d10cc73870 in mono\_handle\_native\_sigsegv ()  
#2&amp;nbsp; 0x000055d10ccca8ce in mono\_arch\_handle\_altstack\_exception ()  
#3&amp;nbsp; 0x000055d10cbec633 in mono\_sigsegv\_signal\_handler ()  
#4&amp;nbsp; 0x00007f4b23cea5c0 in \&lt;signal handler called\&gt; () at /lib64/libpthread.so.0  
#5&amp;nbsp; 0x00007f4b23788fe6 in strlen () at /lib64/libc.so.6  
#6&amp;nbsp; 0x00007f4b1870b8fe in \_XimLocalUtf8LookupString () at /lib64/libX11.so.6  
#7&amp;nbsp; 0x000000004249f8b5 in&amp;nbsp; ()  
#8&amp;nbsp; 0x0000000000000000 in&amp;nbsp; ()

=================================================================  
Got a SIGSEGV while executing native code. This usually indicates  
a fatal error in the mono runtime or one of the native libraries  
used by your application.  
=================================================================
</code></pre></div></div>

<p>Ок. Теперь уже проще гуглить. Ответ был найден на форуме arch-linux в <a href="https://bbs.archlinux.org/viewtopic.php?id=213818">ветке</a>, которая посвящена keepass: это оказался баг в библиотеке WinForms, который не сильно важен для разработчиков и никто фиксить его пока не будет (<a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41505">оригинальный репорт</a>).</p>

<p>Временное решение - добавить опцию –verify-all в качестве аргумента mono.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>env LANG=en\_US.utf8 mono --verify-all RepetierHost.exe -home {$HOME}.soft/RepetierHost
</code></pre></div></div>

<p>С этой опцией вылетов не наблюдается, но случаются фризы приложения.</p>




      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
