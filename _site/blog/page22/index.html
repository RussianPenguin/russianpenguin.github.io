<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Page 22 of 35 for Чтобы не забыть | Записная книжка рассеянного [в пространстве и времени] программиста</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Чтобы не забыть" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<meta property="og:description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<link rel="canonical" href="http://localhost:4000/blog/page22/" />
<meta property="og:url" content="http://localhost:4000/blog/page22/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<link rel="prev" href="http://localhost:4000/blog/page21/" />
<link rel="next" href="http://localhost:4000/blog/page23/" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Чтобы не забыть" />
<script type="application/ld+json">
{"url":"http://localhost:4000/blog/page22/","description":"Записная книжка рассеянного [в пространстве и времени] программиста","headline":"Чтобы не забыть","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Чтобы не забыть</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <!-- This loops through the paginated posts -->

  <h1><a href="/2014/11/07/kinect-%d0%bf%d1%80%d0%b8%d0%b2%d0%b5%d0%b4%d0%b5%d0%bd%d0%b8%d0%b5-%d0%ba%d0%be%d0%be%d1%80%d0%b4%d0%b8%d0%bd%d0%b0%d1%82-%d1%81%d0%b5%d0%bd%d1%81%d0%be%d1%80%d0%b0-%d0%b2-%d0%bc%d0%b5%d1%82%d1%80/">Kinect: Приведение координат сенсора в метрические</a></h1>
  <p class="author">
    <span class="date">2014-11-07 22:13:02 +0300</span>
  </p>
  <div class="content">
   <p>В одниокм из своих проектов с использованием сенсора пришлось задаваться вопросом: как привиодить координаты сенсора (глубину) в координаты метрические. Если этого не сделать, то прямые углы у стен прямыми не будут.</p>

<p>Будет это выглядеть как на картинке ниже.</p>

<p><a href="https://russianpenguin.files.wordpress.com/2014/11/tutorialapplication-render-window_113.png"><img src="/assets/images/2014/11/tutorialapplication-render-window_113.png?w=300" alt="Kinect: сырой рендер (без преобразования в метрические координаты)" /></a>А как это сделать?</p>

<p>В пакете freenect есть демка glpclview в коде которой можно увидеть матрицу преобразований координат сенсора в нужные нам координаты.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Do the projection from u,v,depth to X,Y,Z directly in an opengl matrix  </span>
<span class="c1">// These numbers come from a combination of the ros kinect\_node wiki, and  </span>
<span class="c1">// nicolas burrus' posts.  </span>
<span class="kt">void</span> <span class="nf">LoadVertexMatrix</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="kt">float</span> <span class="n">fx</span> <span class="o">=</span> <span class="mf">594.21</span><span class="n">f</span><span class="p">;</span>  
 <span class="kt">float</span> <span class="n">fy</span> <span class="o">=</span> <span class="mf">591.04</span><span class="n">f</span><span class="p">;</span>  
 <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0030711</span><span class="n">f</span><span class="p">;</span>  
 <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">3.3309495</span><span class="n">f</span><span class="p">;</span>  
 <span class="kt">float</span> <span class="n">cx</span> <span class="o">=</span> <span class="mf">339.5</span><span class="n">f</span><span class="p">;</span>  
 <span class="kt">float</span> <span class="n">cy</span> <span class="o">=</span> <span class="mf">242.7</span><span class="n">f</span><span class="p">;</span>  
 <span class="n">GLfloat</span> <span class="n">mat</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  
 <span class="mi">1</span><span class="o">/</span><span class="n">fx</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  
 <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">fy</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  
 <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span>  
 <span class="o">-</span><span class="n">cx</span><span class="o">/</span><span class="n">fx</span><span class="p">,</span> <span class="n">cy</span><span class="o">/</span><span class="n">fy</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span>  
 <span class="p">};</span>  
 <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">mat</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Не будем заострять внимание на очень понятных комментариях в коде :), а попробуем понять, чтоже эта штука делает.</p>

<p>Сходу информации почти нет - гугл говорит, что это есть лишь приведение координат согласно калибровочным данным самого кинекта (<a href="https://groups.google.com/forum/#!msg/openkinect/c7OvB0GqNjU/z-4hbz4SdJYJ" title="Матрица преобразований координат сенсора kinect в реальные">тыц</a>).</p>

<p>Но это нифига не проясняет.</p>

<p>Дальнейшее гугление нашло <a href="http://answers.ros.org/question/67339/converting-kinect-depth-image-to-real-world-coordinate/" title="Converting Kinect depth image to Real world coordinate.">пруф</a> на форуме ROS, а так же <a href="https://groups.google.com/forum/#!topic/openkinect/ihfBIY56Is8" title="Depth to Real World XY Coordinate">пруф</a> в гуглогруппах.</p>

<p>В итоге на скорую руку был состряпан код, который делает нужное преобразование.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="err">Преобразует</span> <span class="err">глубину</span> <span class="err">в</span> <span class="err">реальное</span> <span class="err">значение</span> <span class="p">(</span><span class="err">в</span> <span class="err">миллиметрах</span><span class="p">)</span>  
 <span class="err">\*/</span>  
<span class="kt">double</span> <span class="n">raw</span><span class="err">\</span><span class="n">_depth</span><span class="err">\</span><span class="n">_to</span><span class="err">\</span><span class="n">_millimeters</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="err">\</span><span class="n">_value</span><span class="p">){</span>  
 <span class="kt">double</span> <span class="n">depth</span><span class="err">\</span><span class="n">_value</span><span class="err">\</span><span class="n">_f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">depth</span><span class="err">\</span><span class="n">_value</span><span class="p">;</span>  
 <span class="k">if</span> <span class="p">(</span><span class="n">depth</span><span class="err">\</span><span class="n">_value</span> <span class="err">\</span><span class="o">&lt;</span> <span class="mi">2047</span><span class="p">){</span>  
 <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">depth</span><span class="err">\</span><span class="n">_value</span><span class="err">\</span><span class="n">_f</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="o">-</span><span class="mf">0.0030711016</span> <span class="o">+</span> <span class="mf">3.3309495161</span><span class="p">);</span>  
 <span class="k">return</span> <span class="n">depth</span><span class="p">;</span>  
 <span class="p">}</span>  
 <span class="k">return</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>  
<span class="p">}</span>

<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
 <span class="err">\</span><span class="o">*</span> <span class="err">Преобразует</span> <span class="err">вируальную</span> <span class="err">точку</span> <span class="n">point</span> <span class="err">в</span> <span class="err">точку</span> <span class="err">с</span> <span class="err">реальными</span> <span class="err">координатами</span> <span class="p">(</span><span class="err">в</span> <span class="err">миллиметрах</span><span class="p">)</span>  
 <span class="err">\*/</span>  
<span class="n">Ogre</span><span class="o">::</span><span class="n">Vector3</span> <span class="n">depth</span><span class="err">\</span><span class="n">_to</span><span class="err">\</span><span class="n">_realword</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">Vector3</span> <span class="n">point</span><span class="p">){</span>  
 <span class="kt">double</span> <span class="n">fx</span><span class="err">\</span><span class="n">_d</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">5.9421434211923247e+02</span><span class="p">;</span>  
 <span class="kt">double</span> <span class="n">fy</span><span class="err">\</span><span class="n">_d</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">5.9104053696870778e+02</span><span class="p">;</span>  
 <span class="kt">double</span> <span class="n">cx</span><span class="err">\</span><span class="n">_d</span> <span class="o">=</span> <span class="mf">3.3930780975300314e+02</span><span class="p">;</span>  
 <span class="kt">double</span> <span class="n">cy</span><span class="err">\</span><span class="n">_d</span> <span class="o">=</span> <span class="mf">2.4273913761751615e+02</span><span class="p">;</span>

<span class="kt">double</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">raw</span><span class="err">\</span><span class="n">_depth</span><span class="err">\</span><span class="n">_to</span><span class="err">\</span><span class="n">_millimeters</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

<span class="k">return</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">Vector3</span><span class="p">(</span>  
 <span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cx</span><span class="err">\</span><span class="n">_d</span><span class="p">)</span> <span class="err">\</span><span class="o">*</span> <span class="n">depth</span> <span class="err">\</span><span class="o">*</span> <span class="n">fx</span><span class="err">\</span><span class="n">_d</span><span class="p">,</span>  
 <span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cy</span><span class="err">\</span><span class="n">_d</span><span class="p">)</span> <span class="err">\</span><span class="o">*</span> <span class="n">depth</span> <span class="err">\</span><span class="o">*</span> <span class="n">fy</span><span class="err">\</span><span class="n">_d</span><span class="p">,</span>  
 <span class="n">depth</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Про этот код важно помнить, что координаты x и y должны назодиться в первой четверти (больше нуля).</p>

<p>Теперь изображение выглядит куда лучше. :)</p>

<p><a href="https://russianpenguin.files.wordpress.com/2014/11/tutorialapplication-render-window_112.png"><img src="/assets/images/2014/11/tutorialapplication-render-window_112.png?w=300" alt="Изображение с сенсора kineck после преобразования в метрические координаты." /></a></p>


  </div>

  <h1><a href="/2014/11/04/ogre3d-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%b0-%d1%81-%d0%b2%d0%b5%d1%80%d1%82%d0%b5%d0%ba%d1%81%d0%bd%d1%8b%d0%bc-%d0%b1%d1%83%d1%84%d0%b5%d1%80%d0%be%d0%bc/">Ogre3D: работа с вертексным буфером</a></h1>
  <p class="author">
    <span class="date">2014-11-04 19:14:24 +0300</span>
  </p>
  <div class="content">
   <p>Ура :) Я научился таки работать с вертексным буфером в этом самам огре.</p>

<p>Как было просто в голом опенглы. Так просто, что даже вспомнить не хочется. :-D</p>

<p>Теперь же нам надо сделать что-то вроде этого</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">TutorialApplication</span><span class="o">::</span><span class="n">createScene</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  
<span class="p">{</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Зачем</span> <span class="err">дополнительно</span> <span class="err">создавать</span> <span class="n">submesh</span> <span class="err">пока</span> <span class="err">не</span> <span class="err">понял</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">MeshPtr</span> <span class="n">mesh</span> <span class="o">=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">MeshManager</span><span class="o">::</span><span class="n">getSingleton</span><span class="p">().</span><span class="n">createManual</span><span class="p">(</span><span class="s">"CustomMesh"</span><span class="p">,</span> <span class="s">"General"</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">SubMesh</span> <span class="err">\</span><span class="o">*</span><span class="n">subMesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">createSubMesh</span><span class="p">();</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Подготавливаем</span> <span class="err">структуру</span> <span class="err">для</span> <span class="err">трех</span> <span class="err">вершин</span> <span class="p">(</span><span class="err">треугольник</span> <span class="err">у</span> <span class="err">нас</span><span class="p">)</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VertexData</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">vertexCount</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Получаем</span> <span class="err">ссылку</span> <span class="err">на</span> <span class="err">дескриптор</span> <span class="err">буфера</span> <span class="p">(</span><span class="err">описывает</span> <span class="err">структуру</span><span class="p">)</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VertexDeclaration</span> <span class="err">\</span><span class="o">*</span><span class="n">decl</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">vertexDeclaration</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">size</span><span class="err">\</span><span class="n">_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">первый</span> <span class="err">элемент</span> <span class="err">буфера</span> <span class="o">-</span> <span class="err">это</span> <span class="err">сама</span> <span class="err">вершина</span> <span class="p">(</span><span class="err">ее</span> <span class="err">координаты</span><span class="p">)</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">decl</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">addElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VET</span><span class="err">\</span><span class="n">_FLOAT3</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VES</span><span class="err">\</span><span class="n">_POSITION</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VertexElement</span><span class="o">::</span><span class="n">getTypeSize</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">VET</span><span class="err">\</span><span class="n">_FLOAT3</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">вторая</span> <span class="err">часть</span> <span class="err">буфера</span> <span class="o">-</span> <span class="err">нормаль</span> <span class="err">вершины</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">decl</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">addElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VET</span><span class="err">\</span><span class="n">_FLOAT3</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VES</span><span class="err">\</span><span class="n">_NORMAL</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VertexElement</span><span class="o">::</span><span class="n">getTypeSize</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">VET</span><span class="err">\</span><span class="n">_FLOAT3</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Третья</span> <span class="err">часть</span> <span class="o">-</span> <span class="err">это</span> <span class="err">цвет</span> <span class="err">вершины</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">decl</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">addElement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VET</span><span class="err">\</span><span class="n">_COLOUR</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VES</span><span class="err">\</span><span class="n">_DIFFUSE</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">VertexElement</span><span class="o">::</span><span class="n">getTypeSize</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">VET</span><span class="err">\</span><span class="n">_COLOUR</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Генерируем</span> <span class="err">вертексный</span> <span class="err">буфер</span> <span class="err">по</span> <span class="err">описанию</span><span class="p">,</span> <span class="err">которое</span> <span class="err">выше</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareVertexBufferSharedPtr</span> <span class="n">vertexBuffer</span> <span class="o">=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareBufferManager</span><span class="o">::</span><span class="n">getSingleton</span><span class="p">().</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">createVertexBuffer</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">vertexCount</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareBuffer</span><span class="o">::</span><span class="n">HBU</span><span class="err">\</span><span class="n">_STATIC</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="c1">// подготавливаем цвета  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="c1">// можно писать цвета руками и использовать не Ogre::VET\_COLOUR, а VET\_FLOAT3|4 (4 - это если альфаканал нужен)  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">RenderSystem</span><span class="err">\</span><span class="o">*</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">Root</span><span class="o">::</span><span class="n">getSingleton</span><span class="p">().</span><span class="n">getRenderSystem</span><span class="p">();</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">uint32</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">rs</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">convertColourValue</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">ColourValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">red</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">rs</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">convertColourValue</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">ColourValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">green</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">rs</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">convertColourValue</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">ColourValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">blue</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">sqrt13</span> <span class="o">=</span> <span class="mf">0.577350269</span><span class="n">f</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="err">это</span> <span class="err">для</span> <span class="err">нормалей</span> <span class="err">\*/</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">блокируем</span> <span class="err">буфер</span> <span class="err">на</span> <span class="err">запись</span> <span class="err">и</span> <span class="err">берем</span> <span class="err">указатель</span> <span class="err">на</span> <span class="err">него</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="kt">float</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span> <span class="o">=</span> <span class="k">static</span><span class="err">\</span><span class="n">_cast</span><span class="err">\</span><span class="o">&lt;</span><span class="kt">float</span> <span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vertexBuffer</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">lock</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareBuffer</span><span class="o">::</span><span class="n">HBL</span><span class="err">\</span><span class="n">_DISCARD</span><span class="p">));</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="c1">// Заполняем буфер  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span> <span class="c1">// вершина  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt13</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="n">sqrt13</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt13</span><span class="p">;</span> <span class="c1">// нормаль  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="p">(</span><span class="err">\</span><span class="o">*</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">uint32</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pVertex</span><span class="p">)</span><span class="o">++</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="c1">//цвета  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">f</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">f</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span> <span class="c1">// вершина  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="n">sqrt13</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="n">sqrt13</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt13</span><span class="p">;</span> <span class="c1">// нормаль  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="p">(</span><span class="err">\</span><span class="o">*</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">uint32</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pVertex</span><span class="p">)</span><span class="o">++</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span> <span class="c1">// цвета  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">f</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span> <span class="c1">// вершина  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt13</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt13</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="n">pVertex</span><span class="o">++</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt13</span><span class="p">;</span> <span class="c1">// нормаль  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span><span class="p">(</span><span class="err">\</span><span class="o">*</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">uint32</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pVertex</span><span class="p">)</span><span class="o">++</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="c1">// цвета</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">разблокируем</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">vertexBuffer</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">unlock</span><span class="p">();</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Создаем</span> <span class="err">буфер</span> <span class="err">для</span> <span class="err">индексов</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareIndexBufferSharedPtr</span> <span class="n">indexBuffer</span> <span class="o">=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareBufferManager</span><span class="o">::</span><span class="n">getSingleton</span><span class="p">().</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">createIndexBuffer</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareIndexBuffer</span><span class="o">::</span><span class="n">IT</span><span class="err">\</span><span class="n">_16BIT</span><span class="p">,</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">vertexCount</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareBuffer</span><span class="o">::</span><span class="n">HBU</span><span class="err">\</span><span class="n">_STATIC</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Получаем</span> <span class="err">блокировку</span> <span class="err">на</span> <span class="err">запись</span> <span class="err">и</span> <span class="err">пишем</span> <span class="err">индексы</span> <span class="err">в</span> <span class="err">буфер</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">uint16</span><span class="err">\</span><span class="n">_t</span> <span class="err">\</span><span class="o">*</span><span class="n">indices</span> <span class="o">=</span> <span class="k">static</span><span class="err">\</span><span class="n">_cast</span><span class="err">\</span><span class="o">&lt;</span><span class="n">uint16</span><span class="err">\</span><span class="n">_t</span> <span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">&gt;</span><span class="p">(</span><span class="n">indexBuffer</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">lock</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">HardwareBuffer</span><span class="o">::</span><span class="n">HBL</span><span class="err">\</span><span class="n">_NORMAL</span><span class="p">));</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Задаем</span> <span class="err">нужный</span> <span class="err">индексы</span> <span class="err">вершин</span><span class="p">,</span> <span class="err">которые</span> <span class="err">будет</span> <span class="err">треугольник</span> <span class="err">представлять</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">записали</span> <span class="o">-</span> <span class="err">разблокировали</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">indexBuffer</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">unlock</span><span class="p">();</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Теперь</span> <span class="err">надо</span> <span class="err">прицепить</span> <span class="err">к</span> <span class="err">нашей</span> <span class="err">геометрии</span> <span class="err">созданный</span> <span class="err">буфер</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">vertexBufferBinding</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">setBinding</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vertexBuffer</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">subMesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">useSharedVertices</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">subMesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">indexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">indexBuffer</span> <span class="o">=</span> <span class="n">indexBuffer</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">subMesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">indexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">indexCount</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">sharedVertexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">vertexCount</span><span class="p">;</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">subMesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">indexData</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">indexStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Если</span> <span class="err">не</span> <span class="err">объявить</span> <span class="err">рамку</span><span class="p">,</span> <span class="err">то</span> <span class="err">огр</span> <span class="err">не</span> <span class="err">сможет</span> <span class="err">правильно</span> <span class="err">обсчитать</span> <span class="err">сетку</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="err">и</span> <span class="err">она</span> <span class="err">будет</span> <span class="err">видна</span> <span class="err">лишь</span> <span class="err">в</span> <span class="err">корневой</span> <span class="err">ноде</span> <span class="p">(</span><span class="err">если</span> <span class="err">ее</span> <span class="err">туда</span> <span class="err">прицепить</span><span class="p">),</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="err">а</span> <span class="err">в</span> <span class="err">дочерних</span> <span class="o">-</span> <span class="err">не</span> <span class="err">будет</span><span class="p">.</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="err">Для</span> <span class="err">этого</span> <span class="err">можно</span> <span class="err">зачитать</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.ogre3d.org/forums/viewtopic.php?f=2&amp;t=60200  </span>
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="err">\</span><span class="n">_setBounds</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">AxisAlignedBox</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">нарисовали</span> <span class="o">-</span> <span class="err">грузим</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mesh</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">load</span><span class="p">();</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="err">А</span> <span class="err">теперь</span> <span class="err">нужно</span> <span class="err">задефайнить</span> <span class="err">материал</span><span class="p">.</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="err">Если</span> <span class="err">этого</span> <span class="err">не</span> <span class="err">сделать</span><span class="p">,</span> <span class="err">то</span> <span class="err">новоиспеченный</span> <span class="err">триангл</span> <span class="err">будет</span> <span class="err">выглядеть</span> <span class="err">белым</span><span class="p">,</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\</span><span class="o">*</span> <span class="err">а</span> <span class="err">не</span> <span class="err">многоцветным</span> <span class="err">как</span> <span class="err">задумано</span> <span class="err">выше</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">MaterialPtr</span> <span class="n">material</span> <span class="o">=</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">MaterialManager</span><span class="o">::</span><span class="n">getSingleton</span><span class="p">().</span><span class="n">create</span><span class="p">(</span><span class="s">"Test/ColourTest"</span><span class="p">,</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">ResourceGroupManager</span><span class="o">::</span><span class="n">DEFAULT</span><span class="err">\</span><span class="n">_RESOURCE</span><span class="err">\</span><span class="n">_GROUP</span><span class="err">\</span><span class="n">_NAME</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">material</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">getTechnique</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">getPass</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">setVertexColourTracking</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">TVC</span><span class="err">\</span><span class="n">_AMBIENT</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="o">/</span><span class="err">\</span><span class="o">*</span> <span class="err">Создаем</span> <span class="err">ноду</span> <span class="err">на</span> <span class="err">базе</span> <span class="err">того</span><span class="p">,</span> <span class="err">что</span> <span class="err">накодили</span> <span class="err">выше</span><span class="p">.</span> <span class="err">\*/</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">Entity</span> <span class="err">\</span><span class="o">*</span><span class="n">entity</span> <span class="o">=</span> <span class="n">mSceneMgr</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">createEntity</span><span class="p">(</span><span class="s">"CustomEntity"</span><span class="p">,</span> <span class="s">"CustomMesh"</span><span class="p">,</span> <span class="s">"General"</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">entity</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">setMaterialName</span><span class="p">(</span><span class="s">"Test/ColourTest"</span><span class="p">,</span> <span class="s">"General"</span><span class="p">);</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">Ogre</span><span class="o">::</span><span class="n">SceneNode</span> <span class="err">\</span><span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">mSceneMgr</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">getRootSceneNode</span><span class="p">()</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">createChildSceneNode</span><span class="p">();</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">node</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">attachObject</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mCamera</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">lookAt</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>  
<span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span> <span class="n">mCamera</span><span class="o">-</span><span class="err">\</span><span class="o">&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="n">Ogre</span><span class="o">::</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span>  
<span class="p">}</span>
</code></pre></div></div>

<p> </p>

<p><a href="https://russianpenguin.files.wordpress.com/2014/11/d180d0b0d0b1d0bed187d0b5d0b5-d0bcd0b5d181d182d0be-1_109.png"><img src="/assets/images/2014/11/d180d0b0d0b1d0bed187d0b5d0b5-d0bcd0b5d181d182d0be-1_109.png?w=300" alt="Ogre3D - использование вертексного буфера" /></a>Чего почитать:</p>

<ul>
  <li>https://grahamedgecombe.com/blog/custom-meshes-in-ogre3d</li>
  <li>http://www.ogre3d.org/forums/viewtopic.php?f=2&amp;t=60200</li>
  <li>http://www.ogre3d.org/tikiwiki/tiki-index.php?page=Generating+A+Mesh</li>
</ul>

<p> </p>

<p> </p>


  </div>

  <h1><a href="/2014/11/03/%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba%d0%b0%d0%b5%d0%bc-dwarf-fortress-%d0%bd%d0%b0-fedora-ubuntu-%d0%b8-%d0%b4%d1%80-x64/">Запускаем Dwarf Fortress на Fedora, Ubuntu и др. x64</a></h1>
  <p class="author">
    <span class="date">2014-11-03 16:42:31 +0300</span>
  </p>
  <div class="content">
   <p>У последнего билда есть несколько бед:</p>

<p>Но сначала надо поставить 32х битные версии нужных либ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>SLD.i686 SDL<span class="se">\_</span>image.i686 openal-soft.i686 SDL<span class="se">\_</span>tff.i686
</code></pre></div></div>

<p>Оно может попросить что-то еще, но что - не помню (у меня до этого было все установлено :)).</p>

<p>Первая беда - это</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Not found: data/art/curses\_640x300.png
</code></pre></div></div>

<p>Эта беда лечится запуском df в виде</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>LD<span class="se">\_</span><span class="nv">PRELOAD</span><span class="o">=</span>/usr/lib/libz.so.1 ./df
</code></pre></div></div>

<p>Вторая - это</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dynamically loading the OpenAL library failed, disabling sound
</code></pre></div></div>

<p>Лечим</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /usr/lib/libopenal.so.1 /usr/lib/libopenal.so  
<span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /usr/lib/libsndfile.so.1 /usr/lib/libsndfile.so  
<span class="nv">$ </span><span class="nb">sudo </span>ldconfig
</code></pre></div></div>

<p>Рубимся :)</p>

<p><a href="https://russianpenguin.files.wordpress.com/2014/11/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_107.png"><img src="/assets/images/2014/11/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_107.png?w=300" alt="Dwart Fortress" /></a>Ссылки</p>

<ul>
  <li>http://www.bay12games.com/dwarves/</li>
  <li>http://www.bay12forums.com/smf/index.php?topic=62159.msg1469273#msg1469273</li>
  <li>http://www.bay12games.com/dwarves/mantisbt/view.php?id=2688</li>
</ul>

  </div>

  <h1><a href="/2014/10/26/%d1%83%d0%b4%d0%b0%d0%bb%d0%b5%d0%bd%d0%bd%d0%b0%d1%8f-%d0%be%d1%82%d0%bb%d0%b0%d0%b4%d0%ba%d0%b0-%d0%b2-google-chromechromium/">Удаленная отладка в Google Chrome/Chromium</a></h1>
  <p class="author">
    <span class="date">2014-10-26 13:23:06 +0300</span>
  </p>
  <div class="content">
   <p>Пока рассмотрим только удаленную отладку комп-комп. Иногда это бывает очень необходимо.</p>

<p>На подопытном запускаем</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>chromium <span class="nt">--remote-debugging-port</span><span class="o">=</span>9222
</code></pre></div></div>

<p>На машине с отдадчиком заходим (ессно в хроме) на урл</p>

<p>http://target-machine:9999</p>

<p>Выбираем страницу - отлаживаем что надо.</p>

<p>К сожалению нельзя осуществлять взаимодействие с подопытной страницей напрямую из отладчика (конечно же можно, если мы будем делать что-то вроде $(‘element’).trigger(‘event-name’) в консоли), но можно перезагружать страницу.</p>

<p>Поэтому на подопытном запускаем тимвьювер или внц и отлаживаем чего надо.</p>

<p>Еще можно добавить параметр –user-data-dir=&lt;тут путь&gt;. Эта опция нужна если для отладки вы хотите пользовать как-то особым образом сконфигурированный профиль.</p>

<p><a href="https://russianpenguin.files.wordpress.com/2014/10/d180d0b0d0b1d0bed187d0b5d0b5-d0bcd0b5d181d182d0be-2_098.png"><img src="/assets/images/2014/10/d180d0b0d0b1d0bed187d0b5d0b5-d0bcd0b5d181d182d0be-2_098.png?w=300" alt="Удаленная отладка с Chrome" /></a></p>


  </div>

  <h1><a href="/2014/10/20/%d0%bd%d0%b5%d1%81%d0%ba%d0%be%d0%bb%d1%8c%d0%ba%d0%be-%d1%81%d0%be%d0%b2%d0%b5%d1%82%d0%be%d0%b2-%d0%bf%d0%be-%d0%be%d0%bf%d1%82%d0%b8%d0%bc%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d0%b8-%d0%bf%d1%80%d0%b8/">Несколько советов по оптимизации приложений на Angular JS</a></h1>
  <p class="author">
    <span class="date">2014-10-20 21:14:53 +0400</span>
  </p>
  <div class="content">
   <h2 id="что-нам-потребуется">Что нам потребуется.</h2>

<h3 id="angularjs">AngularJS</h3>

<p>Версия &lt; 1.3</p>

<p>В версии 1.3 появились существенные отличия. Включая однонаправленный биндинг - :: (два двоеточия), но она несовместима с bindonce.</p>

<p>Хотя по скорости ничем не уступает оптимизированному варианту. Если вы используете &gt;= 1.3, то применяйте готовый однонаправленный биндинг вместо bo-*</p>

<h3 id="bindonce">Bindonce</h3>

<p>url: <a href="https://github.com/Pasvaz/bindonce" title="Bindonce">https://github.com/Pasvaz/bindonce</a></p>

<p>Эта библиотека позволяет делать однонаправленный биндинг данных в шаблоны.<br />
Если вам не требуется, чтобы какая-то переменная после своего отображения меняла значение (т.е. она не будет его менять в процессе работы), то это однозначно для вас.</p>

<p>Например у нас есть список книг, который приходит с сервера и обновляется целиком (опять же с сервера).<br />
Что мы делаем в коде</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;div</span> <span class="na">ng-repeat=</span><span class="s">"book in books"</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;span</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;/span</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;div</span><span class="err">\</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Имя книги не меняется и мы можем записать так</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;div</span> <span class="na">ng-repeat=</span><span class="s">"book in books"</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;span</span> <span class="na">bo-text=</span><span class="s">"book.name"</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;/span</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;div</span><span class="err">\</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Так как при перезагрузке книг список books будет изменен полностью, то дерево будет перестроено заново и нам не нужно никак заботиться о том, что имя изменится.</p>

<p>Однако, если вы используете sly-repeat (ниже), то его нельзя сочетать с bindonce из-за агрессивного кеширования дерева дом этим самым слайрепитом.</p>

<h3 id="scalyr">Scalyr</h3>

<p>url: <a href="https://github.com/scalyr/angular" title="Scalyr">https://github.com/scalyr/angular</a></p>

<p>post: <a href="http://blog.scalyr.com/2013/10/31/angularjs-1200ms-to-35ms/" title="Blogpost about scalyr">http://blog.scalyr.com/2013/10/31/angularjs-1200ms-to-35ms/</a></p>

<p>Эта библиотека позволит вам минимизировать количество одновременно работающих вотчеров путем отключения ненужных. А так же реализовать умный ng-repeat с кешированием созданных dom-элементов (который, увы, не сильно дружит с bindonce. т.е. не дружит вовсе).</p>

<h2 id="оптимизации">Оптимизации</h2>

<h3 id="много-скрытых-элементов-на-странице">Много скрытых элементов на странице</h3>

<p>Это одна из ключевых оптимизаций для проекта. Так как нам часто приходится скрывать/показывать разные элементы.</p>

<p>Представим, что у нас есть какой-то код типа нижеследующего.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;div</span> <span class="na">ng-show=</span><span class="s">"condition"</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="c">&lt;!-- а тут много разных строчек с данными, которые выводятся на базе данных из ангуляра --\&gt;\&lt;/div\&gt;
</span></code></pre></div></div>

<p>Если не предпринять дополнительных действий, то все то, что написано внутри скрытого дива будет выполняться (!), а это лишние такты процессора и нервные подергивания пользователя.</p>

<p>Что же мы можем сделать?</p>

<p>На помощь нам приходит sly-show+sly-prevent-evaluation-when-hidden. Эта убойная комбинация не будет запускать интерпретацию скрытых элементов.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;div</span> <span class="na">sly-show=</span><span class="s">"condition"</span> <span class="na">sly-prevent-evaluation-when-hidden</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="c">&lt;!-- а тут много разных строчек с данными, которые выводятся на базе данных из ангуляра --\&gt;\&lt;/div\&gt;
</span></code></pre></div></div>

<p>Переписав код таким образом мы получим тот самый профит: снижение нагрузки на клиент-сайд.</p>

<p>Но стоит заметить одну особенность директивы: она в своем решении интерпретировать или нет вложенный код опирается на наличие класса ng-hide. При инициализации приложения или перерисовке элементов этого класса нет. Поэтому мы можем увидеть что-то вроде этого:</p>

<p><a href="https://russianpenguin.files.wordpress.com/2014/10/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_092.png"><img src="/assets/images/2014/10/d0b2d18bd0b4d0b5d0bbd0b5d0bdd0b8d0b5_092.png?w=300" alt="Trace angular application" /></a></p>

<p>Причина проста: у элементов при инициализации еще нет класса ng-hide. Он появится только после того, как отработают нужны контроллеры, а значит, что отрисовка элемента с нуля всегда будет отрисовывать и интерпретировать все скрываемые элементы (даже если они действительно скрыты).</p>

<p>Решение проблемы: принудительно добавить класс ng-hide всем элементам, которые находятся под связкой sly-show+sly-prevent-evaluation-when-hidden.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ng-hide"</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="c">&lt;!-- а тут много разных строчек с данными, которые выводятся на базе данных из ангуляра --\&gt;\&lt;/div\&gt;
</span></code></pre></div></div>

<p>На этом оптимизация неиспользуемого кода закончена.</p>

<h3 id="оптимизация-биндингов">Оптимизация биндингов</h3>

<p>Под этим подразумевается однократное добавление в шаблон переменной.</p>

<p>Как в примере bindonce с книгами (выше) нам может не требоваться функционал двунаправленного отображения.</p>

<p>Поэтому все подобные участки мы заменяем однонаправленным биндингом.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> -\&gt; \&lt;div bo-text=”var”\&gt;\&lt;/div\&gt;
</code></pre></div></div>

<p>Путь оптимизации: вместо элемента создается контейнер, на который выполняется отображение текста элемента. Так как в биндванс не существует шаблонной конструкции для биндинга. Естественно, что там может быть любой тег и не обязательно div. Самое главное - наличие контейнера.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ng-href="text" -\&gt; bo-href="’text’ + var"
</code></pre></div></div>

<p>А так мы оптимизировали ссылки.<br />
Важно заметить, что ng-* и bo-* работают с биндингами различным образом: если первый работает по внутриангуляровским правилам интепретации, то второй просто выполняет .eval() на строку. Поэтому в bo-* мы работаем с обычными строками и переменными.</p>

<p>Аналогичным образом работаем и с другими атрибутами. Если есть аналог биндинга.</p>

<p>Если аналога нет, то используем конструкцию bo-attr-&lt;имя кастомного атрибута&gt;</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\<span class="nt">&lt;div</span> <span class="na">bo-attr</span> <span class="na">bo-attr-isbn=</span><span class="s">"’’"</span><span class="err">\</span><span class="nt">&gt;</span>\<span class="nt">&lt;/div</span><span class="err">\</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Здесь кроется еще одна важная особенность обработки атрибутов библиотекой: они рассматриваются как строки. И если в атрибуте текст, что его надо представить в виде текста (то же характерно для любого юиндига bo-*). Мы привыкли чаще всего работать с числами, но не стоит забывать, что есть еще буквы.</p>

<p>Поэтому если не уверены в содержимом переменной - пишите строковое предствление: <em>‘’</em>, а не <em>var</em>.</p>

<h3 id="вложенность-элементов">Вложенность элементов</h3>

<p>На картинке профайлера (выше) вы можете увидеть гребенку из кучи вложенных вызовов функций. Если мы посмотрим на эти вывовы под микроскопом отладчиком, то увидим, что это рекурсивный обход дерева dom.</p>

<p>Чем меньше у вас уровней вложенности, тем лучше. Особенно это касается кода, который расположен в циклах.</p>

<p>Так что старайтесь сократить вложенности.</p>

<h3 id="дополнительная-оптимизация-при-обработке-скрытых-элементов">Дополнительная оптимизация при обработке скрытых элементов</h3>

<p>У sly-prevent-evaluation-when-hidden есть одна большая проблема: она опирается только на наличие класса ng-hide, что не совсем уместно если видимость элемента контролируется каким-то другим классом.</p>

<p>В таком случае можно (вообще нужно всегда) использовать следующее расширение директивы (подключаем после подключения scalyr).</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span>  
<span class="err">\</span><span class="o">*</span> <span class="nx">Extended</span> <span class="nx">version</span> <span class="k">of</span> <span class="nx">slyPreventEvaluationWhenHidden</span> <span class="k">from</span> <span class="nx">scalyr</span><span class="p">.</span>  
<span class="err">\</span><span class="o">*</span> <span class="nx">This</span> <span class="nx">version</span> <span class="nx">prevent</span> <span class="nx">evaluation</span> <span class="nx">not</span> <span class="nx">only</span> <span class="nx">when</span> <span class="nx">element</span> <span class="nx">has</span> <span class="kd">class</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">hide</span><span class="p">.</span>  
<span class="err">\</span><span class="o">*</span> <span class="nx">If</span> <span class="nx">element</span> <span class="nx">is</span> <span class="nx">hidden</span> <span class="kd">with</span> <span class="dl">"</span><span class="s2">display: none</span><span class="dl">"</span> <span class="nx">evaluation</span> <span class="nx">is</span> <span class="nx">prevented</span><span class="p">.</span>  
<span class="err">\</span><span class="o">*</span><span class="sr">/ </span><span class="err"> 
</span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="dl">'</span><span class="s1">sly</span><span class="dl">'</span><span class="p">)</span>  
 <span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="dl">'</span><span class="s1">slyPreventEvaluationWhenHidden</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>  
 <span class="k">return</span> <span class="p">{</span>  
 <span class="na">restrict</span><span class="p">:</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">,</span>  
 <span class="c1">// We create a new scope just because it helps segment the gated watchers  </span>
 <span class="c1">// from the parent scope. Unclear if this is that important for perf.  </span>
 <span class="na">scope</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>  
 <span class="na">compile</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">tElement</span><span class="p">,</span> <span class="nx">tAttrs</span><span class="p">)</span> <span class="p">{</span>  
 <span class="k">return</span> <span class="p">{</span>  
 <span class="c1">// We need a separate pre-link function because we want to modify the scope before any of the  </span>
 <span class="c1">// children are passed it.  </span>
 <span class="na">pre</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">preLink</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>  
 <span class="nx">scope</span><span class="p">.</span><span class="nx">$addWatcherGate</span><span class="p">(</span><span class="kd">function</span> <span class="nx">hiddenChecker</span><span class="p">()</span> <span class="p">{</span>  
 <span class="c1">// Should only return true if the element is not hidden.  </span>
 <span class="k">return</span> <span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="dl">'</span><span class="s1">ng-hide</span><span class="dl">'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="dl">"</span><span class="s2">:visible</span><span class="dl">"</span><span class="p">)</span> <span class="p">;</span>  
 <span class="p">},</span> <span class="kd">function</span> <span class="nx">hiddenDecider</span><span class="p">(</span><span class="nx">watchExpression</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">equality</span><span class="p">,</span> <span class="nx">directiveName</span><span class="p">)</span> <span class="p">{</span>  
 <span class="c1">// Make an exception for slyShow.. do not gate its watcher.  </span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">isDefined</span><span class="p">(</span><span class="nx">directiveName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">directiveName</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">slyShow</span><span class="dl">'</span><span class="p">))</span>  
 <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>  
 <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>  
 <span class="p">});</span>  
 <span class="p">},</span>  
 <span class="p">};</span>  
 <span class="p">},</span>  
 <span class="p">};</span>  
 <span class="p">});</span>
</code></pre></div></div>


  </div>


<!-- Pagination links -->
<div class="pagination">
  
    <a href="/blog/page21/" class="previous">Назад</a>
  
  <span class="page_number ">Страница: 22 из 35</span>
  
    <a href="/blog/page23/" class="next">Далее</a>
  
</div>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
