<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>PUPPI DEPLOY INSTRUCTIONS | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="PUPPI DEPLOY INSTRUCTIONS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<meta property="og:description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<link rel="canonical" href="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/puppi/README_deploy/" />
<meta property="og:url" content="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/puppi/README_deploy/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PUPPI DEPLOY INSTRUCTIONS" />
<script type="application/ld+json">
{"url":"http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/puppi/README_deploy/","description":"Записная книжка рассеянного [в пространстве и времени] программиста","headline":"PUPPI DEPLOY INSTRUCTIONS","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">PUPPI DEPLOY INSTRUCTIONS</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="puppi-deploy-instructions">PUPPI DEPLOY INSTRUCTIONS</h1>
<p>Documentation and examples related to the puppi actions: deploy, rollback and init</p>

<h2 id="synopsis-command-line">SYNOPSIS (COMMAND LINE)</h2>
<p>Shell command to launch a deploy:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy &lt;project_name&gt;
    puppi deploy &lt;project_name&gt; [-f] [-i] [-t] [-d yes|full] [-r yes|no|fail] [-p "parameter=value parameter2=value2"]
</code></pre></div></div>

<p>Shell command to launch a rollback:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi rollback &lt;project_name&gt; 
</code></pre></div></div>

<p>Shell command to launch the first deploy:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi init &lt;project_name&gt;
</code></pre></div></div>

<h2 id="examples-cli">EXAMPLES (cli)</h2>

<p>Deploy myapp with the standard logic/parameters defined in Puppet:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy myapp
</code></pre></div></div>

<p>Deploy myapp and doesn’t stop in case of Critical errors:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy myapp -f
</code></pre></div></div>

<p>Deploy myapp in interactive mode. Confirmation is asked for each step</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy myapp -i
</code></pre></div></div>

<p>Test mode. Just show the commands that would be executed</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy myapp -t
</code></pre></div></div>

<p>Deploy myapp with full debugging output</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy myapp -d full
</code></pre></div></div>

<p>Deploy myapp in interactive mode and sets some custom options that override the standard Puppet params.
Note that these parameters change according to the script you use (and the scripts must honour this override in order to make this option work).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi deploy myapp -i -o "version=1.1 source_url=http://dev.example42.com/code/my_app/"
</code></pre></div></div>

<p>Make the first deploy of “myapp”. Can be optional and may require a subsequent puppi deploy myapp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi init myapp
</code></pre></div></div>

<p>Rollback myapp to a previous archived state. User is asked to choose which deploy to override. Note that by default you have 5 backups to rollback from. Older backups are automatically removed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi rollback myapp
</code></pre></div></div>

<p>Automatically rollback to the latest saved state (unattended).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi rollback myapp latest
</code></pre></div></div>

<h2 id="examples-puppet">EXAMPLES (puppet)</h2>
<p>Here follow some sample defines you can use out of the box in your manifests once you include puppi.
Get a war from $source and deploy it in $deploy_root:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::project::war { 'myapp':
      source           =&gt; 'http://repo.example42.com/deploy/prod/myapp.war',
      deploy_root      =&gt; '/store/tomcat/myapp/webapps',
    }
</code></pre></div></div>

<p>Get a tarball from $source, unpack it in $deploy_root, restart service called apache and send a mail
to $report_mail (you can have a comma separated list of destination addresses):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::project::tar { 'mysite':
      source           =&gt; 'rsync://repo.example42.com/deploy/prod/release.tgz',
      init_script      =&gt; 'apache',
      deploy_root      =&gt; '/var/www/html/',
      report_email     =&gt; 'sysadmins@example42.com',
      enable           =&gt; 'true', # Redundant
    }
</code></pre></div></div>

<p>Get a tarfile with a .sql query file and apply to to you local Mysql with the credentials provided:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::project::mysql { 'myweb_sql':
      source          =&gt; 'http://repo.example42.com/deploy/prod/database.sql.gz',
      mysql_user      =&gt; 'myweb',
      mysql_password  =&gt; $secret::mysql_myweb_pw,
      mysql_host      =&gt; 'localhost',
      mysql_database  =&gt; 'myweb',
      report_email    =&gt; 'sysadmins@example42.com,dbadmins@example42.com',
      enable          =&gt; 'true',
    }
</code></pre></div></div>

<p>Get a list of files from $source, retrieve the actual files from $source_baseurl and place them
in $deploy_root:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::project::files { 'gfxupdates':
      source           =&gt; 'http://deploy.example42.com/prod/website2/list.txt',
      source_baseurl   =&gt; 'http://design.example42.com/website2/gfx/',
      deploy_root      =&gt; '/var/www/html/gfx',
      report_email     =&gt; 'sysadmins@example42.com,designers@example42.com',
      enable           =&gt; 'true',
    }
</code></pre></div></div>

<p>Deploy from a Nexus repository (retrieve maven-metadata.xml from dir specified in $source), get the war 
(version is achieved from the “release” tag in the xml) and deploy it in $deploy_root and then restart tomcat.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::project::maven { 'supersite':
      source           =&gt; 'http://nexus.example42.com/nexus/content/repositories/releases/it/example42/supersite/',
      deploy_root      =&gt; '/usr/local/tomcat/supersite/webapps',
      init_script      =&gt; 'tomcat',
      report_email     =&gt; 'sysadmins@example42.com',
      enable           =&gt; 'true',
    }
</code></pre></div></div>

<p>Get the maven-metadata.xml from a Nexus repository and deploy:</p>
<ul>
  <li>The release war in $deploy_root</li>
  <li>A configurations tarball tagged with the Maven qualifier $config_suffix in $config_root</li>
  <li>
    <p>A static files tarball tagged with the Maven qualifier $document_suffix in $document_root</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  puppi::project::maven { 'supersite':
    source           =&gt; 'http://nexus.example42.com/nexus/content/repositories/releases/it/example42/supersite/',
    deploy_root      =&gt; '/usr/local/tomcat/supersite/webapps',
    config_suffix    =&gt; 'cfg',
    config_root      =&gt; '/srv/htdocs/supersite',
    document_suffix  =&gt; 'css',
    document_root    =&gt; '/srv/htdocs/supersite',
    init_script      =&gt; 'tomcat',
    report_email     =&gt; 'sysadmins@example42.com',
    enable           =&gt; 'true',
  }
</code></pre></div>    </div>
  </li>
</ul>

<p>The same deploy Nexus repository with some more options:</p>
<ul>
  <li>A Source dir to be used to deploy static files when issuing “puppi init supersite”</li>
  <li>A block from a loadbalancer IP (managing different sites addresess)</li>
  <li>Some more elaborate rsync exclusion rules</li>
  <li>
    <p>A backup retention of 3 archives (instead of the default 5)</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  puppi::project::maven { 'supersite':
    source           =&gt; 'http://nexus.example42.com/nexus/content/repositories/releases/it/example42/supersite/',
    deploy_root      =&gt; '/usr/local/tomcat/supersite/webapps',
    config_suffix    =&gt; 'cfg',
    config_root      =&gt; '/srv/htdocs/supersite',
    document_suffix  =&gt; 'css',
    document_root    =&gt; '/srv/htdocs/supersite',
    document_init_source =&gt; 'rsync://backup.example42.com/initdir/supersite/',
    firewall_src_ip  =&gt; $site ? {
        dr      =&gt; '192.168.101.1/30',
        main    =&gt; '192.168.1.1/30',
    },
    backup_rsync_options =&gt; '--exclude .snapshot --exclude /doc_root/autojs/*** --exclude /doc_root/autocss/*** --exclude /doc_root/xsl',
    backup_retention =&gt; '3',
    init_script      =&gt; 'tomcat',
    report_email     =&gt; 'sysadmins@example42.com',
    enable           =&gt; 'true',
  }
</code></pre></div>    </div>
  </li>
</ul>

<p>An elaborated war deploy:</p>
<ul>
  <li>get from $source,</li>
  <li>execute /usr/local/bin/mychecks.sh as root before the deploy
(or better with sequence number 39)</li>
  <li>deploy to /data/tomcat/myapp/webapps as user pippo</li>
  <li>stop and start tomcat-myapp but also monit and puppet</li>
  <li>
    <p>backup passing  $backup_rsync_options to rsync:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  puppi::project::war { 'myapp':
    source                  =&gt; 'http://repo.example42.com/deploy/prod/myapp.war',
    deploy_root             =&gt; '/store/tomcat/myapp/webapps',
    predeploy_customcommand =&gt; '/usr/local/bin/mychecks.sh',
    predeploy_priority      =&gt; '39',
    predeploy_user          =&gt; 'root',
    backup_rsync_options    =&gt; '--exclude logs/',
    user                    =&gt; 'pippo',
    init_script             =&gt; 'tomcat-myapp',
    deploy_root             =&gt; '/data/tomcat/myapp/webapps',
    report_email            =&gt; 'sysadmins@example42.com',
    disable_services        =&gt; 'monit puppet',
  } An example of usage of the generic builder define to deploy a zip file, with an example custom post deploy command executed as root (as all puppi commands, if not specified otherwise)

  puppi::project::builder { 'cms':
    source                   =&gt; 'http://repo.example42.com/deploy/cms/cms.zip',
    source_type              =&gt; 'zip',
    user                     =&gt; 'root',
    deploy_root              =&gt; '/var/www',
    postdeploy_customcommand =&gt; 'chown -R www-data /var/www/files',
    postdeploy_user          =&gt; 'root',
    postdeploy_priority      =&gt; '41',
    report_email             =&gt; 'sysadmins@example42.com',
    enable                   =&gt; 'true',
  }
</code></pre></div>    </div>
  </li>
</ul>

<p>These are just examples, possibilities are many, refer to the docs in puppi/manifests/project/*.pp
to have a full list of the available options.</p>

<h2 id="basic-puppi-defines">BASIC PUPPI DEFINES</h2>
<p>The above puppi::projects defines manage more or less complex deployments procedures for different kind of projects. They are just samples of possible procedures and you may create your one ones, if the ones provided there don’t fit your needs.
They will have to contain one or more of these basic puppi defines.</p>

<p>Create the main project structure. One or more different deployment projects can exist on a node.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::project
</code></pre></div></div>

<p>Create a single command to be placed in the init sequence. It’s not required for every project.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::initialize
</code></pre></div></div>

<p>Create a single command to be placed in the deploy sequence. More than one is generally needed for each project.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::deploy
</code></pre></div></div>

<p>Create a single command to be placed in the rollback sequence. More than one is generally needed for each project.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     puppi::rollback
</code></pre></div></div>

<p>These defines have generally a standard structure and similar arguments.
Every one is reversable (enable =&gt; false) but you can wipe out the whole /etc/puppi directory
to have it rebuilt from scratch. Here is an example for a single deploy command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    puppi::deploy { 'Retrieve files':       # The $name of the define is used in the file name
      command  =&gt; 'get_curl.sh',          # The name of the general-use script to use
      argument =&gt; 'file:///storage/file', # The argument(s) passed to the above script
      priority =&gt; '10',                   # Lower priority scripts are executed first
      user     =&gt; 'root',                 # As what user we run the script
      project  =&gt; 'my-web.app',           # The name of the project to use
    }
</code></pre></div></div>

<p>This define creates a file named:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /etc/puppi/projects/${project}/deploy/${priority}-${name}
</code></pre></div></div>

<p>Its content is, simply:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    su - ${user} -c "export project=${project} &amp;&amp; /etc/puppi/scripts/${command} ${arguments}"
</code></pre></div></div>

<h2 id="deploy-procedures-defines">DEPLOY PROCEDURES DEFINES</h2>
<p>The puppi module provides some examples of deploy workflows they are in the puppi/manifests/project
directory and contain simple to use defines that contain one puppi::project and several puppi::deploy and
puppi::rollback defines to design a specific workflow using the builtin commands present in
puppi/files/scripts.
Note that if you need to design your own deploy procedure you have different options:</p>
<ul>
  <li>Verify if you can reuse the existing ones, using optional arguments as pre/postdeploy_commands</li>
  <li>Use the existing ones as a base to make you own custom defines, reusing parts of their logic 
and the builtin commands (puppi/files/scripts/*) they use</li>
  <li>Write your own commands (in whatever language) and integrate them in your own procedure.</li>
</ul>

<p>Here follow the main and most reusable deploy workflows defines available in puppi/manifests/project/.
The have generally a set of common arguments that make you manage if to stop and restart specific 
services, if you want to isolate your server from a loadbalancer during the deploy procedure, what to backup,
how many backup copies to mantain, if to send a report mail to specific addresses and if you need
to run custom commands during the standard procedure.
For all of the you have to specify a source from where to get the source files (http/ftp/rsync/file..) 
a directory where to place them and the user that has to own the deploy files.
Full documentation is available in the relevant .pp files</p>

<ul>
  <li>puppi::project::tar - Use this to retrieve and deploy a simple tar file</li>
  <li>puppi::project::war - Use this to retrieve and deploy a war</li>
  <li>puppi::project::files - Use this to deploy one or more files based on a provided list</li>
  <li>puppi::project::dir - Use this to syncronize a remote directory to a local deploy one</li>
  <li>puppi::project::mysql - Use this to retrive and apply a .sql file for mysql schema updates</li>
  <li>puppi::project::maven - Use this to deploy war and tar files generated via Maven released on Nexus or similar. A good source of Open Source Java artifacts is http://www.artifact-repository.org/</li>
  <li>puppi::project::builder - This is a general purpose define that incorporates most the of cases provided by the above procedures</li>
</ul>

<h2 id="builtin-commands">BUILTIN COMMANDS</h2>
<p>The puppi/files/scripts directory in the module contains some general usage “native” bash scripts
that can be used in custom deployments. They are generally made to work together according to a
specific logic, which is at the base of the deploy procedures defines in puppi/manifests/project/
but you’re free to write your own scripts, in whatever language, according to your needs.</p>

<p>The default scripts are engineered to follow these steps for a deployment:</p>
<ul>
  <li>Remote files are downloaded in /tmp/puppi/$project/store or directly in the predeploy
directory: /tmp/puppi/$project/deploy</li>
  <li>If  necessary the downloaded files are expanded in one or more predeploy directories
(default:/tmp/puppi/$project/deploy).</li>
  <li>Runtime configuration entries might be saved in /tmp/puppi/$project/config</li>
  <li>Files are eventually backed from the deploy directory (Apache’ docroot, Tomcat webapps or whatever)
to the archive directory (/var/lib/puppi/archive/$project). Older backups are deleted (by default
there’s a retention of 5 backups).</li>
  <li>Files are copied from the predeploy directory to the deploy dir.</li>
  <li>Relevant services are eventually stopped and started</li>
</ul>

<p>The most used common scripts are (they might have different arguments, some of them are quite simple):</p>
<ul>
  <li>get_file.sh - Retrieves a file via ssh/http/rsync/svn and places it in a temp dir (store or predeploy)</li>
  <li>deploy.sh - Copies the files in the predeploy dir to deploy dir</li>
  <li>archive.sh - Backups and restores files in deploy dir</li>
  <li>service.sh - Stops or starts one or more services</li>
  <li>wait.sh - Waits for the presence or absence of a file, for the presence of a string in a file or a defined number or seconds.</li>
  <li>get_metadata.sh - Extracts metadata from various sources in order to provide info to other scripts. These info are save in the Runtime configuration file (/tmp/puppi/$project/config)</li>
  <li>report_mail.sh - Sends a mail with the report of the operations done</li>
</ul>

<p>General functions, used by both the puppi command and these scripts, are in puppi/files/scripts/functions</p>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
