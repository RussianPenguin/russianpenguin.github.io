<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Puppet types for concatenating data via a template | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Puppet types for concatenating data via a template" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<meta property="og:description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<link rel="canonical" href="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/datacat/" />
<meta property="og:url" content="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/datacat/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Puppet types for concatenating data via a template" />
<script type="application/ld+json">
{"headline":"Puppet types for concatenating data via a template","description":"Записная книжка рассеянного [в пространстве и времени] программиста","@type":"WebPage","url":"http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/datacat/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Puppet types for concatenating data via a template</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="puppet-types-for-concatenating-data-via-a-template">Puppet types for concatenating data via a template</h1>

<p>The <code class="language-plaintext highlighter-rouge">datacat</code> and <code class="language-plaintext highlighter-rouge">datacat_fragment</code> types allow you to build up a data
structure which is rendered using a template.  This is similar to some of the
common concatenation patterns though the intent should be clearer as it pushes
the boilerplate down into the type.</p>

<p><a href="https://travis-ci.org/richardc/puppet-datacat"><img src="https://travis-ci.org/richardc/puppet-datacat.png" alt="Build Status" /></a></p>

<h2 id="sample-usage">Sample Usage</h2>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">datacat</span> <span class="p">{</span> <span class="s1">'/etc/nagios/objects/hostgroups.cfg'</span><span class="p">:</span>
  <span class="py">template</span> <span class="p">=&gt;</span> <span class="s2">"</span><span class="nv">${module_name}</span><span class="s2">/hostgroups.cfg.erb"</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">datacat_fragment</span> <span class="p">{</span> <span class="s2">"</span><span class="nv">${::fqdn}</span><span class="s2"> in device hostgroup"</span><span class="p">:</span>
  <span class="py">target</span> <span class="p">=&gt;</span> <span class="s1">'/etc/nagios/objects/hostgroups.cfg'</span><span class="p">,</span>
  <span class="py">data</span>   <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="py">device</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="nv">$::fqdn</span> <span class="p">],</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="c"># fred.dc1.notreal has an ilo fred-ilo.dc1.notreal
</span><span class="nv">$ilo_fqdn</span> <span class="o">=</span> <span class="nf">regsubst</span><span class="p">(</span><span class="nv">$::fqdn</span><span class="p">,</span> <span class="s1">'\.'</span><span class="p">,</span> <span class="s1">'-ilo.'</span><span class="p">)</span>
<span class="n">datacat_fragment</span> <span class="p">{</span> <span class="s2">"</span><span class="nv">${ilo_fqdn}</span><span class="s2"> in device hostgroup"</span><span class="p">:</span>
  <span class="py">target</span> <span class="p">=&gt;</span> <span class="s1">'/etc/nagios/objects/hostgroups.cfg'</span><span class="p">,</span>
  <span class="py">data</span>   <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="py">device</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="nv">$ilo_fqdn</span> <span class="p">],</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And then in your <code class="language-plaintext highlighter-rouge">hostgroups.cfg.erb</code></p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code># hostgroups.cfg.erb
<span class="cp">&lt;%</span> <span class="vi">@data</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">hostgroup</span><span class="o">|</span> <span class="cp">%&gt;</span>
define hostgroup {
    name <span class="cp">&lt;%=</span> <span class="n">hostgroup</span> <span class="cp">%&gt;</span>
    members <span class="cp">&lt;%=</span> <span class="vi">@data</span><span class="p">[</span><span class="n">hostgroup</span><span class="p">].</span><span class="nf">sort</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span> <span class="cp">%&gt;</span>
}
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Will produce something like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /etc/nagios/objects/hostgroups.cfg
define hostgroup {
    name device
    members fred.dc1.notreal,fred-ilo.dc1.notreal
}
</code></pre></div></div>

<p>There are additional samples in a blog post I wrote to describe the approach,
http://richardc.unixbeard.net/2013/02/puppet-concat-patterns/</p>

<h2 id="types-and-definitions">Types and Definitions</h2>

<h2 id="defined-type-datacat">Defined Type: <code class="language-plaintext highlighter-rouge">datacat</code></h2>

<p>Wraps the <code class="language-plaintext highlighter-rouge">datacat_collector</code> and <code class="language-plaintext highlighter-rouge">file</code> types to cover the most common
use-case, collecting data for and templating an entire file.</p>

<p>The <code class="language-plaintext highlighter-rouge">ensure</code> parameter defaults to <code class="language-plaintext highlighter-rouge">file</code> (an alias for <code class="language-plaintext highlighter-rouge">present</code>). <code class="language-plaintext highlighter-rouge">ensure</code>
can be set to <code class="language-plaintext highlighter-rouge">absent</code>. In that case <code class="language-plaintext highlighter-rouge">datacat</code> will make sure the file <em>does
not exist</em> and will not collect anything with <code class="language-plaintext highlighter-rouge">datacat_collector</code>.</p>

<h2 id="type-datacat_collector">Type: <code class="language-plaintext highlighter-rouge">datacat_collector</code></h2>

<p>The <code class="language-plaintext highlighter-rouge">datacat_collector</code> type deeply merges a data hash from
the <code class="language-plaintext highlighter-rouge">datacat_fragment</code> resources that target it.</p>

<p>These fragments are then rendered via an erb template specified by the
<code class="language-plaintext highlighter-rouge">template_body</code> parameter and used to update the <code class="language-plaintext highlighter-rouge">target_field</code> property
of the related <code class="language-plaintext highlighter-rouge">target_resource</code>.</p>

<p>Sample usage:</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">datacat_collector</span> <span class="p">{</span> <span class="s1">'open_ports'</span><span class="p">:</span>
  <span class="py">template_body</span>   <span class="p">=&gt;</span> <span class="s1">'&lt;%= @data["ports"].sort.join(",") %&gt;'</span><span class="p">,</span>
  <span class="py">target_resource</span> <span class="p">=&gt;</span> <span class="nc">File_line</span><span class="p">[</span><span class="s1">'open_ports'</span><span class="p">],</span>
  <span class="py">target_field</span>    <span class="p">=&gt;</span> <span class="s1">'line'</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">datacat_fragment</span> <span class="p">{</span> <span class="s1">'open webserver'</span><span class="p">:</span>
  <span class="py">target</span> <span class="p">=&gt;</span> <span class="s1">'open_ports'</span><span class="p">,</span>
  <span class="py">data</span>   <span class="p">=&gt;</span> <span class="p">{</span> <span class="py">ports</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="m">80</span><span class="p">,</span> <span class="m">443</span> <span class="p">]</span> <span class="p">},</span>
<span class="p">}</span>

<span class="n">datacat_fragment</span> <span class="p">{</span> <span class="s1">'open ssh'</span><span class="p">:</span>
  <span class="py">target</span> <span class="p">=&gt;</span> <span class="s1">'open_ports'</span><span class="p">,</span>
  <span class="py">data</span>   <span class="p">=&gt;</span> <span class="p">{</span> <span class="py">ports</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="m">22</span> <span class="p">]</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="caveats">Caveats</h2>

<p>The template is evaluated by the agent at the point of catalog evaluation,
this means you cannot call out to puppet parser functions as you would when
using the usual <code class="language-plaintext highlighter-rouge">template()</code> function.</p>

<h2 id="copyright-and-license">Copyright and License</h2>

<p>Copyright (C) 2013 Richard Clamp</p>

<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre></div></div>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
