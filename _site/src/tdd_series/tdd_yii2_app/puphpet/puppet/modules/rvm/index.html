<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Puppet Module for Ruby Version Manager (RVM) | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Puppet Module for Ruby Version Manager (RVM)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<meta property="og:description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<link rel="canonical" href="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/rvm/" />
<meta property="og:url" content="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/rvm/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Puppet Module for Ruby Version Manager (RVM)" />
<script type="application/ld+json">
{"url":"http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/rvm/","description":"Записная книжка рассеянного [в пространстве и времени] программиста","headline":"Puppet Module for Ruby Version Manager (RVM)","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Puppet Module for Ruby Version Manager (RVM)</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="puppet-module-for-ruby-version-manager-rvm">Puppet Module for Ruby Version Manager (RVM)</h1>

<p><a href="https://travis-ci.org/maestrodev/puppet-rvm"><img src="https://travis-ci.org/maestrodev/puppet-rvm.svg?branch=maestrodev" alt="Build Status" /></a>
<a href="https://forge.puppetlabs.com/maestrodev/rvm"><img src="https://img.shields.io/puppetforge/v/maestrodev/rvm.svg" alt="Puppet Forge" /></a>
<a href="https://forge.puppetlabs.com/maestrodev/rvm"><img src="https://img.shields.io/puppetforge/f/maestrodev/rvm.svg" alt="Puppet Forge" /></a></p>

<p>This module handles installing system RVM (also known as multi-user installation
as root) and using it to install rubies and gems.  Support for installing and
configuring passenger is also included.</p>

<p>We are actively using this module.  It works well, but does have some issues you
should be aware of.  Due to the way puppet works, certain resources
(rvm_sytem_ruby, rvm_gem and rvm_gemset) may generate errors until RVM is
installed.  You may want to use run stages to install RVM before the rest
of your configuration runs.  However, if you run puppet using the <code class="language-plaintext highlighter-rouge">--noop</code>
parameter, you may see <em>Could not find a default provider</em> errors.  See the
Troubleshooting section for more information.</p>

<p>Please read the troubleshooting section below before opening an issue.</p>

<h2 id="system-requirements">System Requirements</h2>

<p>Puppet 3.0.0 or higher.</p>

<h2 id="upgrading">Upgrading</h2>

<ul>
  <li>1.12: uses <a href="https://forge.puppetlabs.com/golja/gnupg">golja-gnupg</a> module
to manage the installation of the gpg key.</li>
  <li>1.5: no longer includes a dependency on puppetlabs/apache, you must install it yourself
if you want to use the passenger module.</li>
</ul>

<h2 id="add-puppet-module">Add Puppet Module</h2>

<p>Before you begin, you must add the RVM module to your Puppet installation.  This can be done with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ puppet module install maestrodev/rvm
</code></pre></div></div>

<p>You may now continue configuring RVM resources.</p>

<h2 id="install-rvm-with-puppet">Install RVM with Puppet</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class { '::rvm': }
</code></pre></div></div>

<p>This will install RVM into <code class="language-plaintext highlighter-rouge">/usr/local/rvm</code>.</p>

<p>To use RVM without sudo, users need to be added to the <code class="language-plaintext highlighter-rouge">rvm</code> group.  This can be easily done with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm::system_user { bturner: ; jdoe: ; jsmith: ; }
</code></pre></div></div>

<p>If GPG is installed, installing RVM requires the RVM GPG key.
This module will install the key if <code class="language-plaintext highlighter-rouge">gpg</code> is already installed or being installed with the
<a href="https://forge.puppetlabs.com/golja/gnupg"><code class="language-plaintext highlighter-rouge">golja-gnupg</code></a> module.</p>

<p>If you don’t want this module to install the gpg key just set to false the <code class="language-plaintext highlighter-rouge">gpg_key_id</code> parameter</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class { '::rvm': gnupg_key_id =&gt; false }
</code></pre></div></div>

<h2 id="installing-ruby">Installing Ruby</h2>

<p>You can tell RVM to install one or more Ruby versions with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm_system_ruby {
  'ruby-1.9':
    ensure      =&gt; 'present',
    default_use =&gt; true,
    build_opts  =&gt; ['--binary'];
  'ruby-2.0':
    ensure      =&gt; 'present',
    default_use =&gt; false;
}
</code></pre></div></div>

<p>You should use the full version number.  While the shorthand version may work (e.g. ‘1.9.2’), the provider will be unable to detect if the correct version is installed.</p>

<p>If rvm fails to install binary rubies you can increase curl’s timeout with the <code class="language-plaintext highlighter-rouge">rvm_max_time_flag</code> in <code class="language-plaintext highlighter-rouge">~/.rvmrc</code> with a fully qualified path to the home directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ensure rvm doesn't timeout finding binary rubies
# the umask line is the default content when installing rvm if file does not exist
file { '/home/user/rvmrc':
  content =&gt; 'umask u=rwx,g=rwx,o=rx
              export rvm_max_time_flag=20',
  mode    =&gt; '0664',
  before  =&gt; Class['rvm'],
}
</code></pre></div></div>

<p>Or, to configure <code class="language-plaintext highlighter-rouge">/etc/rvmrc</code> you can use use <code class="language-plaintext highlighter-rouge">Class['rvm::rvmrc]</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class{ 'rvm::rvmrc':
  max_time_flag =&gt; 20,
  before  =&gt; Class['rvm'],
}
</code></pre></div></div>

<h3 id="installing-jruby-from-sources">Installing JRuby from sources</h3>

<p>JRuby has some extra requirements, java, maven and ant that you can install using
<a href="http://forge.puppetlabs.com/puppetlabs/java">puppetlabs/java</a>,
<a href="http://forge.puppetlabs.com/maestrodev/ant">maestrodev/ant</a> and
<a href="http://forge.puppetlabs.com/maestrodev/maven">maestrodev/maven</a> modules.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class { 'java': } -&gt;
class { 'ant': } -&gt;
class { 'maven::maven': } -&gt;
rvm_system_ruby { 'jruby-1.7.6':
  ensure      =&gt; 'present',
  default_use =&gt; false;
}
</code></pre></div></div>

<h2 id="creating-gemsets">Creating Gemsets</h2>

<p>Create a gemset with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm_gemset {
  'ruby-1.9.3-p448@myproject':
    ensure  =&gt; present,
    require =&gt; Rvm_system_ruby['ruby-1.9.3-p448'];
}
</code></pre></div></div>

<h2 id="installing-gems">Installing Gems</h2>

<p>Install a gem with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm_gem {
  'ruby-1.9.3-p448@myproject/bundler':
    ensure  =&gt; '1.0.21',
    require =&gt; Rvm_gemset['ruby-1.9.3-p448@myproject'];
}
</code></pre></div></div>

<p>The <em>name</em> of the gem should be <code class="language-plaintext highlighter-rouge">&lt;ruby-version&gt;[@&lt;gemset&gt;]/&lt;gemname&gt;</code>.  For example, you can install bundler for ruby-1.9.2 using <code class="language-plaintext highlighter-rouge">ruby-1.9.3-p448/bundler</code>.  You could install rails in your project’s gemset with: <code class="language-plaintext highlighter-rouge">ruby-1.9.3-p448@myproject/rails</code>.</p>

<p>Alternatively, you can use this more verbose syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm_gem {
  'bundler':
    name         =&gt; 'bundler',
    ruby_version =&gt; 'ruby-1.9.3-p448',
    ensure       =&gt; latest,
    require      =&gt; Rvm_system_ruby['ruby-1.9.3-p448'];
}
</code></pre></div></div>

<h2 id="creating-aliases">Creating Aliases</h2>

<p>To create an RVM alias, you can use:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm_alias {
  'myproject':
    target_ruby =&gt; 'ruby-1.9.3-p448@myproject',
    ensure      =&gt; present,
    require     =&gt; Rvm_gemset['ruby-1.9.3-p448@myproject'];
}
</code></pre></div></div>

<h2 id="creating-wrappers">Creating Wrappers</h2>

<p>To create an RVM wrapper, you can use:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm_wrapper {
  'god':
    target_ruby =&gt; 'ruby-1.9.3-p448',
    prefix      =&gt; 'bootup',
    ensure      =&gt; present,
    require     =&gt; Rvm_system_ruby['ruby-1.9.3-p448'];
}
</code></pre></div></div>

<h2 id="installing-passenger">Installing Passenger</h2>

<p>NOTE: You must install the <a href="http://forge.puppetlabs.com/puppetlabs/apache">puppetlabs/apache</a> module by yourself.
It is not included as a dependency to this module to avoid installing it when is not needed most times.</p>

<p>Install passenger using the <a href="http://forge.puppetlabs.com/puppetlabs/apache">puppetlabs/apache</a> module,
and using:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class { 'apache': }
class { 'rvm::passenger::apache':
    version            =&gt; '3.0.11',
    ruby_version       =&gt; 'ruby-1.9.3-p448',
    mininstances       =&gt; '3',
    maxinstancesperapp =&gt; '0',
    maxpoolsize        =&gt; '30',
    spawnmethod        =&gt; 'smart-lv2',
}
</code></pre></div></div>

<h2 id="using-hiera">Using Hiera</h2>

<p>You can configure the ruby versions to be installed and the system users from hiera</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm::system_rubies:
  'ruby-1.9':
    default_use: true
  'ruby-2.0': {}
  'jruby-1.7': {}

rvm::system_users:
  - john
  - doe

rvm::rvm_gems:
  'bundler':
    name: 'bundler'
    ruby_version: 'ruby-1.9'
    ensure: latest
</code></pre></div></div>

<h2 id="building-the-module">Building the module</h2>

<p>Testing is done with rspec, <a href="https://github.com/puppetlabs/beaker-rspec">Beaker-rspec</a>, <a href="https://github.com/puppetlabs/beaker">Beaker</a>)</p>

<p>To test and build the module</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle install
# run specs
rake

# run Beaker system tests with vagrant vms
rake beaker
# to use other vm from the list spec/acceptance/nodesets and not destroy the vm after the tests
BEAKER_destroy=no BEAKER_set=centos-64-x64 bundle exec rake beaker

# Release the Puppet module to the Forge, doing a clean, build, tag, push, bump_commit and git push
rake module:release
</code></pre></div></div>

<h2 id="troubleshooting--faq">Troubleshooting / FAQ</h2>

<h3 id="an-error-could-not-find-a-default-provider-for-rvm_system_ruby-is-displayed-when-running-puppet-with-noop">An error “Could not find a default provider for rvm_system_ruby” is displayed when running Puppet with –noop</h3>

<p>This means that puppet cannot find the <code class="language-plaintext highlighter-rouge">/usr/local/rvm/bin/rvm</code> command
(probably because RVM isn’t installed yet).  Currently, Puppet does not support
making a provider suitable using another resource (late-binding).  You may want
to use run stages to install RVM before the rest of the
configuration runs.  When running in <em>noop</em> mode, RVM is not actually installed
causing rvm_system_ruby, rvm_gem and rvm_gemset resources to generate this
error.  You can avoid this error by surrounding your rvm configuration in an if
block:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if $rvm_installed == "true" {
    rvm_system_ruby ...
}
</code></pre></div></div>

<p>Do not surround <code class="language-plaintext highlighter-rouge">include rvm</code> in the if block, as this is used to install RVM.</p>

<p>NOTE: $rvm_installed is evaluated at the beginning of each puppet run.  If you
use this in your manifests, you will need to run puppet twice to fully
configure RVM.</p>

<h3 id="an-error-resource-type-rvm_gem-does-not-support-parameter-false-prevents-puppet-from-running">An error “Resource type rvm_gem does not support parameter false” prevents puppet from running.</h3>

<p>The RVM module requires Puppet version 2.6.7 or higher.</p>

<p>There is a bug in Puppet versions 2.7.4 through 2.7.9 that also causes this
error.  The error can be safely ignored in these versions.  For best results,
upgrade to Puppet 2.7.10.</p>

<h3 id="some-packageslibraries-i-dont-want-or-need-are-installed-eg-build-essential-libc6-dev-libxml2-dev">Some packages/libraries I don’t want or need are installed (e.g. build-essential, libc6-dev, libxml2-dev).</h3>

<p>RVM works by compiling Ruby from source.  This means you must have all the libraries and binaries required to compile Ruby installed on your system, which is handled by rvm autolibs in newer versions of RVM.</p>

<h3 id="it-doesnt-work-on-my-operating-system">It doesn’t work on my operating system.</h3>

<p>Check the rspec-system tests as described above to test in a specific OS
If that doesn’t work feel free to send a pull request ;)</p>

<h3 id="why-didnt-you-just-add-an-rvm-provider-for-the-existing-package-type">Why didn’t you just add an RVM provider for the existing package type?</h3>

<p>The puppet <a href="http://docs.puppetlabs.com/references/latest/type.html#package">package</a>
type seems like an obvious place for the RVM provider.  It would be nice if the syntax
for installing Ruby with RVM looked like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># NOTE: This does not work
package {'ruby':
    provider =&gt; 'rvm',
    ensure =&gt; '1.9.2-p290';
}
</code></pre></div></div>

<p>While this may be possible, it becomes harder to manage multiple Ruby versions and
nearly impossible to install gems for a specific Ruby version.  For this reason,
I decided it was best to create a completely new set of types for RVM.</p>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
