<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Composer Puppet Module | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Composer Puppet Module" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<meta property="og:description" content="Записная книжка рассеянного [в пространстве и времени] программиста" />
<link rel="canonical" href="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/composer/" />
<meta property="og:url" content="http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/composer/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Composer Puppet Module" />
<script type="application/ld+json">
{"url":"http://localhost:4000/src/tdd_series/tdd_yii2_app/puphpet/puppet/modules/composer/","description":"Записная книжка рассеянного [в пространстве и времени] программиста","headline":"Composer Puppet Module","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Composer Puppet Module</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="composer-puppet-module">Composer Puppet Module</h1>

<p><a href="https://travis-ci.org/tPl0ch/puppet-composer"><img src="https://travis-ci.org/tPl0ch/puppet-composer.png?branch=master" alt="Build Status" /></a></p>

<h2 id="maintainers-needed">Maintainers needed!</h2>

<p>See https://github.com/tPl0ch/puppet-composer/issues/84 for more details!</p>

<h2 id="description">Description</h2>

<p>The <code class="language-plaintext highlighter-rouge">puppet-composer</code> module installs the latest version of Composer from http://getcomposer.org. Composer is a dependency manager for PHP.</p>

<h2 id="supported-puppet-versions">Supported Puppet versions</h2>

<p>This module supports puppet in versions <code class="language-plaintext highlighter-rouge">&gt;= 2.7, &lt;3.5</code></p>

<h2 id="supported-platforms">Supported Platforms</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Debian</code></li>
  <li><code class="language-plaintext highlighter-rouge">Ubuntu</code></li>
  <li><code class="language-plaintext highlighter-rouge">Redhat</code></li>
  <li><code class="language-plaintext highlighter-rouge">Centos</code></li>
  <li><code class="language-plaintext highlighter-rouge">Amazon Linux</code></li>
  <li><code class="language-plaintext highlighter-rouge">FreeBSD</code></li>
</ul>

<h2 id="installation">Installation</h2>

<h4 id="puppet-forge">Puppet Forge</h4>
<p>We recommend installing using the Puppet Forge as it automatically satisfies dependencies.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puppet module install --target-dir=/your/path/to/modules tPl0ch-composer
</code></pre></div></div>

<h4 id="installation-via-git-submodule">Installation via git submodule</h4>
<p>You can also install as a git submodule and handle the dependencies manually. See the <a href="#dependencies">Dependencies</a> section below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git submodule add git://github.com/tPl0ch/puppet-composer.git modules/composer
</code></pre></div></div>

<h2 id="dependencies">Dependencies</h2>

<p>This module requires the following Puppet modules:</p>

<ul>
  <li><a href="https://github.com/puppetlabs/puppetlabs-git/"><code class="language-plaintext highlighter-rouge">puppetlabs-git</code></a></li>
</ul>

<p>And additional (for puppet version lower than 3.0.0) you need:</p>

<ul>
  <li><a href="http://augeas.net/"><code class="language-plaintext highlighter-rouge">libaugeas</code></a> (For automatically updating php.ini settings for suhosin patch)</li>
  <li><a href="http://docs.puppetlabs.com/hiera/1/installing.html#step-2-install-the-puppet-functions"><code class="language-plaintext highlighter-rouge">hiera-puppet</code></a> (For managing config data)</li>
</ul>

<h2 id="usage">Usage</h2>
<p>To install the <code class="language-plaintext highlighter-rouge">composer</code> binary globally in <code class="language-plaintext highlighter-rouge">/usr/local/bin</code> you only need to declare the <code class="language-plaintext highlighter-rouge">composer</code> class. We try to set some sane defaults. There are also a number of parameters you can tweak should the defaults not be sufficient.</p>

<h3 id="simple-include">Simple Include</h3>
<p>To install the binary with the defaults you just need to include the following in your manifests:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include composer
</code></pre></div></div>

<h3 id="full-include">Full Include</h3>
<p>Alternatively, you can set a number of options by declaring the class with parameters:</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="p">{</span> <span class="s1">'composer'</span><span class="p">:</span>
    <span class="py">target_dir</span>      <span class="p">=&gt;</span> <span class="s1">'/usr/local/bin'</span><span class="p">,</span>
    <span class="py">composer_file</span>   <span class="p">=&gt;</span> <span class="s1">'composer'</span><span class="p">,</span> <span class="c"># could also be 'composer.phar'
</span>    <span class="py">download_method</span> <span class="p">=&gt;</span> <span class="s1">'curl'</span><span class="p">,</span>     <span class="c"># or 'wget'
</span>    <span class="py">logoutput</span>       <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="py">tmp_path</span>        <span class="p">=&gt;</span> <span class="s1">'/tmp'</span><span class="p">,</span>
    <span class="py">php_package</span>     <span class="p">=&gt;</span> <span class="s1">'php5-cli'</span><span class="p">,</span>
    <span class="py">curl_package</span>    <span class="p">=&gt;</span> <span class="s1">'curl'</span><span class="p">,</span>
    <span class="py">wget_package</span>    <span class="p">=&gt;</span> <span class="s1">'wget'</span><span class="p">,</span>
    <span class="py">composer_home</span>   <span class="p">=&gt;</span> <span class="s1">'/root'</span><span class="p">,</span>
    <span class="py">php_bin</span>         <span class="p">=&gt;</span> <span class="s1">'php'</span><span class="p">,</span> <span class="c"># could also i.e. be 'php -d "apc.enable_cli=0"' for more fine grained control
</span>    <span class="py">suhosin_enabled</span> <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="py">auto_update</span>     <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Set to true to automatically update composer to the latest version
</span>    <span class="py">github_token</span>    <span class="p">=&gt;</span> <span class="s1">'1234567890abcdefgh'</span><span class="p">,</span>
    <span class="py">user</span>            <span class="p">=&gt;</span> <span class="s1">'app'</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="creating-projects">Creating Projects</h3>

<p>The <code class="language-plaintext highlighter-rouge">composer::project</code> definition provides a way to create projects in a target directory.</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">composer::project</span> <span class="p">{</span> <span class="s1">'silex'</span><span class="p">:</span>
    <span class="py">project_name</span>   <span class="p">=&gt;</span> <span class="s1">'fabpot/silex-skeleton'</span><span class="p">,</span>  <span class="c"># REQUIRED
</span>    <span class="py">target_dir</span>     <span class="p">=&gt;</span> <span class="s1">'/vagrant/silex'</span><span class="p">,</span> <span class="c"># REQUIRED
</span>    <span class="py">version</span>        <span class="p">=&gt;</span> <span class="s1">'2.1.x-dev'</span><span class="p">,</span> <span class="c"># Some valid version string
</span>    <span class="py">prefer_source</span>  <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="py">stability</span>      <span class="p">=&gt;</span> <span class="s1">'dev'</span><span class="p">,</span> <span class="c"># Minimum stability setting
</span>    <span class="py">keep_vcs</span>       <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Keep the VCS information
</span>    <span class="py">dev</span>            <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span> <span class="c"># Install dev dependencies
</span>    <span class="py">repository_url</span> <span class="p">=&gt;</span> <span class="s1">'http://repo.example.com'</span><span class="p">,</span> <span class="c"># Custom repository URL
</span>    <span class="py">user</span>           <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># Set the user to run as
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="updating-packages">Updating Packages</h3>

<p>The <code class="language-plaintext highlighter-rouge">composer::exec</code> definition provides a more generic wrapper arround composer <code class="language-plaintext highlighter-rouge">update</code> and <code class="language-plaintext highlighter-rouge">install</code> commands. The following example will update the <code class="language-plaintext highlighter-rouge">silex/silex</code> and <code class="language-plaintext highlighter-rouge">symfony/browser-kit</code> packages in the <code class="language-plaintext highlighter-rouge">/vagrant/silex</code> directory. You can omit <code class="language-plaintext highlighter-rouge">packages</code> to update the entire project.</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">composer::exec</span> <span class="p">{</span> <span class="s1">'silex-update'</span><span class="p">:</span>
    <span class="py">cmd</span>                  <span class="p">=&gt;</span> <span class="s1">'update'</span><span class="p">,</span>  <span class="c"># REQUIRED
</span>    <span class="py">cwd</span>                  <span class="p">=&gt;</span> <span class="s1">'/vagrant/silex'</span><span class="p">,</span> <span class="c"># REQUIRED
</span>    <span class="py">packages</span>             <span class="p">=&gt;</span> <span class="p">[</span><span class="s1">'silex/silex'</span><span class="p">,</span> <span class="s1">'symfony/browser-kit'</span><span class="p">],</span> <span class="c"># leave empty or omit to update whole project
</span>    <span class="py">prefer_source</span>        <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Only one of prefer_source or prefer_dist can be true
</span>    <span class="py">prefer_dist</span>          <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Only one of prefer_source or prefer_dist can be true
</span>    <span class="py">dry_run</span>              <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Just simulate actions
</span>    <span class="py">custom_installers</span>    <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># No custom installers
</span>    <span class="py">scripts</span>              <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># No script execution
</span>    <span class="py">ignore_platform_reqs</span> <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Ignore platform requirements
</span>    <span class="py">interaction</span>          <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># No interactive questions
</span>    <span class="py">optimize</span>             <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Optimize autoloader
</span>    <span class="py">dev</span>                  <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span> <span class="c"># Install dev dependencies
</span>    <span class="py">timeout</span>              <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># Set a timeout for the exec type
</span>    <span class="py">user</span>                 <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># Set the user to run as
</span>    <span class="py">refreshonly</span>          <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Only run on refresh
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="installing-packages">Installing Packages</h3>

<p>We support the <code class="language-plaintext highlighter-rouge">install</code> command in addition to <code class="language-plaintext highlighter-rouge">update</code>. The install command will ignore the <code class="language-plaintext highlighter-rouge">packages</code> parameter and the following example is the equivalent to running <code class="language-plaintext highlighter-rouge">composer install</code> in the <code class="language-plaintext highlighter-rouge">/vagrant/silex</code> directory.</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">composer::exec</span> <span class="p">{</span> <span class="s1">'silex-install'</span><span class="p">:</span>
    <span class="py">cmd</span>                  <span class="p">=&gt;</span> <span class="s1">'install'</span><span class="p">,</span>  <span class="c"># REQUIRED
</span>    <span class="py">cwd</span>                  <span class="p">=&gt;</span> <span class="s1">'/vagrant/silex'</span><span class="p">,</span> <span class="c"># REQUIRED
</span>    <span class="py">prefer_source</span>        <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="py">prefer_dist</span>          <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="py">dry_run</span>              <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Just simulate actions
</span>    <span class="py">custom_installers</span>    <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># No custom installers
</span>    <span class="py">scripts</span>              <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># No script execution
</span>    <span class="py">ignore_platform_reqs</span> <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Ignore platform requirements
</span>    <span class="py">interaction</span>          <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># No interactive questions
</span>    <span class="py">optimize</span>             <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Optimize autoloader
</span>    <span class="py">dev</span>                  <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span> <span class="c"># Install dev dependencies
</span>    <span class="py">onlyif</span>               <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># If true
</span>    <span class="py">unless</span>               <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># If true
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="updating-composer">Updating composer</h3>

<p>You can use the defined type <code class="language-plaintext highlighter-rouge">composer::selfupdate</code> to update (or rollback) composer to the latest (or specific) version.</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">composer::selfupdate</span> <span class="p">{</span> <span class="s1">'selfupdate_composer'</span><span class="p">:</span>
  <span class="py">version</span>       <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># Leave undef for latest version, otherwise specify commit hash here
</span>  <span class="py">rollback</span>      <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Set to true to rollback to a specified version (version MUST be given)
</span>  <span class="py">clean_backups</span> <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># Set to true to clean backups
</span>  <span class="py">user</span>          <span class="p">=&gt;</span> <span class="kc">undef</span><span class="p">,</span> <span class="c"># If the command should be run as a user
</span>  <span class="py">logoutput</span>     <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="c"># If the command's output should be written to the logs
</span>  <span class="py">timeout</span>       <span class="p">=&gt;</span> <span class="m">300</span><span class="p">,</span>   <span class="c"># Timeout for this command
</span>  <span class="py">tries</span>         <span class="p">=&gt;</span> <span class="m">3</span><span class="p">,</span>     <span class="c"># Retries for this command
</span><span class="p">}</span>
</code></pre></div></div>

<h2 id="development">Development</h2>

<p>For unit testing we use <code class="language-plaintext highlighter-rouge">rspec-puppet</code> and Travis CI. Functional testing happens through a Vagrant VM where you can test changes in a real server scenario.</p>

<h3 id="unit-tests">Unit Tests</h3>

<p>When contributing fixes or features you should try and create RSpec tests for those changes. It is always a good idea to make sure the entire suite passes before opening a pull request. To run the RSpec tests locally you need <code class="language-plaintext highlighter-rouge">bundler</code> installed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem install bundler
</code></pre></div></div>

<p>Then you can install the required gems:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle install
</code></pre></div></div>

<p>Finally, the tests can be run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake spec
</code></pre></div></div>

<h3 id="functional-tests">Functional Tests</h3>

<p>For easier development and actual testing the use of the module, we rely on Vagrant, which allows us to bring up a VM that we can use to test changes and perform active development without needing a real server.</p>

<p>To get started with the Vagrant VM you should first get the <a href="#unit-tests">Unit Tests</a> working. Then you will need to install <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> and <a href="http://vagrantup.com/">Vagrant</a>.</p>

<p>To bring up the development VM you can run <code class="language-plaintext highlighter-rouge">rake vagrant:up</code>. This Rake task runs <code class="language-plaintext highlighter-rouge">rake spec_prep</code> as a pre-requisite so that the <code class="language-plaintext highlighter-rouge">git</code> Puppet module is available. With the VM up and running you can login via SSH with <code class="language-plaintext highlighter-rouge">vagrant ssh</code> and run <code class="language-plaintext highlighter-rouge">puppet apply</code> against it with <code class="language-plaintext highlighter-rouge">rake vagrant:provision</code>.</p>

<p>The VM will get the <code class="language-plaintext highlighter-rouge">spec/fixtures/manifests/vagrant.pp</code> file applied to the node. This currently creates a Silex project at <code class="language-plaintext highlighter-rouge">/tmp/silex</code> when the VM starts up. You can modify this manifest to your liking.</p>

<h3 id="acceptance-tests">Acceptance Tests</h3>

<p>Acceptance tests are written using <a href="https://github.com/puppetlabs/beaker/wiki">Beaker</a>.</p>

<p>To run the beaker tests via rake, you can simply run <code class="language-plaintext highlighter-rouge">rake beaker</code>.</p>

<p>To use something other than the default beaker node, try the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BEAKER_set=ubuntu-server-1404-x64 rake beaker
</code></pre></div></div>

<p>To use beaker without rake, simply run <code class="language-plaintext highlighter-rouge">rspec spec/acceptance</code>.</p>

<p><strong>Beaker + Hiera</strong></p>

<p>When running acceptance tests, you may hit GitHub rate limits much faster than you would otherwise. To ensure your tests do not fail arbitrarily, you can add your GitHub auth token via hiera.</p>

<p>Create a hiera config at <code class="language-plaintext highlighter-rouge">spec/fixtures/puppet/common.yaml</code>, that looks like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">composer::github_token: 'my_github_auth_token'</span>
</code></pre></div></div>

<p>Happy testing!</p>

<h2 id="contributing">Contributing</h2>

<p>We welcome everyone to help develop this module. To contribute:</p>

<ul>
  <li>Fork this repository</li>
  <li>Add features and spec tests for them</li>
  <li>Commit to feature named branch</li>
  <li>Open a pull request outlining your changes and the reasoning for them</li>
</ul>

<h2 id="todo">Todo</h2>

<ul>
  <li>Add a <code class="language-plaintext highlighter-rouge">composer::require</code> type</li>
</ul>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
