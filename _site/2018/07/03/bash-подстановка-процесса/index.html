<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Bash: подстановка процесса | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Bash: подстановка процесса" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="В статье рассматривается механизм командной оболочки linux “подстановка процессов”. Этот функционал позволяет минимизировать использование именованных каналов для связи между командами или процессами." />
<meta property="og:description" content="В статье рассматривается механизм командной оболочки linux “подстановка процессов”. Этот функционал позволяет минимизировать использование именованных каналов для связи между командами или процессами." />
<link rel="canonical" href="http://localhost:4000/2018/07/03/bash-%D0%BF%D0%BE%D0%B4%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%B0/" />
<meta property="og:url" content="http://localhost:4000/2018/07/03/bash-%D0%BF%D0%BE%D0%B4%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%B0/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-03T23:20:52+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bash: подстановка процесса" />
<script type="application/ld+json">
{"headline":"Bash: подстановка процесса","dateModified":"2018-07-03T23:20:52+03:00","datePublished":"2018-07-03T23:20:52+03:00","description":"В статье рассматривается механизм командной оболочки linux “подстановка процессов”. Этот функционал позволяет минимизировать использование именованных каналов для связи между командами или процессами.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/07/03/bash-%D0%BF%D0%BE%D0%B4%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%B0/"},"@type":"BlogPosting","url":"http://localhost:4000/2018/07/03/bash-%D0%BF%D0%BE%D0%B4%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%B0/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Bash: подстановка процесса</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Bash: подстановка процесса</h1>
<p>03 Jul 2018</p>

<p><img src="/assets/images/2018/07/2018-07-03-221415_267x133.png" alt="2018-07-03-22:14:15_267x133" />Рассмотрим достаточно полезную штуку в консоли линукса (bash) как подстановка процесса.</p>

<p>Вообще подстановок в баше достаточно <a href="http://rus-linux.net/nlib.php?name=/MyLDP/BOOKS/Bash-Guide-1.12-ru/bash-guide-03-4.html">много</a> всяких подстановок: результата выполнения команды  арифметических операций, имен файлов, значений переменных и, конечно же, процессов.</p>

<p>Применима подстановка в первую очередь для того, чтобы избавиться от создания <a href="http://russianpenguin.ru/2014/05/10/linux-%d0%b8%d0%bc%d0%b5%d0%bd%d0%be%d0%b2%d0%b0%d0%bd%d0%bd%d1%8b%d0%b5-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d1%8b/">пайпов</a>.А во вторую - для сохранения внешнего контекста при работе подпроцесса.</p>

<h2 id="избавляемся-от-пайпов">Избавляемся от пайпов</h2>

<p>Имеем две команды, которые формируют некоторый список значений и мы хотим сделать diff или любую другую операцию, которая принимает на вход в качестве аргументов имена файлов.</p>

<!--more-->

<p>Начнем с простого примера: хотим сравнить выводы двух команд.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sleep</span> <span class="k">$((</span>RANDOM%2<span class="k">))</span> <span class="o">&amp;&amp;</span> curl <span class="nt">-v</span> <span class="nt">--silent</span> https://google.com | <span class="nb">grep date</span>
</code></pre></div></div>

<p>На месте этой абсурдной команды может быть что угодно: обработка логов, данные телеметрии с сервера и т.п.</p>

<p>Как сделать diff? Два варианта: перенаправить выводы обеих команд в пайпы и использовать подстановку процессов в форме чтения вывода команды.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\&lt;(command)
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% <span class="nb">mkfifo </span>f1  
<span class="nv">$ </span><span class="nb">mkfifo </span>f2  
<span class="nv">$ </span><span class="nb">sleep</span> <span class="k">$((</span>RANDOM%2<span class="k">))</span> <span class="o">&amp;&amp;</span> curl <span class="nt">-v</span> <span class="nt">--silent</span> https://google.com | <span class="nb">grep date</span> <span class="se">\&gt;</span> f1 &amp;  
<span class="nv">$ </span><span class="nb">sleep</span> <span class="k">$((</span>RANDOM%2<span class="k">))</span> <span class="o">&amp;&amp;</span> curl <span class="nt">-v</span> <span class="nt">--silent</span> https://google.com | <span class="nb">grep date</span> <span class="se">\&gt;</span> f2 &amp;  
<span class="nv">$ </span>diff f1 f2  
<span class="nv">$ </span><span class="nb">rm </span>f1 f2
</code></pre></div></div>

<p>Либо более лаконично.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>diff <span class="se">\&lt;</span><span class="o">(</span><span class="nb">sleep</span> <span class="k">$((</span>RANDOM%2<span class="k">))</span> <span class="o">&amp;&amp;</span> curl <span class="nt">-v</span> <span class="nt">--silent</span> https://google.com | <span class="nb">grep date</span><span class="o">)</span> <span class="se">\&lt;</span><span class="o">(</span><span class="nb">sleep</span> <span class="k">$((</span>RANDOM%2<span class="k">))</span> <span class="o">&amp;&amp;</span> curl <span class="nt">-v</span> <span class="nt">--silent</span> https://google.com | <span class="nb">grep date</span><span class="o">)</span>
</code></pre></div></div>

<p>Согласитесь, что второй вариант проще в создании. так как оболочка сама позаботилась о создании и удалении каналов. Другая форма использования перенаправить некоторый stdin на вход другой команды или цепочки команд.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\&gt;(command)
</code></pre></div></div>

<p>Допустим мы хотим записывать логи подключения разных групп устройств из udevadm в разные файлы. Можно запустить два процесса, но зачем?</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>udevadm monitor | <span class="nb">tee</span> <span class="se">\&gt;</span><span class="o">(</span><span class="nb">grep </span>card <span class="se">\&gt;</span> card.log<span class="o">)</span> <span class="se">\&gt;</span><span class="o">(</span><span class="nb">grep </span>usb <span class="se">\&gt;</span> usb.log<span class="o">)</span>
</code></pre></div></div>

<p>Тут не стоит забывать, что множественное перенаправление данных позволительно сделать при помощи tee, который берез stdin и пишет его во все указанные в качестве аргументов файлы.</p>

<h2 id="сохранение-контекста">Сохранение контекста</h2>

<p>Подпроцесс - это одно из ключевых понятий bash и других оболочек.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">export </span><span class="nv">foo</span><span class="o">=</span>baz  
<span class="nv">$ </span>perl <span class="nt">-e</span> <span class="s1">'system "echo foo is \$foo"; $ENV{"foo"}="bar"; system "echo foo is \$foo"'</span>  
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$foo</span><span class="s2">"</span>
</code></pre></div></div>

<p>Perl запускается как дочерний процесс, родителем которого выступает bash (в нашем случае). Для данного процесса создается новый контекст, в который копируются переменные окружения и модификация контекста процесса не приводит к изменению контекста родителя.</p>

<p>Это приводит к тому, что модификация контекста внутри цепочки команд не отражается на глобальных переменных.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash  </span>
<span class="nv">i</span><span class="o">=</span>0  
<span class="nb">sort test</span> | <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do  
 </span><span class="nv">i</span><span class="o">=</span><span class="k">$((</span><span class="nv">$i</span><span class="o">+</span><span class="m">1</span><span class="k">))</span>  
 <span class="nb">echo</span> <span class="nv">$i</span>  
<span class="k">done  
</span><span class="nb">echo</span> <span class="nv">$i</span>
</code></pre></div></div>

<p>В данном скрипте цикл while запускается как дочерний процесс, а следовательно у нас всегда будет выводиться 0. Хотя внутри самого цикла мы видим инкремент переменной.</p>

<p>Исправить ситуацию можно при помощи подстановки команд.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash  </span>
<span class="nv">i</span><span class="o">=</span>0  
<span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do  
 </span><span class="nv">i</span><span class="o">=</span><span class="k">$((</span><span class="nv">$i</span><span class="o">+</span><span class="m">1</span><span class="k">))</span>  
 <span class="nb">echo</span> <span class="nv">$i</span>  
<span class="k">done</span> <span class="se">\&lt;</span> <span class="se">\&lt;</span><span class="o">(</span><span class="nb">sort test</span><span class="o">)</span>  
<span class="nb">echo</span> <span class="nv">$i</span>
</code></pre></div></div>

<h2 id="литература">Литература</h2>

<ul>
  <li><a href="http://rus-linux.net/nlib.php?name=/MyLDP/BOOKS/Bash-Guide-1.12-ru/bash-guide-03-4.html">Подстановки, выполняемые командной оболочкой</a></li>
  <li><a href="http://mywiki.wooledge.org/ProcessSubstitution">Process Substitution</a></li>
  <li><a href="http://mywiki.wooledge.org/SubShell">SubShell</a></li>
</ul>

<p> </p>




      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
