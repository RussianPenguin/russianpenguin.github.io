<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Fedora: сборка пакетов из src.rpm | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Fedora: сборка пакетов из src.rpm" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Разбираемся, что это за пакеты src.rpm и как поставить софт из исходников." />
<meta property="og:description" content="Разбираемся, что это за пакеты src.rpm и как поставить софт из исходников." />
<link rel="canonical" href="http://localhost:4000/2018/05/19/fedora-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8%D0%B7-src-rpm/" />
<meta property="og:url" content="http://localhost:4000/2018/05/19/fedora-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8%D0%B7-src-rpm/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-19T14:44:23+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fedora: сборка пакетов из src.rpm" />
<script type="application/ld+json">
{"headline":"Fedora: сборка пакетов из src.rpm","dateModified":"2018-05-19T14:44:23+03:00","datePublished":"2018-05-19T14:44:23+03:00","description":"Разбираемся, что это за пакеты src.rpm и как поставить софт из исходников.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/05/19/fedora-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8%D0%B7-src-rpm/"},"@type":"BlogPosting","url":"http://localhost:4000/2018/05/19/fedora-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B8%D0%B7-src-rpm/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=eacdde9998fcd3dd17b1956e7070eca69fdaf217">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Fedora: сборка пакетов из src.rpm</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Fedora: сборка пакетов из src.rpm</h1>
<p>19 May 2018</p>

<p><img src="/assets/images/2018/05/2018-05-19-123539_1076x631.png?w=150" alt="2018-05-19-12:35:39_1076x631" />Чаще всего то не требуется обычному пользователю. Но бывает ситуации, когда пакет собран с поддержкой библиотеки исключенной из дистрибутива.</p>

<p>Недавно это случилось с chromium в centos, а с драйверами от epson случается постоянно.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>imagescan-bundle-fedora-27-1.3.23.x64.rpm/  
<span class="nv">$ </span>./install.sh  
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> пароль для penguin:  
Последняя проверка окончания срока действия метаданных: 2:53:00 назад, Сб 19 мая 2018 09:42:23.  
Ошибка:  
 Проблема 1: conflicting requests  
 - nothing provides libboost<span class="se">\_</span>filesystem.so.1.64.0<span class="o">()(</span>64bit<span class="o">)</span> needed by imagescan-3.33.0-1epson4fedora27.x86<span class="se">\_</span>64  
 Проблема 2: package imagescan-plugin-networkscan-1.1.1-1epson4fedora27.x86<span class="se">\_</span>64 requires imagescan <span class="se">\&gt;</span><span class="o">=</span> 3.9.0, but none of the providers can be installed  
 - conflicting requests  
 - nothing provides libboost<span class="se">\_</span>filesystem.so.1.64.0<span class="o">()(</span>64bit<span class="o">)</span> needed by imagescan-3.33.0-1epson4fedora27.x86<span class="se">\_</span>64  
 Проблема 3: package imagescan-plugin-gt-s650-1.0.0-1epson4fedora27.x86<span class="se">\_</span>64 requires imagescan <span class="se">\&gt;</span><span class="o">=</span> 3.28.0, but none of the providers can be installed  
 - conflicting requests  
 - nothing provides libboost<span class="se">\_</span>filesystem.so.1.64.0<span class="o">()(</span>64bit<span class="o">)</span> needed by imagescan-3.33.0-1epson4fedora27.x86<span class="se">\_</span>64  
 Проблема 4: package imagescan-plugin-ocr-engine-1.0.0-1epson4fedora27.x86<span class="se">\_</span>64 requires imagescan <span class="se">\&gt;</span><span class="o">=</span> 3.14.0, but none of the providers can be installed  
 - conflicting requests  
 - nothing provides libboost<span class="se">\_</span>filesystem.so.1.64.0<span class="o">()(</span>64bit<span class="o">)</span> needed by imagescan-3.33.0-1epson4fedora27.x86<span class="se">\_</span>64
</code></pre></div></div>

<p>А еще это может потребоваться если мы хотим поставить пакет, который распространяется только в src.rpm.</p>

<!--more-->

<h2 id="устанавливаем-тулчейн-для-сборки">Устанавливаем тулчейн для сборки</h2>

<p>Нам потребуется группа пакетов для сборки RPM</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf group <span class="nb">install</span> <span class="s2">"RPM Development Tools"</span>
</code></pre></div></div>

<h2 id="подготавливаем-окружение">Подготавливаем окружение</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rpmdev-setuptree
</code></pre></div></div>

<p>Команда подготовит необходимую структуру папок в домашнем каталого.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/penguin/rpmbuild/  
├── BUILD  
├── BUILDROOT  
├── RPMS  
├── SOURCES  
├── SPECS  
└── SRPMS
</code></pre></div></div>

<h2 id="достаем-пакет-с-исходниками">Достаем пакет с исходниками</h2>

<p>Вы же видели репозитарии source (например <em>russianfedora-nonfree-updates-testing-source</em>. Все эти репозитарии откючены в конфиге и включать их нет необходимости потому что пакеты из них обычным способом поставить нельзя.</p>

<p>Установка src.rpm осуществляется под аккаунтом пользователя и производится в каталог rpmbuild, который был подготовлен выше.</p>

<p>Сначала пакет нужно скачать (либо руками, либо из репозитария). В случае репозитария это делается через dnf.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dnf download <span class="nt">--source</span> xmoto
</code></pre></div></div>

<h2 id="установка-зависимостей">Установка зависимостей</h2>

<p>Для сборки многим пакетам требуются заголовочые файлы или библиотеки для линковки, которые принадлежат другим пакетам. Все зависимости описываются в самом файле с исходниками и для их установки нужно только вызвать команду builddep.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf builddep package.src.rpm
</code></pre></div></div>

<h2 id="установка-исходников">Установка исходников</h2>

<p>Теперь пакет нужно поставить (не забываем, что все операции выполняются под аккаунтом текущего пользователя, а не рута).</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rpm <span class="nt">-ivh</span> imagescan-3.33.0-1epson4fedora27.src.rpm
</code></pre></div></div>

<h2 id="сборка">Сборка</h2>

<p>Для сборки следует проверить, что спецификация нужного  пакета появилась в каталоге ~/rpmbuild/SPECS и собрать его при помоощи rpmbuild. Сначала используем опцию -bp, которая выполнит подготовку к сборке и тем самым мы сможем убедиться (хотя бы теоретически), что тулчейн заработал и это вообще можно собрать. И тольео после того, как все прошло удачно заюзаем -ba или -bb.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/rpmbuild  
<span class="nv">$ </span>rpmbuild <span class="nt">-bp</span> SPECS/imagescan.spec
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rpmbuild <span class="nt">-bp</span> SPECS/imagescan.spec  
ошибка: uversion undefined, define to match <span class="nb">source </span>archive  
ошибка: строка 2: %<span class="o">{!</span>?uversion: %<span class="o">{</span>error: uversion undefined, define to match <span class="nb">source </span>archive<span class="o">}}</span>
</code></pre></div></div>

<p>В случае imagescan весь процесс происходит очень болезненно. Поэтому я пропущу детали поиска решения и лишь покажу процесс.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rpmbuild <span class="nt">-bp</span> <span class="nt">--define</span> <span class="s2">"uversion 0.33.0"</span> SPECS/imagescan.spec
</code></pre></div></div>

<p>Дополнительная опция –define позволяет определять и переопределять макросы, которые будут использоваться тулчейном.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/include/gtk-2.0/gtk/gtkstatusicon.h:76:8: error: unnecessary parentheses in declaration of '\_\_gtk\_reserved1' [-Werror=parentheses]  
void (\*\_\_gtk\_reserved1);  
^  
/usr/include/gtk-2.0/gtk/gtkstatusicon.h:77:8: error: unnecessary parentheses in declaration of '\_\_gtk\_reserved2' [-Werror=parentheses]  
void (\*\_\_gtk\_reserved2);  
^  
cc1plus: all warnings being treated as errors  
make[2]: \*\*\* [Makefile:573: dialog.lo] Error 1  
make[2]: Leaving directory '/home/penguin/rpmbuild/BUILD/utsushi-0.33.0/gtkmm'  
make[1]: \*\*\* [Makefile:604: all-recursive] Error 1  
make[1]: Leaving directory '/home/penguin/rpmbuild/BUILD/utsushi-0.33.0'  
make: \*\*\* [Makefile:511: all] Error 2  
ошибка: Неверный код возврата из /var/tmp/rpm-tmp.hKyez0 (%build)
</code></pre></div></div>

<p>Таких ошибок встретится превеликое множество из-за довольно старых исходников, которые не адаптированы под свежий стандарт c++. Решением будет установка целой группы флагов через глобальную переменную CXXFLAGS.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CXXFLAGS</span><span class="o">=</span><span class="s2">"-fPIC -Wno-parentheses -Wno-sizeof-pointer-div"</span> rpmbuild <span class="nt">-bb</span> <span class="nt">--define</span> <span class="s2">"uversion 0.33.0"</span> <span class="nt">--define</span> <span class="s2">"debug</span><span class="se">\_</span><span class="s2">package %{nil}"</span> SPECS/imagescan.spec
</code></pre></div></div>

<p>Флаг debug_package добавлен из-за того, что попытка сборки пакета debugpackage приподит к ошибке из-за отсутствия нужных определений в файле спецификации.</p>

<h2 id="установка-пакета">Установка пакета</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&amp;</span>nbsp<span class="p">;</span><span class="nb">sudo </span>dnf <span class="nb">install </span>RPMS/x86<span class="se">\_</span>64/imagescan-3.33.0-1.fc28.x86<span class="se">\_</span>64.rpm
</code></pre></div></div>

<h2 id="литература">Литература</h2>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[Re: Disabling warning: suggest parentheses around &amp;&amp; within</td>
          <td> </td>
          <td>](https://gcc.gnu.org/ml/gcc-help/2009-05/msg00118.html)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li><a href="http://ftp.rpm.org/api/4.4.2.2/conditionalbuilds.html">Passing conditional parameters into a rpm build</a></li>
  <li><a href="https://www.g-loaded.eu/2009/04/24/manually-prepare-the-rpm-building-environment/">Manually Prepare the RPM Building Environment</a></li>
  <li><a href="https://ask.fedoraproject.org/en/question/87205/how-do-i-install-a-src-rpm-with-dnf/">How do I install a src rpm with dnf?</a></li>
  <li><a href="http://knoppix.ru/adv090703.shtml">Установка софта из “сырых” RPM</a></li>
  <li><a href="https://gcc.gnu.org/onlinedocs/gcc-4.8.2/gcc/Warning-Options.html">3.8 Options to Request or Suppress Warnings</a></li>
  <li><a href="https://stackoverflow.com/questions/36983051/rpmbuild-how-to-skip-generation-of-debuginfo-packages-without-change-spec-fi">rpmbuild: how to skip generation of “debuginfo” packages (without change SPEC file ; neither .rpmmacros)</a></li>
</ul>

<p> </p>




      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
