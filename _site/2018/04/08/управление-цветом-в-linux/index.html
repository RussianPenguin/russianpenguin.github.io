<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="yandex-verification" content="551ffc5ae1433df6" />
    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Управление цветом в Linux | Чтобы не забыть</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Управление цветом в Linux" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Не секрет, что для качественной печати на цветных принтерах необходимо выполнить множество действий по установке цветовых профилей. В статье рассматривается как происходит назначение профилей icc/icm различным устройствам графического ввода-вывода в nix-подобных операционных системах." />
<meta property="og:description" content="Не секрет, что для качественной печати на цветных принтерах необходимо выполнить множество действий по установке цветовых профилей. В статье рассматривается как происходит назначение профилей icc/icm различным устройствам графического ввода-вывода в nix-подобных операционных системах." />
<link rel="canonical" href="http://localhost:4000/2018/04/08/%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%86%D0%B2%D0%B5%D1%82%D0%BE%D0%BC-%D0%B2-linux/" />
<meta property="og:url" content="http://localhost:4000/2018/04/08/%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%86%D0%B2%D0%B5%D1%82%D0%BE%D0%BC-%D0%B2-linux/" />
<meta property="og:site_name" content="Чтобы не забыть" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-08T22:20:24+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Управление цветом в Linux" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2018/04/08/%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%86%D0%B2%D0%B5%D1%82%D0%BE%D0%BC-%D0%B2-linux/","description":"Не секрет, что для качественной печати на цветных принтерах необходимо выполнить множество действий по установке цветовых профилей. В статье рассматривается как происходит назначение профилей icc/icm различным устройствам графического ввода-вывода в nix-подобных операционных системах.","headline":"Управление цветом в Linux","dateModified":"2018-04-08T22:20:24+03:00","datePublished":"2018-04-08T22:20:24+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/04/08/%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%86%D0%B2%D0%B5%D1%82%D0%BE%D0%BC-%D0%B2-linux/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=d85e6f1917405784d52928d499ab3e51b4bffcc9">
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">Управление цветом в Linux</h1>
      <h2 class="project-tagline">Записная книжка рассеянного [в пространстве и времени] программиста</h2>
      
        <a href="https://github.com/RussianPenguin/russianpenguin.github.io" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1>Управление цветом в Linux</h1>
<p>08 Apr 2018</p>

<p><img src="/assets/images/2018/04/01-intro.jpg?w=131" alt="01-intro" />Есть такая штука под названием “уветовые профили”. Казалось бы все о них слышали, но немногие умеют их использовать и понимают, зачем это вообще надо.</p>

<p>То, что мы воспринимаем как свет - это лишь электромагнитные колебания с длиной волны от 380-400 нм до 760-780 нм. В этом диапазоне смешались все цвета от красного к филетовому.</p>

<p>[caption id=”attachment_2412” align=”alignnone” width=”787”] <img src="/assets/images/2018/04/02-spectrum.png" alt="02-spectrum" /> <a href="https://ru.wikipedia.org/wiki/%D0%A1%D0%B2%D0%B5%D1%82">https://ru.wikipedia.org/wiki/Свет</a>[/caption]</p>

<p>Когда мы видим радугу, то мы видим весь спектр цветов. А вот несовершенные электронные приборы могут отобразить лишь определенные цвета радуги. Называется это цветовым охватом - множество доступных для восприятия человеческим глазом цветов, которые способно воспроизвести устройство. У всей техники разные диаграммы цветопередачи.</p>

<p>Именно поэтому для каждого устройства в системе нужно задать цветовой профиль, который как раз и описывает диапазон цветового охвата.</p>

<p>Почему это важно? Можно пояснить на примере двух инженеров у одного из которых линейка метрическая, а у второго дюймовая. Если один другому скажет, что нужно начертить линию длиной два, то случится нечто странное: линия будет иметь длину два, но в той системе измерений, в которой работает человек.</p>

<p>То же самое с техникой. Если для нас цвето RGB(200, 0, 0) - это красный с каким-то уровнем насыщенности, то для принтера он может быть совершенно другим. Поэтому перед печатью все должно быть сконвертировано с учетом цветового профили устройства.</p>

<p>Подводя итог: цветовой профиль - это правила конвертации цвета из общепризнанной цветовой модели в ту, с которой работает ваша техника.</p>

<p>Когда мы просто печатаем текст на компьютере, то нас не сильно волнует, как это се конвертируется, но когда при печати фотографии мы получим цвета, которых на экране не видели, то пора что-то менять. :)</p>

<!--more-->

<h2 id="управление-цветом">Управление цветом.</h2>

<h3 id="предварительная-настройка">Предварительная настройка</h3>

<p><strong>Описываемые ниже шаги рассказывают о том,как реализованы подобные настройки на нижнем уровне. Если вы используете DE, в которых есть механизмы управления мониторами, то нижеописанные действия по настройке вам не нужны.</strong></p>

<p>Всю работу по настройке связки устройство-профиль в никсах берет на себя демон <a href="https://www.freedesktop.org/software/colord/intro.html">colord</a>. Именно он управляет базой данных цветовых профилей.</p>

<p>Будем рассматривать как это работает на примере Fedora GNU/Linux.</p>

<p>Если демона нет в списке юнитов, то его надо поставить и добавить в список автоматически-запускаемых (В большинстве сборок федоры все уже сделано до вас и эти шаги не требуются).</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>colord colord-libs  
<span class="nv">$ </span><span class="nb">sudo </span>systemctl <span class="nb">enable </span>colord  
<span class="nv">$ </span><span class="nb">sudo </span>systemctl start colord
</code></pre></div></div>

<p>Проверим, что сервис установлен.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl list-units
</code></pre></div></div>

<p>Для gnome и kde все уже сделано и в панели управления есть подраздел управления цветовыми профилями, но для lxde (xmonad, i3, etc.) нужно добавить менеджер управления цветом ибо встроенных средств у этих средств нету.</p>

<p>Единственным на сегодня механизмом является демон <a href="https://github.com/agalakhov/xiccd" title="github: alakhov/xiccd">xiccd</a>. Компилить его из исходников нет надобности - можно поставить через <a href="https://copr.fedorainfracloud.org/coprs/dschubert/xiccd/" title="Fedora Corp: dschubert/xiccd">corp</a>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf copr <span class="nb">enable </span>dschubert/xiccd  
<span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>xiccd
</code></pre></div></div>

<p>После установки нужно перезайти в систему (софт прописывается в автостарт автоматически), либо запустить xiccd руками.</p>

<p>Проверить правильность работы можно командой</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colormgr get-devices
</code></pre></div></div>

<p>Если все хорошо, то среди устройств должен быть ваш монитор.</p>

<p>Можно посмотреть переменную _ICC_PROFILE (именно она хранит интересующие нас данные).</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>xprop <span class="nt">-display</span> :0.0 <span class="nt">-len</span> 14 <span class="nt">-root</span> <span class="se">\_</span>ICC<span class="se">\_</span>PROFILE
</code></pre></div></div>

<p>Вывод будет выглядить как-то так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\_ICC\_PROFILE(CARDINAL) = 0, 0, 2, 252, 108, 99, 109, 115, 4, 48, 0, 0, 109, 110  

</code></pre></div></div>

<p>У иксов есть <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=851810" title="xcalib: Error - unsupported ramp size 0">баг</a>, который не позволяет устанавливать профили монитора для интеловских видеокарт,</p>

<p>Решается принудительным прописыванием информации о драйвере в конфиг иксов /etc/X11/xorg.conf.d/20-intel.conf.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Section "Device"  
 Identifier "Intel Graphics"  
 Driver "intel"  
EndSection
</code></pre></div></div>

<p>Если этого не сделать, то при попытке применить профиль к монитору мы получим сообщение об ошибке.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ xcalib -d :0 ~/.local/share/icc/S273HL.ICM  
Error - unsupported ramp size 0
</code></pre></div></div>

<h3 id="мониторы">Монитор(ы)</h3>

<p>Для удобства нам потребуется поставить систему управления agryllcms - в ней есть удобная команда dispwin.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>agryllcms<span class="se">\*</span>
</code></pre></div></div>

<p>Не будем затрагивать процесс калибровки - это тема хорошо расписана в <a href="https://wiki.archlinux.org/index.php/ICC_profiles" title="ICC profiles">вики</a> арча.</p>

<p>В первую очередь нужно добыть цветовые профили для своих мониторов и принтеров (и сканеров). Их можно скачать на сайте производителя или найти в интернете на сайтах подобных <a href="http://www.tftcentral.co.uk/articles/icc_profiles.htm#the_database" title="tftcentral">tftcentral</a>.</p>

<p>Для добавления файла в базу вводим простую команду импорта.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colormgr import-profile file.icc
</code></pre></div></div>

<p>Если все прошло хорошо, то команда выдаст нам несколько строк, среди которых будет Profile ID. Её нужно запомнить так как именно по этому идентификатору мы будем ассоциировать файл с оборудованием.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile ID: icc-7b1f4835daffceb605fd8378367c1200
</code></pre></div></div>

<p>Повторяем так для каждого скачанного профиля. Все они будет импортированы в каталог ~/.local/share/icc.</p>

<p>Теперь нужно найти монитор при помощи команды</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colormgr get-devices
</code></pre></div></div>

<p>На экране будет отображен список устройств и нам нужно запомнить параметр device id для каждого монитора.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Device ID: xrandr-Acer Technologies-S273HL-LQA0C0028000
</code></pre></div></div>

<p>Ассоциирование устройства и профиля выполняется командой</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colormgr device-add-profile <span class="s2">"device</span><span class="se">\_</span><span class="s2">id"</span> <span class="s2">"profile</span><span class="se">\_</span><span class="s2">id"</span>
</code></pre></div></div>

<p>А установка профиля по-умолчанию</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colormgr device-make-profile-default <span class="s2">"device</span><span class="se">\_</span><span class="s2">id"</span> <span class="s2">"profile</span><span class="se">\_</span><span class="s2">id"</span>
</code></pre></div></div>

<p>Применить профиль без перезагрузки машины можно командой</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dispwin -d 
</code></pre></div></div>

<p>Номер монитора можно узнать в справке dispwin.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dispwin -h  
...  
 -d n[,m] Choose the display n from the following list (default 1)  
 Optionally choose different display m for Video LUT access  
 1 = 'Screen 1, Output eDP1 at 0, 1080, width 1920, height 1080'  
 2 = 'Screen 2, Output HDMI1 at 0, 0, width 1920, height 1080'  
...
</code></pre></div></div>

<p>Важно отметить, что далеко не все профили от производителей идут с заполненными lut-таблицами (это таблицы кривых rgb, который загружаются в память видиокарты).</p>

<p>Если таблицы нет, что при попытке применить профиль мы увидим сообщение</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dispwin: Warning - No vcgt tag found in profile - assuming linear
</code></pre></div></div>

<p>Это есть настройки гаммы, которую всегда можно осуществить вручную.</p>

<p>С мониторами разобрались. При следующей загрузке будут применены корректные профили.</p>

<h3 id="принтеры">Принтер(ы)</h3>

<p>С принтерами все несколько сложнее. Не все поддерживают демон настроек colord. Gutenprint поддерживает :). От него и будем отталкиваться (да и большинство hp при растеризации используют цветовые профили).</p>

<p>Как вообще это происходит: изображение отправляется на печать, а cups выполняет растеризацию и преобразование изображения в нужное цветовое пространство (настройки самого пространства берутся из colord).</p>

<p>И тут кроется один нюанс. Выполним просмотр доступных профилей при помощи colormgr.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ colormgr get-profiles  
...  
System Wide: No  
...
</code></pre></div></div>

<p>У всех мы видим строку с характеристикой system wide. Настройки принтера обязаны быть system wide иначе он просто откажется работать.</p>

<p>А для этого нам нужно положить все icc\icm в /usr/share/color/icc/ (можно и нужно создать подкаталог, например printerProfiles). А затем на все дать права чтения и установить владельца root.</p>

<p>После этого ничего работать не будет. А в логах мы найде сообщения об ошибке.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>]: true .putdeviceprops --nostringval-- unknownerror  
]: Operand stack:  
]: Unrecoverable error: undefined in .putdeviceprops  
]: | ./base/gsicc\_manage.c:1799: gsicc\_set\_device\_profile(): cannot find device profile  
]: ./base/gsicc\_manage.c:1148: gsicc\_open\_search(): Could not find /usr/share/color/icc/user/XP600-premium-glossy-water-based.icc
</code></pre></div></div>

<p>Но при этом файл будет лежать по указанному пути. Все дело в контексте SeLinux. Посмотрим внимательнее на содержимое каталога.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lZ</span>  
итого 456  
drwxr-xr-x. 2 root root system<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0 4096 апр 7 23:17 basICColor  
drwxr-xr-x. 2 root root system<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0 4096 апр 7 23:10 colord  
drwxr-xr-x. 2 root root system<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0 4096 апр 7 23:17 lcms  
drwxr-xr-x. 2 root root system<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0 4096 апр 7 23:17 OpenICC  
drwxr-xr-x. 2 root root system<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0 4096 апр 7 23:17 Oyranos  
drwxr-xr-x. 2 root root unconfined<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0 4096 апр 7 23:53 user  
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root unconfined<span class="se">\_</span>u:object<span class="se">\_</span>r:user<span class="se">\_</span>home<span class="se">\_</span>t:s0 441740 дек 4 11:31 XP330.icm
</code></pre></div></div>

<p>Было добавлен файл XP330.icm. Мы видим, что контекст файла сильно отличается от того, что у всех остальных. Это и есть причина, по которой cups (а конкретно gutenprint) не может открыть профиль.</p>

<p>Поправим это при помощи restorecon.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>restorecon <span class="nt">-Rv</span> <span class="nb">.</span>  
Relabeled /usr/share/color/icc/XP330.icm from unconfined<span class="se">\_</span>u:object<span class="se">\_</span>r:user<span class="se">\_</span>home<span class="se">\_</span>t:s0 to unconfined<span class="se">\_</span>u:object<span class="se">\_</span>r:usr<span class="se">\_</span>t:s0
</code></pre></div></div>

<p>Поправили и теперь нужно перезагрузить colord.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl restart colord
</code></pre></div></div>

<p>Выполнив команду colormgr get-profiles мы увидим среди всех зарегистрированнх icc нащ, который положили выше. И у него будет установлен признак system wide, что и требовалось.</p>

<p>В выводе устройств colormgr get-devices находим наш принтер, связываем его и icc.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colormgr device-add-profile <span class="s2">"device</span><span class="se">\_</span><span class="s2">id"</span> <span class="s2">"profile</span><span class="se">\_</span><span class="s2">id"</span>  
<span class="nv">$ </span>colormgr device-make-profile-default <span class="s2">"device</span><span class="se">\_</span><span class="s2">id"</span> <span class="s2">"profile</span><span class="se">\_</span><span class="s2">id"</span>
</code></pre></div></div>

<p>Можно печатать.</p>

<h2 id="литература">Литература</h2>

<ul>
  <li><a href="https://www.freedesktop.org/software/colord/intro.html">https://www.freedesktop.org/software/colord/intro.html</a></li>
  <li><a href="https://ru.wikipedia.org/wiki/Свет">https://ru.wikipedia.org/wiki/Свет</a></li>
  <li><a href="https://ru.wikipedia.org/wiki/Цветовая_модель">https://ru.wikipedia.org/wiki/Цветовая_модель</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/ICC_profiles">https://wiki.archlinux.org/index.php/ICC_profiles</a></li>
</ul>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/RussianPenguin/russianpenguin.github.io">russianpenguin.github.io</a> is maintained by <a href="https://github.com/RussianPenguin">RussianPenguin</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(69889387, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/69889387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </body>
</html>
